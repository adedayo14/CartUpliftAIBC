"use strict";(()=>{(function(){"use strict";const x="v1.2.0",L=new Date().toISOString();if(typeof window<"u"){if((!window.CART_UPLIFT_BUNDLE_VERSION||window.CART_UPLIFT_BUNDLE_VERSION!==x)&&(window.CART_UPLIFT_BUNDLE_VERSION=x,console.log("[CartUplift Bundles]",x,"loaded at",L)),window.CartUpliftBundlesInitialized)return;window.CartUpliftBundlesInitialized=!0,window.CartUpliftBundlesLoaded=!0}const B={JPY:0,KRW:0,VND:0,CLP:0,XOF:0,XAF:0,KMF:0,PYG:0,BIF:0,RWF:0,GNF:0,UGX:0,VUV:0,HUF:0,IQD:0,BHD:3,JOD:3,KWD:3,OMR:3,TND:3},N="USD",O=2,T="cart_session_id";function $(){try{if(typeof sessionStorage>"u")return`sess_${Date.now()}_${Math.random().toString(36).slice(2)}`;let E=sessionStorage.getItem(T);return E||(E=`sess_${Date.now()}_${Math.random().toString(36).slice(2)}`,sessionStorage.setItem(T,E)),E}catch{return`sess_${Date.now()}_${Math.random().toString(36).slice(2)}`}}const A=typeof window<"u"&&window.localStorage?.getItem("CART_UPLIFT_DEBUG")==="true",_={log:(...E)=>A&&console.log("[CartUplift Bundles]",...E),info:(...E)=>A&&console.info("[CartUplift Bundles]",...E),warn:(...E)=>console.warn("[CartUplift Bundles]",...E),error:(...E)=>console.error("[CartUplift Bundles]",...E)};function V(E){try{const t=new Intl.NumberFormat("en",{style:"currency",currency:E}).resolvedOptions();if(typeof t.minimumFractionDigits=="number")return t.minimumFractionDigits}catch{}return B[E]!==void 0?B[E]:O}function M(){return typeof window<"u"&&window.Shopify&&window.Shopify.currency&&window.Shopify.currency.active||N}function q(E,e,t){const n=typeof E=="number"&&!isNaN(E)&&isFinite(E)?Math.round(E):0;try{if(window.Shopify&&typeof window.Shopify.formatMoney=="function"){const s=window.Shopify.money_format||window.Shopify.currency?.format;if(s){let a=window.Shopify.formatMoney(n,s);return n%100===0&&(a=a.replace(/\.00$/,"").replace(/,00$/,"")),a}let r=window.Shopify.formatMoney(n);return n%100===0&&(r=r.replace(/\.00$/,"").replace(/,00$/,"")),r}}catch{}try{const s=typeof document<"u"&&document.documentElement&&document.documentElement.lang||typeof navigator<"u"&&navigator.language||"en-US",r=new Intl.NumberFormat(s,{style:"currency",currency:e||N,minimumFractionDigits:t,maximumFractionDigits:t}),a=Math.pow(10,t);return r.format((n||0)/a)}catch{const r=Math.pow(10,t),i=((n||0)/r).toFixed(t).split(".");return i[0]=i[0].replace(/\B(?=(\d{3})+(?!\d))/g,","),i.join(".")}}class k{constructor(){this.bundles=[],this.currency=M(),this.currentProductId=null,this.init()}async init(){document.readyState==="loading"&&await new Promise(n=>{document.addEventListener("DOMContentLoaded",n)});const e=document.querySelectorAll("[data-bundle-widget]");if(e.length===0)return;const t=e[0];if(this.currentProductId=t.dataset.productId,!this.currentProductId){e.forEach(n=>n.style.display="none");return}await this.loadBundles(),e.forEach((n,s)=>{this.bundles.length>0?this.renderBundlesInWidget(n,s):n.style.display="none"})}async loadBundles(){try{const e=Date.now(),t=`/apps/cart-uplift/api/bundles?product_id=${this.currentProductId}&_t=${e}`,n=await fetch(t,{method:"GET",headers:{Accept:"application/json","Cache-Control":"no-cache"}});if(!n.ok)return;const s=await n.json();s.success&&s.bundles&&(this.bundles=s.bundles,this.currency=s.currency||this.currency||"USD")}catch(e){console.error("Error loading bundles:",e)}}renderBundlesInWidget(e,t){const n=e.dataset.bundleTitle,s=e.dataset.bundleSubtitle,r=e.dataset.headingAlign||"left",a=parseInt(e.dataset.bundlePriority)||5;e._bundleTitle=n,e._bundleSubtitle=s,e._headingAlign=r,[...this.bundles].sort((d,l)=>{const m=d.priority||a||5,h=l.priority||a||5;return m-h}).forEach((d,l)=>{const m=d.source||d.type||"manual";if(d.hideIfNoML&&(m!=="ai"||!Array.isArray(d.products)||d.products.length===0))return;new U(e,d,l,this.currency).init()})}}class U{constructor(e,t,n,s=N){this.containerElement=e,this.config=t,this.index=n,this.currencyCode=M()||(s&&String(s).trim()&&s!==N?String(s).trim():null)||N,this.currencyMinorUnits=V(this.currencyCode),this.element=null,this.selectedProducts=[];const r=t.products||[],a=new Set;this.products=r.filter(h=>{const g=h.variant_id||h.variantId||h.id;return a.has(g)?!1:(a.add(g),!0)}),this.selectedQuantityTier=null,this.productQuantities={},this.inlineStyleObservers=[],this.canDeselect=t.allowDeselect!==!1,this.minProducts=Number(t.minProducts)||0,this.minBundlePrice=Number(t.minBundlePrice)||0,this.bundleSource=t.source||t.type||"manual";const i=e.dataset.bundleBgColor,d=e.dataset.contentAlignment,l=e.dataset.savingsColor,m=e.dataset.showSavings;this.backgroundColor=i||t.backgroundColor||null,this.savingsColor=l||t.savingsColor||null,this.showSavingsBadge=m!==void 0?m==="true"||m===!0:t.showSavingsBadge!==!1}init(){this.createElement(),this.render(),this.trackEvent("view")}formatVariantLabel(e){let t=(e.title||"").trim();return(!t||/default title/i.test(t))&&(Array.isArray(e.selectedOptions)&&e.selectedOptions.length>0?e.selectedOptions.length>1?t=e.selectedOptions.map(s=>s&&typeof s=="object"&&s.name&&s.value?`${s.name}: ${s.value}`:s?.value||s).filter(Boolean).join(", "):t=e.selectedOptions.map(s=>s?.value||s).filter(Boolean).join(" / "):Array.isArray(e.options)&&e.options.length>0?t=e.options.join(" / "):e.option1||e.option2||e.option3?t=[e.option1,e.option2,e.option3].filter(Boolean).join(" / "):t="Variant"),t}registerInlineStyleGuard(e){if(!e||typeof MutationObserver>"u")return;if(e.dataset&&e.dataset.gridNoInline==="true"){e.removeAttribute("style");return}const t=()=>{e.hasAttribute("style")&&e.removeAttribute("style")};t();const n=new MutationObserver(s=>{for(const r of s)r.attributeName==="style"&&t()});n.observe(e,{attributes:!0,attributeFilter:["style"]}),this.inlineStyleObservers.push(n),e.dataset&&(e.dataset.gridNoInline="true")}createElement(){this.element=document.createElement("div"),this.element.className="cartuplift-bundle",this.element.dataset.bundleId=this.config.id,this.backgroundColor&&(this.element.style.backgroundColor=this.backgroundColor,this.element.style.padding="var(--cu-spacing-xxl)",this.element.style.borderRadius="var(--cu-radius-md)");const e=this.config.bundleStyle||"grid";(e==="clean"||e==="fbt")&&this.element.classList.add("cartuplift-bundle-horizontal"),e==="tier"&&this.element.classList.add("tier-bundle");const t=this.containerElement._bundleTitle,n=this.containerElement._bundleSubtitle,s=this.containerElement._headingAlign||"left";if(t){const r=document.createElement("h2");r.className="cartuplift-bundles-heading",r.style.textAlign=s,r.textContent=t,this.element.appendChild(r)}if(n){const r=document.createElement("p");r.className="cartuplift-bundles-subtitle",r.style.textAlign=s,r.textContent=n,this.element.appendChild(r)}this.container=document.createElement("div"),this.container.className="cartuplift-bundle-products",this.element.appendChild(this.container),this.footer=document.createElement("div"),this.footer.className="cartuplift-bundle-footer",this.element.appendChild(this.footer),this.containerElement.appendChild(this.element)}render(){if(this.products.length===0&&this.config.bundleStyle!=="tier"){this.container.innerHTML='<p style="color: #999; text-align: center; padding: 20px;">No products available.</p>';return}const t=this.containerElement.dataset.displayStyle||this.config.bundleStyle||"grid";switch(t){case"clean":case"fbt":this.renderCleanHorizontal();break;case"grid":this.renderGridCheckboxes();break;case"list":this.renderCompactList();break;case"detailed":case"carousel":this.renderGridCheckboxes();break;case"tier":this.renderQuantityTier();break;default:this.renderGridCheckboxes()}t!=="clean"&&t!=="fbt"&&this.renderFooter()}renderCleanHorizontal(){const e=document.createElement("div");e.className="cartuplift-bundle-clean",this.renderDesktopHorizontalView(e),this.renderMobileCollapsedView(e),this.container.appendChild(e)}renderDesktopHorizontalView(e){const t=document.createElement("div");t.className="bundle-products-wrapper",this.selectedProducts=this.products.map((i,d)=>({...i,index:d,quantity:1})),this.products.forEach((i,d)=>{const l=document.createElement("div");l.className="cartuplift-clean-item",l.dataset.index=d;const m=document.createElement("input");if(m.type="checkbox",m.checked=!0,m.className="product-checkbox",this.canToggleProduct(i)||(m.disabled=!0),m.addEventListener("change",u=>{if(!this.canToggleProduct(i)){u.target.checked=!0;return}u.target.checked?this.selectedProducts.find(p=>p.index===d)||this.selectedProducts.push({...i,index:d,quantity:1}):this.selectedProducts=this.selectedProducts.filter(p=>p.index!==d),this.updateHorizontalSummary()}),l.appendChild(m),i.image){const u=document.createElement("a");u.href=i.handle?`/products/${i.handle}`:`/products/${i.id}`,u.target="_blank",u.rel="noopener noreferrer";const p=document.createElement("img");p.src=i.image,p.alt=i.title,p.loading="lazy",u.appendChild(p),l.appendChild(u)}const h=document.createElement("h4"),g=document.createElement("a");g.href=i.handle?`/products/${i.handle}`:`/products/${i.id}`,g.target="_blank",d===0?g.innerHTML="<strong>This item:</strong> "+i.title:g.textContent=i.title,h.appendChild(g),l.appendChild(h);const o=i.rating||i.stars||i.review_rating||null,y=i.reviewCount||i.reviews||i.reviews_count||i.review_count||i.total_reviews||null;if(o||y){if(o){const u=document.createElement("div");u.className="clean-stars";const p=isNaN(Number(o))?5:Number(o);u.textContent="\u2605".repeat(Math.max(0,Math.min(5,Math.floor(p)))),l.appendChild(u)}if(y){const u=document.createElement("div");u.className="clean-reviews",u.textContent=`(${y} Reviews)`,l.appendChild(u)}}const f=this.createPriceElement(i);if(l.appendChild(f),Array.isArray(i.variants)&&i.variants.length>0){let u=this.getActiveVariantId(i);const p=i.variants.find(v=>String(v?.id)===String(u))||i.variants[0];p&&(u=p.id,i.variant_id=p.id);let C=i.variants.length>1;if(!C&&i.variants.length===1){const v=i.variants[0],P=v.title&&v.title.toLowerCase()!=="default title",c=Array.isArray(v.selectedOptions)&&v.selectedOptions.length>0&&v.selectedOptions.some(b=>b&&b.name&&b.name.toLowerCase()!=="title"&&b.value&&b.value.toLowerCase()!=="default title");P&&c&&(C=!0)}if(C){const v=document.createElement("select");v.className="clean-variant-selector",i.variants.forEach(P=>{if(!P||!P.id)return;const c=document.createElement("option");c.value=String(P.id),c.textContent=this.formatVariantLabel(P),String(u)===String(P.id)&&(c.selected=!0),v.appendChild(c)}),v.addEventListener("change",P=>{const c=P.target.value;this.handleVariantChange(i,d,c,f);const b=i.variants.find(w=>String(w.id)===String(c));b&&this.updatePriceElement(f,b),this.updateHorizontalSummary()}),l.appendChild(v)}}if(l.addEventListener("click",u=>{u.target!==m&&u.target.tagName!=="A"&&(m.checked=!m.checked,m.dispatchEvent(new Event("change")))}),t.appendChild(l),d<this.products.length-1){const u=document.createElement("span");u.className="cartuplift-bundle-plus",u.textContent="+",t.appendChild(u)}});const n=document.createElement("div");n.className="bundle-summary";const s=document.createElement("div");s.className="bundle-total";const r=document.createElement("p");r.className="total-label",r.textContent="Total price:",s.appendChild(r),this.totalPriceElement=document.createElement("p"),this.totalPriceElement.className="bundle-total-price",this.updateHorizontalTotal(),s.appendChild(this.totalPriceElement),n.appendChild(s);const a=document.createElement("div");a.className="bundle-button-container",this.addButton=document.createElement("button"),this.addButton.className="add-bundle-btn",this.updateHorizontalButtonText(),this.addButton.addEventListener("click",()=>{this.trackEvent("click"),this.addBundleToCart()}),a.appendChild(this.addButton),n.appendChild(a),e.appendChild(t),e.appendChild(n)}renderMobileCollapsedView(e){this.selectedProducts=this.products.map((l,m)=>({...l,index:m,quantity:1}));const t=document.createElement("div");t.className="bundle-mobile-collapsed";const n=document.createElement("div");n.className="bundle-mobile-images",this.products.forEach((l,m)=>{if(l.image){const h=document.createElement("a");h.href=l.url||`/products/${l.handle||l.id}`,h.target="_blank",h.rel="noopener noreferrer";const g=document.createElement("img");g.src=l.image,g.alt=l.title,g.loading="lazy",h.appendChild(g),n.appendChild(h)}if(m<this.products.length-1){const h=document.createElement("span");h.className="mobile-plus",h.textContent="+",n.appendChild(h)}}),t.appendChild(n);const s=document.createElement("button");s.className="bundle-mobile-pill";const{originalPrice:r,discountedPrice:a,savings:i}=this.calculatePrices(),d=this.selectedProducts.length;i>0?s.innerHTML=`
          <span class="pill-content">
            <span class="pill-label">Buy all ${d}:</span>
            <span class="pill-prices">
              <span class="pill-price-sale">${this.formatPrice(a)}</span>
              <span class="pill-price-original">${this.formatPrice(r)}</span>
            </span>
          </span>
          <span class="pill-arrow">\u203A</span>
        `:s.innerHTML=`
          <span class="pill-content">
            <span class="pill-label">Buy all ${d}:</span>
            <span class="pill-price-sale">${this.formatPrice(a)}</span>
          </span>
          <span class="pill-arrow">\u203A</span>
        `,s.addEventListener("click",()=>this.openMobileModal()),t.appendChild(s),e.appendChild(t),this.createMobileModal()}createMobileModal(){this.modalOverlay=document.createElement("div"),this.modalOverlay.className="bundle-modal-overlay",this.modalOverlay.addEventListener("click",()=>this.closeMobileModal()),this.modal=document.createElement("div"),this.modal.className="bundle-modal",this.modal.addEventListener("click",a=>a.stopPropagation());const e=document.createElement("div");e.className="bundle-modal-header";const t=document.createElement("h3");t.textContent="Frequently bought together",e.appendChild(t);const n=document.createElement("button");n.className="bundle-modal-close",n.innerHTML="\u2715",n.addEventListener("click",()=>this.closeMobileModal()),e.appendChild(n),this.modal.appendChild(e);const s=document.createElement("div");s.className="bundle-modal-body",this.products.forEach((a,i)=>{const d=document.createElement("div");d.className="bundle-modal-item";const l=document.createElement("input");if(l.type="checkbox",l.checked=!0,l.className="modal-checkbox",l.dataset.index=i,this.canToggleProduct(a)||(l.disabled=!0),l.addEventListener("change",o=>{if(!this.canToggleProduct(a)){o.target.checked=!0;return}o.target.checked?this.selectedProducts.find(y=>y.index===i)||this.selectedProducts.push({...a,index:i,quantity:1}):this.selectedProducts=this.selectedProducts.filter(y=>y.index!==i),this.updateModalTotal()}),d.appendChild(l),a.image){const o=document.createElement("img");o.src=a.image,o.alt=a.title,d.appendChild(o)}const m=document.createElement("div");m.className="modal-item-info";const h=document.createElement("p");h.className="modal-item-title",i===0?h.innerHTML="<strong>This item:</strong> "+a.title:h.textContent=a.title,m.appendChild(h);const g=document.createElement("p");if(g.className="modal-item-price",g.textContent=this.formatPrice(a.price),m.appendChild(g),a.variants&&a.variants.length>0){const o=this.selectedProducts.find(f=>f.index===i)?.variantId||a.variants[0]?.id||a.variantId;let y=a.variants.length>1;if(!y&&a.variants.length===1){const f=a.variants[0];Array.isArray(f.selectedOptions)&&f.selectedOptions.length>0&&f.selectedOptions.some(p=>p&&p.value&&!/default/i.test(p.value))&&(y=!0)}if(y){const f=document.createElement("select");f.className="modal-variant-selector",a.variants.forEach(u=>{if(!u||!u.id)return;const p=document.createElement("option");p.value=String(u.id),p.textContent=this.formatVariantLabel(u),String(o)===String(u.id)&&(p.selected=!0),f.appendChild(p)}),f.addEventListener("change",u=>{const p=u.target.value,C=a.variants.find(P=>String(P.id)===String(p)),v=this.selectedProducts.find(P=>P.index===i);v&&C&&(v.variantId=C.id,v.price=C.price,g.textContent=this.formatPrice(C.price),this.updateModalTotal())}),m.appendChild(f)}}d.appendChild(m),s.appendChild(d)}),this.modal.appendChild(s);const r=document.createElement("div");if(r.className="bundle-modal-footer",this.modalTotalElement=document.createElement("p"),this.modalTotalElement.className="modal-total",this.updateModalTotal(),r.appendChild(this.modalTotalElement),this.modalAddButton=document.createElement("button"),this.modalAddButton.className="modal-add-button",this.updateModalButtonText(),this.modalAddButton.addEventListener("click",()=>{this.closeMobileModal(),this.addBundleToCart()}),r.appendChild(this.modalAddButton),this.config.displayInfo){const a=document.createElement("p");a.className="modal-info",a.innerHTML=`<span class="info-icon">\u24D8</span> ${this.config.displayInfo}`,r.appendChild(a)}this.modal.appendChild(r),document.body.appendChild(this.modalOverlay),document.body.appendChild(this.modal)}openMobileModal(){this.modalOverlay.classList.add("active"),this.modal.classList.add("active"),document.body.style.overflow="hidden"}closeMobileModal(){this.modalOverlay.classList.remove("active"),this.modal.classList.remove("active"),document.body.style.overflow=""}updateModalTotal(){if(this.modalTotalElement){const{originalPrice:e,discountedPrice:t,savings:n}=this.calculatePrices();n>0?this.modalTotalElement.innerHTML=`
            Total price: 
            <span class="modal-price-sale">${this.formatPrice(t)}</span> 
            <span class="modal-price-original">${this.formatPrice(e)}</span>
          `:this.modalTotalElement.textContent=`Total price: ${this.formatPrice(t)}`}this.updateModalButtonText()}updateModalButtonText(){if(this.modalAddButton){const e=this.selectedProducts.length;e===0?(this.modalAddButton.textContent="Select products",this.modalAddButton.disabled=!0):(this.modalAddButton.textContent=`Add all ${e} to cart`,this.modalAddButton.disabled=!1)}}calculateTotal(){return this.selectedProducts.reduce((e,t)=>e+t.price*(t.quantity||1),0)}updateHorizontalSummary(){this.updateHorizontalTotal(),this.updateHorizontalButtonText()}updateHorizontalTotal(){if(this.totalPriceElement){const{originalPrice:e,discountedPrice:t,savings:n}=this.calculatePrices();if(this.totalPriceElement.innerHTML="",n>0){const r=document.createElement("div");r.className="price-with-discount";const a=document.createElement("span");a.className="discounted-price",a.textContent=this.formatPrice(t),r.appendChild(a);const i=document.createElement("span");if(i.className="original-price",i.textContent=this.formatPrice(e),r.appendChild(i),this.totalPriceElement.appendChild(r),this.showSavingsBadge){const d=document.createElement("span");d.className="savings-badge",d.textContent=`Save ${this.formatPrice(n)}`,this.savingsColor&&(d.style.backgroundColor=this.savingsColor,d.style.color=this.getContrastColor(this.savingsColor)),this.totalPriceElement.appendChild(d)}}else this.totalPriceElement.textContent=this.formatPrice(t);const s=this.totalPriceElement.closest(".bundle-total");s&&(this.selectedProducts.length===0?s.style.display="none":s.style.display="flex")}}updateHorizontalButtonText(){if(this.addButton&&this.addButton.parentElement){const e=this.selectedProducts.length,t=this.addButton.parentElement.querySelector(".cartuplift-bundle-empty-state");if(t&&t.remove(),e===0){this.addButton.style.display="none";const n=document.createElement("div");n.className="cartuplift-bundle-empty-state",n.textContent="Choose items to buy together.",this.addButton.parentElement.appendChild(n)}else this.addButton.style.display="block",this.addButton.disabled=!1,e===1?this.addButton.textContent="Add 1 to Cart":this.addButton.textContent=`Add all ${e} to Cart`}else if(this.addButton){const e=this.selectedProducts.length;e===0?(this.addButton.textContent="Select products",this.addButton.disabled=!0):e===1?(this.addButton.textContent="Add 1 to Cart",this.addButton.disabled=!1):(this.addButton.textContent=`Add all ${e} to Cart`,this.addButton.disabled=!1)}}renderGridCheckboxes(){this.element.classList.add("cartuplift-bundle-grid-style");const e=this.config.type||"manual";if(e==="choose_x_from_y"||e==="category"){const a=this.config.selectMinQty||2,i=this.config.selectMaxQty||this.products.length,d=document.createElement("p");d.className="cartuplift-bundle-prompt",d.textContent=`Pick ${a} to ${i} products`,this.container.appendChild(d)}this.selectedProducts=this.products.map((a,i)=>({...a,index:i,quantity:1}));const n=document.createElement("div");n.className="cartuplift-mobile-image-row",this.products.forEach(a=>{if(a.image){const i=document.createElement("img");i.src=a.image,i.alt=a.title,n.appendChild(i)}});const s=this.element.querySelector(".cartuplift-bundles-heading");s?s.insertAdjacentElement("afterend",n):this.element.insertBefore(n,this.element.firstChild);const r=document.createElement("div");r.className="cartuplift-bundle-grid",this.products.forEach((a,i)=>{const d=this.createGridCard(a,i);r.appendChild(d)}),this.container.appendChild(r)}canToggleProduct(e){return!(!this.canDeselect||e&&(e.isAnchor||e.required===!0||e.isRemovable===!1))}createGridCard(e,t){const n=document.createElement("div");n.className="cartuplift-grid-item selected",n.dataset.hasVariants="pending";const s=document.createElement("label");s.className="grid-card",s.htmlFor=`product-${this.index}-${t}`;const r=document.createElement("div");if(r.className="grid-image",e.image){const c=document.createElement("a");c.href=e.url||`/products/${e.handle||e.id}`,c.target="_blank",c.rel="noopener noreferrer";const b=document.createElement("img");b.src=e.image,b.alt=e.title,c.appendChild(b),r.appendChild(c)}s.appendChild(r);const a=document.createElement("div");a.className="grid-checkbox-container";const i=document.createElement("input");i.type="checkbox",i.className="grid-checkbox-input",i.id=`product-${this.index}-${t}`,i.checked=!0,this.canToggleProduct(e)||(i.disabled=!0),a.appendChild(i);const d=document.createElement("span");d.className="grid-checkbox-indicator",a.appendChild(d);const l=document.createElement("div");l.className="grid-header-row",a.classList.add("checkbox-first"),l.appendChild(a);const m=document.createElement("div");m.className="grid-content";let h=null;if(Array.isArray(e.variants)&&e.variants.length>0){h=this.getActiveVariantId(e);const c=e.variants.find(b=>String(b?.id)===String(h))||e.variants[0];if(c){h=c.id,e.variant_id=c.id,e.variantId=c.id,e.variant_title=c.title;const b=this.normalizePrice(c.price);b!==null&&(e.price=b);const w=this.normalizePrice(c.compare_at_price||c.compareAtPrice);w!==null?e.compare_at_price=w:delete e.compare_at_price,Array.isArray(c.selectedOptions)&&(e.options=c.selectedOptions.map(S=>({name:S?.name,value:S?.value})).filter(S=>S&&S.name&&S.value))}}const g=document.createElement("h4");g.className="grid-product-title";const o=document.createElement("a");if(e.url?o.href=e.url:e.handle?o.href=`/products/${e.handle}`:e.id?o.href=`/products/${e.id}`:o.href="#",o.target="_blank",t===0){const c=document.createElement("span");c.className="grid-item-prefix",c.textContent="This item:",o.appendChild(c),o.appendChild(document.createTextNode(" "+(e.title||"")))}else o.textContent=e.title||"";g.appendChild(o),this.registerInlineStyleGuard(g),this.registerInlineStyleGuard(o),l.appendChild(g),s.appendChild(l);const y=e.rating||e.stars||e.review_rating||null,f=e.reviewCount||e.reviews||e.reviews_count||e.review_count||e.total_reviews||null;if(y||f){if(y){const c=document.createElement("div");c.className="grid-stars";const b=isNaN(Number(y))?5:Number(y);c.textContent="\u2605".repeat(Math.max(0,Math.min(5,Math.floor(b)))),m.appendChild(c)}if(f){const c=document.createElement("div");c.className="grid-reviews",c.textContent=`(${f} Reviews)`,m.appendChild(c)}}const u=this.createPriceElement(e),p=document.createElement("div");p.className="grid-variant-selector";let C,v=!1;if(Array.isArray(e.variants)&&e.variants.length>1)v=!0;else if(Array.isArray(e.variants)&&e.variants.length===1){const c=e.variants[0],b=c.title&&c.title.toLowerCase()!=="default title",w=Array.isArray(c.selectedOptions)&&c.selectedOptions.length>0&&c.selectedOptions.some(S=>S&&S.name&&S.name.toLowerCase()!=="title"&&S.value&&S.value.toLowerCase()!=="default title");b&&w&&(v=!0)}v?(C=document.createElement("select"),n.dataset.hasVariants="true",e.variants.forEach(c=>{if(!c||!c.id)return;const b=document.createElement("option");b.value=String(c.id);let w=(c.title||"").trim();(!w||/default title/i.test(w))&&(Array.isArray(c.selectedOptions)&&c.selectedOptions.length>0?w=c.selectedOptions.map(I=>I?.value||I).filter(Boolean).join(" / "):Array.isArray(c.options)&&c.options.length>0?w=c.options.join(" / "):c.option1||c.option2||c.option3?w=[c.option1,c.option2,c.option3].filter(Boolean).join(" / "):w="Variant"),b.textContent=w,String(h)===String(c.id)&&(b.selected=!0),C.appendChild(b)}),C.addEventListener("change",c=>{const b=c.target.value;this.handleVariantChange(e,t,b,u);const w=e.variants.find(S=>String(S.id)===String(b));w&&this.updatePriceElement(u,w)}),p.appendChild(C)):(p.classList.add("grid-variant-selector-empty"),n.dataset.hasVariants="false"),m.appendChild(p),m.appendChild(u);const P=this.selectedProducts.find(c=>c.index===t);return P&&Object.assign(P,{...e,index:t,quantity:P.quantity||1}),s.appendChild(m),i.addEventListener("change",c=>{if(!this.canToggleProduct(e)){c.target.checked=!0;return}c.target.checked?(n.classList.add("selected"),this.selectedProducts.find(b=>b.index===t)||(this.selectedProducts.push({...e,index:t,quantity:1}),this.selectedProducts.sort((b,w)=>b.index-w.index))):(n.classList.remove("selected"),this.selectedProducts=this.selectedProducts.filter(b=>b.index!==t)),this.renderFooter()}),n.appendChild(s),n}renderCompactList(){const e=document.createElement("div");e.className="cartuplift-bundle-list",this.selectedProducts=this.products.map((t,n)=>({...t,index:n,quantity:1})),this.products.forEach((t,n)=>{const s=document.createElement("div");s.className="cartuplift-list-item";const r=document.createElement("input");if(r.type="checkbox",r.checked=!0,this.canToggleProduct(t)||(r.disabled=!0),r.addEventListener("change",h=>{if(!this.canToggleProduct(t)){h.target.checked=!0;return}h.target.checked?this.selectedProducts.push({...t,index:n,quantity:1}):this.selectedProducts=this.selectedProducts.filter(g=>g.index!==n),this.renderFooter()}),s.appendChild(r),t.image){const h=document.createElement("a");h.href=t.url||`/products/${t.handle||t.id}`,h.target="_blank",h.rel="noopener noreferrer";const g=document.createElement("img");g.src=t.image,g.alt=t.title,h.appendChild(g),s.appendChild(h)}const a=document.createElement("div");a.className="list-content";const i=document.createElement("h4");i.textContent=t.title,a.appendChild(i);const d=t.rating||t.stars||t.review_rating||null,l=t.reviewCount||t.reviews||t.reviews_count||t.review_count||t.total_reviews||null;if(d||l){if(d){const h=document.createElement("div");h.className="list-stars";const g=isNaN(Number(d))?5:Number(d);h.textContent="\u2605".repeat(Math.max(0,Math.min(5,Math.floor(g)))),a.appendChild(h)}if(l){const h=document.createElement("div");h.className="list-reviews",h.textContent=`(${l} Reviews)`,a.appendChild(h)}}const m=this.createPriceElement(t);if(Array.isArray(t.variants)&&t.variants.length>0){let h=this.getActiveVariantId(t);const g=t.variants.find(y=>String(y?.id)===String(h))||t.variants[0];g&&(h=g.id,t.variant_id=g.id);let o=t.variants.length>1;if(!o&&t.variants.length===1){const y=t.variants[0],f=y.title&&y.title.toLowerCase()!=="default title",u=Array.isArray(y.selectedOptions)&&y.selectedOptions.length>0&&y.selectedOptions.some(p=>p&&p.name&&p.name.toLowerCase()!=="title"&&p.value&&p.value.toLowerCase()!=="default title");f&&u&&(o=!0)}if(o){const y=document.createElement("select");y.className="list-variant-selector",t.variants.forEach(f=>{if(!f||!f.id)return;const u=document.createElement("option");u.value=String(f.id);let p=(f.title||"").trim();(!p||/default title/i.test(p))&&(Array.isArray(f.selectedOptions)&&f.selectedOptions.length>0?p=f.selectedOptions.map(v=>v?.value||v).filter(Boolean).join(" / "):Array.isArray(f.options)&&f.options.length>0?p=f.options.join(" / "):f.option1||f.option2||f.option3?p=[f.option1,f.option2,f.option3].filter(Boolean).join(" / "):p="Variant"),u.textContent=p,String(h)===String(f.id)&&(u.selected=!0),y.appendChild(u)}),y.addEventListener("change",f=>{const u=f.target.value;this.handleVariantChange(t,n,u,m);const p=t.variants.find(C=>String(C.id)===String(u));p&&this.updatePriceElement(m,p)}),a.appendChild(y)}}a.appendChild(m),s.appendChild(a),e.appendChild(s)}),this.container.appendChild(e)}renderQuantityTier(){const e=this.config.quantityTiers||[];if(e.length===0){this.container.innerHTML='<p style="color: #999; padding: 20px;">No tiers configured.</p>';return}const t=document.createElement("div");t.className="cartuplift-bundle-tiers",e.forEach((n,s)=>{const r=document.createElement("div");if(r.className="cartuplift-tier-option",n.popular&&r.classList.add("popular"),n.popular){const o=document.createElement("div");o.className="cartuplift-tier-badge",o.textContent="Most Popular",r.appendChild(o)}const a=document.createElement("div");a.className="cartuplift-tier-left";const i=document.createElement("input");if(i.type="radio",i.name=`tier-${this.index}`,i.className="cartuplift-tier-radio",i.value=s,i.addEventListener("change",()=>{document.querySelectorAll(".cartuplift-tier-option").forEach(o=>o.classList.remove("selected")),r.classList.add("selected"),this.selectedQuantityTier=n,this.selectedProducts=this.products.map((o,y)=>({...o,index:y,quantity:n.quantity})),this.renderFooter()}),a.appendChild(i),this.products.length>0){const o=document.createElement("div");o.className="cartuplift-tier-images",this.products.slice(0,3).forEach(y=>{if(y.image){const f=document.createElement("a");f.href=y.url||`/products/${y.handle||y.id}`,f.target="_blank",f.rel="noopener noreferrer";const u=document.createElement("img");u.src=y.image,u.alt=y.title,f.appendChild(u),o.appendChild(f)}}),a.appendChild(o)}const d=document.createElement("div");d.className="cartuplift-tier-info";const l=document.createElement("h4");if(l.textContent=`Buy ${n.quantity}`,n.discountPercent>0){const o=document.createElement("span");o.className="cartuplift-tier-discount-badge",o.textContent=`Save ${n.discountPercent}%`,l.appendChild(o)}if(d.appendChild(l),n.description){const o=document.createElement("p");o.className="cartuplift-tier-description",o.textContent=n.description,d.appendChild(o)}a.appendChild(d),r.appendChild(a);const m=document.createElement("div");m.className="cartuplift-tier-right";const h=document.createElement("p");if(h.className="cartuplift-tier-price",h.textContent=this.formatPrice(n.discountedPrice),m.appendChild(h),n.originalPrice>n.discountedPrice){const o=document.createElement("p");o.className="cartuplift-tier-original-price",o.textContent=this.formatPrice(n.originalPrice),m.appendChild(o)}const g=document.createElement("p");g.className="cartuplift-tier-unit-price",g.textContent=`${this.formatPrice(n.discountedPrice/n.quantity)} each`,m.appendChild(g),r.appendChild(m),r.addEventListener("click",o=>{o.target!==i&&(i.checked=!0,i.dispatchEvent(new Event("change")))}),t.appendChild(r)}),this.container.appendChild(t)}renderFooter(){if(this.footer.innerHTML="",this.selectedProducts.length===0&&this.config.bundleStyle!=="tier"){const C=document.createElement("div");C.className="cartuplift-bundle-empty-state",C.textContent="Choose items to buy together.",C.style.cssText="text-align: center; padding: 16px; color: #666; font-size: 14px; font-style: italic;",this.footer.appendChild(C);return}const{originalPrice:e,discountedPrice:t,savings:n,savingsPercent:s}=this.calculatePrices(),r=this.minProducts>0&&this.selectedProducts.length<this.minProducts,a=this.minBundlePrice>0&&t<this.minBundlePrice,i=document.createElement("div");if(i.className="cartuplift-bundle-price-summary",this.minProducts>0){const C=document.createElement("div");C.className="cartuplift-bundle-requirement",C.textContent=`Requires at least ${this.minProducts} item${this.minProducts===1?"":"s"}`,i.appendChild(C)}if(this.minBundlePrice>0){const C=document.createElement("div");C.className="cartuplift-bundle-requirement",C.textContent=`Requires bundle total of ${this.formatPrice(this.minBundlePrice)}`,i.appendChild(C)}const d=document.createElement("div");if(d.className="cartuplift-price-info",n>0&&this.showSavingsBadge){const C=document.createElement("div");C.className="cartuplift-bundle-savings";let v=this.config.savingsBadgeText||"Save {amount}!";v=v.replace("{amount}",this.formatPrice(n)).replace("{percent}",`${s}%`),C.textContent=v,this.savingsColor&&(C.style.backgroundColor=this.savingsColor,C.style.color=this.getContrastColor(this.savingsColor)),d.appendChild(C)}const l=document.createElement("div");l.className="cartuplift-price-display";const m=document.createElement("span");m.className="label",m.textContent="Total price:",l.appendChild(m);const h=document.createElement("span");if(h.className="final-price",h.textContent=this.formatPrice(t),l.appendChild(h),n>0&&e>0){const C=document.createElement("span");C.className="original-price",C.textContent=this.formatPrice(e),l.appendChild(C)}d.appendChild(l),i.appendChild(d);const g=document.createElement("div");g.className="cartuplift-button-container";const o=document.createElement("button");o.className="cartuplift-bundle-add-button",o.textContent=this.config.buttonText||"Add Bundle to Cart";const y=this.config.bundleStyle||"clean",f=this.config.selectMinQty||this.config.minProducts||0,u=this.config.selectMaxQty||this.config.maxProducts||this.products.length;let p=!0;if(y==="tier")p=this.selectedQuantityTier!==null,p||(o.textContent="Select a quantity");else{const C=this.config.type||"manual";C==="choose_x_from_y"||C==="category"?(p=this.selectedProducts.length>=f&&this.selectedProducts.length<=u,p||(o.textContent=`Select ${f}-${u} products`)):p=this.selectedProducts.length>0}r&&(p=!1,o.textContent=`Pick ${this.minProducts}+ items`),a&&(p=!1,o.textContent=`Add more products to reach ${this.formatPrice(this.minBundlePrice)}`),o.disabled=!p,o.addEventListener("click",()=>{this.trackEvent("click"),this.addBundleToCart()}),g.appendChild(o),i.appendChild(g),this.footer.appendChild(i)}createPriceElement(e){const t=document.createElement("p");if(t.className="price",t.textContent=this.formatPrice(e.price),e.compare_at_price&&e.compare_at_price>e.price){const n=document.createElement("span");n.className="compare-price",n.textContent=this.formatPrice(e.compare_at_price),t.appendChild(n)}return t}handleVariantChange(e,t,n,s){if(!Array.isArray(e.variants)||e.variants.length===0)return;const r=e.variants.find(l=>String(l?.id)===String(n));if(!r)return;const a=this.normalizePrice(r.price),i=this.normalizePrice(r.compare_at_price||r.compareAtPrice);e.variant_id=r.id,e.variantId=r.id,e.variant_title=r.title,a!==null&&(e.price=a),i!==null?e.compare_at_price=i:delete e.compare_at_price,Array.isArray(r.selectedOptions)&&(e.options=r.selectedOptions.map(l=>({name:l?.name,value:l?.value})).filter(l=>l&&l.name&&l.value));const d=this.selectedProducts.find(l=>l.index===t);d&&Object.assign(d,{...e,index:t,quantity:d.quantity||1}),this.updatePriceElement(s,e),this.renderFooter()}getActiveVariantId(e){const t=e.variant_id||e.variantId;return t||(Array.isArray(e.variants)&&e.variants.length>0?e.variants[0].id:null)}normalizePrice(e){if(e==null)return null;if(typeof e=="number"){if(Number.isInteger(e))return e;const i=Math.pow(10,this.currencyMinorUnits);return Math.round(e*i)}const n=String(e).trim().replace(/[^0-9.\-]/g,""),s=n.includes("."),r=parseFloat(n);if(Number.isNaN(r))return null;const a=Math.pow(10,this.currencyMinorUnits);return s?Math.round(r*a):r>=a?Math.round(r):Math.round(r*a)}updatePriceElement(e,t){if(e&&(e.innerHTML="",e.textContent=this.formatPrice(t.price),t.compare_at_price&&t.compare_at_price>t.price)){const n=document.createElement("span");n.className="compare-price",n.textContent=this.formatPrice(t.compare_at_price),e.appendChild(n)}}formatPrice(e){return q(e,this.currencyCode,this.currencyMinorUnits)}calculatePrices(){let e=0,t=0;const n=this.config.bundleStyle||"clean",s=this.config.discountType||"percentage",r=this.config.discountValue||0;n==="tier"&&this.selectedQuantityTier?(e=this.selectedQuantityTier.originalPrice,t=this.selectedQuantityTier.discountedPrice):(this.selectedProducts.forEach(d=>{const l=d.quantity||1;e+=d.price*l}),s==="percentage"?t=e*(1-r/100):s==="fixed"?t=e-r*100:t=e);const a=Math.max(0,e-t),i=e>0?Math.round(a/e*100):0;return{originalPrice:e,discountedPrice:t,savings:a,savingsPercent:i,discountApplied:i>0}}getContrastColor(e){if(!e)return"#ffffff";const t=e.replace("#",""),n=parseInt(t.substr(0,2),16),s=parseInt(t.substr(2,2),16),r=parseInt(t.substr(4,2),16);return(n*299+s*587+r*114)/1e3>128?"#000000":"#ffffff"}async addBundleToCart(){this.trackEvent("add_to_cart");const e=this.addButton?this.addButton.textContent:"",t=this.modalAddButton?this.modalAddButton.textContent:"";if(this.addButton&&(this.addButton.textContent="Adding...",this.addButton.disabled=!0),this.modalAddButton&&(this.modalAddButton.textContent="Adding...",this.modalAddButton.disabled=!0),this.minProducts>0&&this.selectedProducts.length<this.minProducts){alert(`Add at least ${this.minProducts} item${this.minProducts===1?"":"s"} from this bundle.`);return}if(this.minBundlePrice>0){const{discountedPrice:n}=this.calculatePrices();if(n<this.minBundlePrice){alert(`Add more products to reach a bundle value of ${this.formatPrice(this.minBundlePrice)}.`);return}}try{const n=await fetch("/cart.js"),s=n.ok?await n.json():{items:[]},r=new Map;(s.items||[]).forEach(l=>{const m=String(l.variant_id||l.id);r.set(m,l)});const a=[],i=[];this.selectedProducts.forEach(l=>{const m=l.quantity||1;let h=l.variant_id||l.variantId;!h&&l.variants&&l.variants[0]?h=l.variants[0].id:h||(h=l.id);const g=String(h).replace(/[^0-9]/g,""),o=r.get(g);if(o){const y=o.properties||{};let f=parseInt(y._source_manual_qty||0),u=parseInt(y._source_rec_qty||0),p=parseInt(y._source_bundle_qty||0);f===0&&u===0&&p===0&&(f=o.quantity),p+=m;const C=f+u+p;i.push({key:o.key,variantId:g,newQuantity:C,properties:{_bundle_id:this.config.id,_bundle_name:this.config.name||this.config.displayTitle,_source_manual_qty:f>0?String(f):void 0,_source_rec_qty:u>0?String(u):void 0,_source_bundle_qty:String(p)}})}else a.push({id:g,quantity:m,properties:{_bundle_id:this.config.id,_bundle_name:this.config.name||this.config.displayTitle,_source_bundle_qty:String(m)}})});for(const l of i)await fetch("/cart/change.js",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({id:l.key,quantity:0})});const d=[...a,...i.map(l=>({id:l.variantId,quantity:l.newQuantity,properties:Object.fromEntries(Object.entries(l.properties).filter(([m,h])=>h!==void 0))}))];if(d.length>0){const l=await fetch("/cart/add.js",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({items:d})});if(l.ok){const m=await l.json();this.refreshCart()}else{const m=await l.json().catch(()=>({description:"Unknown error"})),h=m.description||m.message||"Failed to add to cart";throw _.error("Cart API error:",m),new Error(h)}}}catch(n){_.error("Failed to add bundle:",n),alert(`Failed to add bundle to cart: ${n.message}`)}finally{this.addButton&&(this.addButton.textContent=e,this.addButton.disabled=!1),this.modalAddButton&&(this.modalAddButton.textContent=t,this.modalAddButton.disabled=!1)}}async refreshCart(){try{const n=await fetch("/cart.js");if(n.ok){const s=await n.json();document.querySelectorAll(".cart-count, [data-cart-count], .cart-count-bubble").forEach(a=>{a.textContent=s.item_count,a.classList.contains("hidden")&&s.item_count>0&&a.classList.remove("hidden")})}}catch{}if(window.cartUpliftDrawer&&typeof window.cartUpliftDrawer.open=="function")try{typeof window.cartUpliftDrawer.fetchCart=="function"&&await window.cartUpliftDrawer.fetchCart(),typeof window.cartUpliftDrawer.updateDrawerContent=="function"&&await window.cartUpliftDrawer.updateDrawerContent(),window.cartUpliftDrawer.open();return}catch{}const e=document.querySelector("cart-drawer");if(e)try{if(typeof e.getSectionsToRender=="function"&&e.getSectionsToRender().forEach(n=>{fetch(`${window.location.pathname}?section_id=${n.id}`).then(s=>s.text()).then(s=>{const i=new DOMParser().parseFromString(s,"text/html").querySelector(n.selector);i&&(document.querySelector(n.selector).innerHTML=i.innerHTML)})}),typeof e.open=="function"){e.open();return}}catch(n){_.warn("Theme cart drawer failed:",n)}const t=document.querySelector("mini-cart, cart-notification, [data-mini-cart]");if(t&&typeof t.open=="function")try{t.open();return}catch{}try{document.documentElement.dispatchEvent(new CustomEvent("cart:refresh",{bubbles:!0})),document.body.dispatchEvent(new CustomEvent("cart:updated",{bubbles:!0})),window.dispatchEvent(new CustomEvent("cart:refresh")),window.dispatchEvent(new CustomEvent("cart:updated"))}catch{}if(typeof Shopify<"u"&&Shopify.theme)try{typeof Shopify.theme.cartUpdateCallbacks<"u"&&Shopify.theme.cartUpdateCallbacks.forEach(n=>n())}catch{}}trackEvent(e){const t=$(),n={shop:window.Shopify?.shop||window.location.hostname,bundleId:this.config.id,bundleName:this.config.name,bundleType:this.config.type||"manual",bundleStyle:this.config.bundleStyle||"clean",event:e,sessionId:t,products:this.selectedProducts.map(s=>s.id),timestamp:Date.now()};this.sendBundleAnalytics(n).catch(()=>{this.sendTrackingFallback(e,t)})}sendBundleAnalytics(e){return fetch("/apps/cart-uplift/api/bundle-analytics",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(e)}).then(t=>{if(!t.ok)throw new Error("Bundle analytics request failed")})}sendTrackingFallback(e,t){const s={event:e==="view"?"impression":e,productId:this.config.id,productTitle:this.config.name,source:"bundle",sessionId:t};return fetch("/apps/cart-uplift/api/track",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(s)}).catch(()=>{})}}document.readyState==="loading"?document.addEventListener("DOMContentLoaded",()=>{window.bundleManager=new k}):window.bundleManager=new k})();})();
