(()=>{const t={VERSION:"v20.2",CART_VERSION:"1.2.0",DEBUG:"undefined"!=typeof window&&"true"===window.localStorage?.getItem("CART_UPLIFT_DEBUG"),API_ENDPOINTS:{TRACK:"/apps/cart-uplift/api/track",CART_TRACKING:"/apps/cart-uplift/api/cart-tracking"},STORAGE_KEYS:{SESSION_ID:"cart_session_id"},SELECTORS:{GRID_OVERLAY:".cartuplift-grid-overlay"},EVENTS:{IMPRESSION:"impression",CLICK:"click",CART_OPENED:"cartuplift:opened"},TIMING:{GRID_SELF_HEAL_DELAY:800}},e={log:(...e)=>t.DEBUG&&void 0,info:(...e)=>t.DEBUG&&void 0,warn:(...t)=>{},error:(...t)=>{}};function i(){let e=sessionStorage.getItem(t.STORAGE_KEYS.SESSION_ID);return e||(e=`sess_${Date.now()}_${Math.random().toString(36).slice(2)}`,sessionStorage.setItem(t.STORAGE_KEYS.SESSION_ID,e)),e}(()=>{(new Date).toISOString();function i(){try{if("grid"===(window.CartUpliftSettings?.recommendationLayout||"")){const i=document.querySelectorAll(t.SELECTORS.GRID_OVERLAY);i.length&&(e.warn("[CartUplift] Removing stale grid overlay nodes (cache mismatch fix). Count:",i.length),i.forEach((t=>t.remove())))}}catch(t){}}window.CART_UPLIFT_ASSET_VERSION!==t.VERSION&&(window.CART_UPLIFT_ASSET_VERSION=t.VERSION),document.addEventListener("DOMContentLoaded",(()=>setTimeout(i,t.TIMING.GRID_SELF_HEAL_DELAY))),document.addEventListener(t.EVENTS.CART_OPENED,i)})();const n={trackedEvents:new Set,trackEvent:function(e,n={}){try{const a=window.Shopify?.shop||"",r=i();if(e===t.EVENTS.IMPRESSION||e===t.EVENTS.CLICK){const t=`${e}_${n.productId}_${r}`;if(this.trackedEvents.has(t))return;this.trackedEvents.add(t)}const s=new FormData;s.append("eventType",e),s.append("shop",a),s.append("sessionId",r),n.productId&&s.append("productId",n.productId),n.variantId&&s.append("variantId",n.variantId),n.parentProductId&&s.append("parentProductId",n.parentProductId),n.productTitle&&s.append("productTitle",n.productTitle),n.revenue&&s.append("revenue",n.revenue.toString()),n.orderId&&s.append("orderId",n.orderId),n.source&&s.append("source",n.source),void 0!==n.position&&s.append("position",n.position.toString()),fetch(t.API_ENDPOINTS.TRACK,{method:"POST",body:s}).then((t=>t.json())).then((t=>{})).catch((t=>{}))}catch(t){}}};class a{constructor(e){this.version=t.CART_VERSION,this.settings=Object.assign({},window.CartUpliftSettings||{},e||{});const i=t=>{if("string"==typeof t){const e=t.trim().toLowerCase();return"true"===e||"1"===e||"yes"===e||"on"===e}return Boolean(t)};if(void 0!==this.settings.enableProductTitleCaps&&(this.settings.enableProductTitleCaps=i(this.settings.enableProductTitleCaps)),void 0!==this.settings.enableRecommendationTitleCaps&&(this.settings.enableRecommendationTitleCaps=i(this.settings.enableRecommendationTitleCaps)),this.themeColors=this.detectThemeColors(),this.settings.shippingBarColor&&"#4CAF50"!==this.settings.shippingBarColor||(this.settings.shippingBarColor="#121212"),this.settings.backgroundColor||(this.settings.backgroundColor=this.themeColors.background),this.settings){!this.settings.recommendationLayout&&this.settings.recommendationsLayout&&(this.settings.recommendationLayout=this.settings.recommendationsLayout),"theme"===this.settings.recommendationLayoutSource&&this.settings.recommendationsLayout&&(this.settings.recommendationLayout=this.settings.recommendationsLayout);const t={horizontal:"row",row:"row",carousel:"row",vertical:"column",column:"column",list:"column",grid:"grid"};this.settings.recommendationLayout&&(this.settings.recommendationLayout=t[this.settings.recommendationLayout]||this.settings.recommendationLayout)}this.settings.enableFreeShipping=Boolean(this.settings.enableFreeShipping),this.settings.enableGiftGating=Boolean(this.settings.enableGiftGating),this.settings.enableApp=!1!==this.settings.enableApp,this.settings.enableRecommendations=!1!==this.settings.enableRecommendations,this.settings.enableAddons=Boolean(this.settings.enableAddons),this.settings.enableNotes=Boolean(this.settings.enableOrderNotes||this.settings.enableNotes),this.settings.enableDiscountCode=!1!==this.settings.enableDiscountCode,this.settings.enableExpressCheckout=!1!==this.settings.enableExpressCheckout,this.settings.discountLinkText=this.settings.promotionLinkText||this.settings.discountLinkText||"+ Got a promotion code?",this.settings.maxRecommendations=this.normalizeMaxRecommendations(this.settings.maxRecommendations),window.CartUpliftSettings&&(window.CartUpliftSettings.maxRecommendations=this.settings.maxRecommendations),this.settings.designMode&&void 0!==this.settings.keepCartOpen?this.settings.autoOpenCart=Boolean(this.settings.keepCartOpen):this.settings.autoOpenCart=Boolean(this.settings.autoOpenCart),this.settings.enableTitleCaps=Boolean(this.settings.enableTitleCaps),this.settings.freeShippingThresholdCents=this.getFreeShippingThresholdCents(),window.CartUpliftSettings&&(window.CartUpliftSettings.freeShippingThresholdCents=this.settings.freeShippingThresholdCents),this.settings.giftNoticeText=this.settings.giftNoticeText||"Free gift added",this.settings.giftPriceText=this.settings.giftPriceText||"FREE",this.settings.combinedSuccessTemplate=this.settings.allRewardsAchievedText||"âœ“ Free shipping + {{ product_name }} added free",this.cart={items:[],item_count:0,total_price:0,currency:window.Shopify?.currency?.active||"USD"},this.isOpen=!1,this._isAnimating=!1,this._quantityBusy=!1,this._recommendationsLoaded=!1,this._rebuildInProgress=!1,this._recommendationsLocked=!1,this._updateDebounceTimer=null,this.recommendations=[],this._allRecommendations=[],this._freeShippingHadUnlocked=!1,this._modalOpening=!1,this._giftModalRetryTimer=null,this.settings.enableApp&&this.installEarlyInterceptors(),this._settingsUpdateHandler=async t=>{if(this.settings=Object.assign({},this.settings,window.CartUpliftSettings||{}),!this.settings.recommendationLayout&&this.settings.recommendationsLayout&&(this.settings.recommendationLayout=this.settings.recommendationsLayout),"theme"===this.settings.recommendationLayoutSource&&this.settings.recommendationsLayout&&(this.settings.recommendationLayout=this.settings.recommendationsLayout),this.settings.recommendationLayout){const t={horizontal:"row",row:"row",carousel:"row",vertical:"column",column:"column",list:"column",grid:"grid"};this.settings.recommendationLayout=t[this.settings.recommendationLayout]||this.settings.recommendationLayout}this.settings.maxRecommendations=this.normalizeMaxRecommendations(this.settings.maxRecommendations),window.CartUpliftSettings&&(window.CartUpliftSettings.maxRecommendations=this.settings.maxRecommendations),this.settings.freeShippingThresholdCents=this.getFreeShippingThresholdCents(),window.CartUpliftSettings&&(window.CartUpliftSettings.freeShippingThresholdCents=this.settings.freeShippingThresholdCents),this.applyCustomColors(),this.settings.enableRecommendations&&!this._recommendationsLoaded?(await this.loadRecommendations(),this._recommendationsLoaded=!0):this._allRecommendations.length&&this.rebuildRecommendationsFromMaster(),this.updateDrawerContent(),this.updateRecommendationsSection()},document.addEventListener("cartuplift:settings:updated",this._settingsUpdateHandler),this.initPromise=this.init()}escapeHtml(t){return null==t?"":String(t).replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#39;")}normalizeMaxRecommendations(t){const e=Number(t);if(!(Number.isFinite,Number.isFinite(e))||e<=0)return 3;return Math.max(1,Math.floor(e))}async init(){e.log("CartUplift v8.0: AI-powered bundles & intelligent cart recommendations active | Author: Adedayo for Cass, Eni & Ayo"),await this.setup(),"loading"===document.readyState&&document.addEventListener("DOMContentLoaded",(()=>{this.cart&&this.updateDrawerContent()}))}detectThemeColors(){let t=null;try{const e=document.querySelectorAll('[class*="color-scheme"], [class*="color-"]');for(const i of e){const e=getComputedStyle(i),n=e.getPropertyValue("--color-button").trim(),a=e.getPropertyValue("--color-foreground").trim();if(n?.includes(",")){const e=n.split(",").map((t=>parseInt(t.trim(),10)));if(e.length>=3&&e.every((t=>!Number.isNaN(t)&&t>=0&&t<=255))){t=this.rgbToHex(`rgb(${e.join(",")})`);break}}if(!t&&a&&a.includes(",")){const e=a.split(",").map((t=>parseInt(t.trim(),10)));if(e.length>=3&&e.every((t=>!Number.isNaN(t)&&t>=0&&t<=255))){t=this.rgbToHex(`rgb(${e.join(",")})`);break}}}}catch(t){}if(!t){const e=getComputedStyle(document.documentElement),i=["--color-button","--color-foreground","--color-accent","--color-primary"];for(const n of i)try{const i=e.getPropertyValue(n).trim();if(i?.includes(",")){const e=i.split(",").map((t=>parseInt(t.trim(),10)));if(e.length>=3&&e.every((t=>!Number.isNaN(t)&&t>=0&&t<=255))){t=this.rgbToHex(`rgb(${e.join(",")})`);break}}else{if(i?.startsWith("#")){t=i;break}if(i?.startsWith("rgb")){const e=this.rgbToHex(i);if(e){t=e;break}}}}catch(t){}}if(!t){const e=[".button:not(.button--secondary):not(.button--tertiary)",".product-form__cart-submit",".shopify-payment-button__button--unbranded",'button[type="submit"]:not(.button--secondary)',".btn--primary",'[data-shopify*="button"]'];for(const i of e)try{const e=document.querySelector(i);if(e&&null!==e.offsetParent){const i=getComputedStyle(e).backgroundColor;if(i&&"rgba(0, 0, 0, 0)"!==i&&"transparent"!==i){const e=this.rgbToHex(i);if(e&&"#ffffff"!==e&&"#000000"!==e&&"#transparent"!==e){t=e;break}}}}catch(t){}}t||(t="#121212"),t&&this.isGreenColor(t)&&(e.warn("ðŸš« [CartUplift] Green color detected, using Dawn default:",t),t="#121212");let i="#ffffff";try{const t=getComputedStyle(document.body).backgroundColor;if(t&&"rgba(0, 0, 0, 0)"!==t&&"transparent"!==t)i=this.rgbToHex(t);else{const t=getComputedStyle(document.documentElement),e=t.backgroundColor;if(e&&"rgba(0, 0, 0, 0)"!==e&&"transparent"!==e)i=this.rgbToHex(e);else{const e=["--color-background","--color-body","--background-color","--color-base-background"];for(const n of e){const e=t.getPropertyValue(n).trim();if(e)if(e.includes(",")){const t=e.split(",").map((t=>parseInt(t.trim(),10)));if(t.length>=3&&t.every((t=>!Number.isNaN(t)&&t>=0&&t<=255))){i=this.rgbToHex(`rgb(${t.join(",")})`);break}}else if(e.startsWith("#")||e.startsWith("rgb")){i=this.rgbToHex(e);break}}}}}catch(t){i="#ffffff"}return{primary:t,background:i}}isGreenColor(t){if(!t||"string"!=typeof t)return!1;const e=t.toLowerCase();if(["#4caf50","#22c55e","#10b981","#059669","#34d399","#6ee7b7","#a7f3d0","#d1fae5","#ecfdf5","#00ff00","#008000","#228b22","#32cd32","#7cfc00","#adff2f","#9acd32","#98fb98","#90ee90","#00fa9a","#00ff7f"].includes(e))return!0;try{let i,n,a;if(e.startsWith("#")){const t=/^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(e);t&&(i=parseInt(t[1],16),n=parseInt(t[2],16),a=parseInt(t[3],16))}else if(t.includes("rgb")){const e=t.match(/rgb\((\d+),\s*(\d+),\s*(\d+)\)/);e&&(i=parseInt(e[1],10),n=parseInt(e[2],10),a=parseInt(e[3],10))}if(void 0!==i&&void 0!==n&&void 0!==a)return n>i+30&&n>a+30&&n>100}catch(t){}return!1}rgbToHex(t){if(!t||!t.includes("rgb"))return null;const e=t.match(/rgb\((\d+),\s*(\d+),\s*(\d+)\)/);if(!e)return null;return`#${((1<<24)+(parseInt(e[1],10)<<16)+(parseInt(e[2],10)<<8)+parseInt(e[3],10)).toString(16).slice(1)}`}async setup(){this.prewarmCart(),this.createDrawer(),this.setupCartUpliftInterception(),this.installClickTracker(),this.installAddToCartMonitoring(),this.applyCustomColors(),this.settings.enableApp&&this.setupNotificationBlocker(),this.fetchCart().then((()=>{this.updateDrawerContent(),this.checkAndAddGiftThresholds()})),this.settings.enableRecommendations&&!this._recommendationsLoaded&&this.loadRecommendations().then((()=>{this._recommendationsLoaded=!0,this.updateDrawerContent()})),setTimeout((async()=>{window.CartUpliftSettings&&(this.settings=Object.assign({},this.settings,window.CartUpliftSettings)),this.settings.enableRecommendations&&!this._recommendationsLoaded&&(await this.loadRecommendations(),this._recommendationsLoaded=!0,this.updateDrawerContent())}),500),document.addEventListener("cartuplift:settings:updated",(async()=>{this.settings=Object.assign(this.settings,window.CartUpliftSettings||{}),this.applyCustomColors(),this.settings.enableRecommendations&&!this._recommendationsLoaded&&await this.loadRecommendations(),this.updateDrawerContent()})),window.cartUpliftRefreshSettings=async()=>{await this.refreshSettingsFromAPI()}}disableApp(){if(this.settings.enableApp=!1,window.CartUpliftSettings=window.CartUpliftSettings||{},window.CartUpliftSettings.enableApp=!1,this.isOpen){const t=document.getElementById("cartuplift-app-container");t&&(t.classList.remove("active"),t.style.display="none"),this.isOpen=!1,document.documentElement.classList.remove("cartuplift-no-scroll"),document.body.classList.remove("cartuplift-no-scroll")}const t=document.getElementById("cartuplift-app-container");t&&(t.style.display="none",t.style.visibility="hidden");const e=document.querySelector(".cartuplift-cart-badge");e&&e.remove()}updateSettingsFromThemeExtension(t){window.cartUpliftSoftRefresh=async()=>{await this.fetchCart(),this._recommendationsLoaded&&this.rebuildRecommendationsFromMaster(),this.updateDrawerContent()},window.cartUpliftRestoreOriginals=()=>window.cartUpliftDrawer?._restoreOriginalFunctions?(window.cartUpliftDrawer._restoreOriginalFunctions(),e.log("âœ… CartUplift: All original theme functions restored"),!0):(e.warn("âš ï¸ CartUplift: Drawer not initialized, nothing to restore"),!1),document.dispatchEvent(new CustomEvent("cartuplift:ready"))}prewarmCart(){const t=performance.now();if(this._prewarmPromise||(this._prewarmPromise=fetch("/cart.js",{method:"GET",headers:{Accept:"application/json"}}).then((t=>t.json())).then((e=>{Math.round(performance.now()-t);return this._prewarmData=e,e})).catch((t=>{this._prewarmData=null}))),this.settings.enableRecommendations&&!this._recommendationsPrewarmed&&window.ShopifyAnalytics?.meta?.product?.id){this._recommendationsPrewarmed=!0;const t=window.ShopifyAnalytics.meta.product.id;fetch(`/recommendations/products.json?product_id=${t}&limit=20`,{method:"GET",headers:{Accept:"application/json"}}).then((t=>t.ok?t.json():null)).then((t=>{})).catch((t=>{}))}}installClickTracker(){this._lastClick=null,document.addEventListener("click",(t=>{const e=t.target.closest('button, [type="submit"], .product-form, form, a, .add-to-cart, [name="add"], [data-add-to-cart]');if(!e)return;const i=e.getBoundingClientRect(),n="number"==typeof t.clientX&&t.clientX?t.clientX:i.left+i.width/2,a="number"==typeof t.clientY&&t.clientY?t.clientY:i.top+i.height/2;this._lastClick={x:n,y:a,time:Date.now(),rect:i}}),!0)}getFlyTargetPoint(){const t=[".header__icon--cart",".cart-link",".cart-icon",".site-header__cart",".nav-cart",".header-cart","[data-cart-drawer-toggle]"];for(const e of t){const t=document.querySelector(e);if(t&&null!==t.offsetParent){const e=t.getBoundingClientRect();return{x:e.left+e.width/2,y:e.top+e.height/2,el:t}}}return{x:window.innerWidth-24,y:window.innerHeight/2,el:null}}flyToCart(t={}){}async refreshSettingsFromAPI(){try{const t=window.CartUpliftShop||window.Shopify?.shop;if(t){const i=`/apps/cart-uplift/api/settings?shop=${encodeURIComponent(t)}`,n=await fetch(i);if(402===n.status)return void this.disableApp();if(n.ok){const t=await n.json();"theme"===this.settings.recommendationLayoutSource&&(t.recommendationLayout=this.settings.recommendationLayout,t.recommendationsLayout=this.settings.recommendationsLayout||t.recommendationsLayout,t.recommendationLayoutSource="theme"),this.settings.designMode&&(e.log("ðŸ”§ Preserving design mode settings during API refresh"),t.designMode=this.settings.designMode,void 0!==this.settings.keepCartOpen&&(t.keepCartOpen=this.settings.keepCartOpen,t.autoOpenCart=this.settings.keepCartOpen,e.log("ðŸ”§ Preserved keepCartOpen:",this.settings.keepCartOpen,"autoOpenCart set to:",t.autoOpenCart))),this.settings=Object.assign(this.settings,t),window.CartUpliftSettings=Object.assign(window.CartUpliftSettings||{},t),this.applyCustomColors(),this.updateDrawerContent()}}}catch(t){}}updateSettingsFromThemeExtension(t){e.log("ðŸŽ¯ Updating cart drawer settings from theme extension:",t),this.settings=Object.assign(this.settings,t),window.CartUpliftSettings=Object.assign(window.CartUpliftSettings||{},t),this.applyCustomColors(),t.recommendationLayout&&this.refreshRecommendationLayout(),this.updateDrawerContent()}applyCustomColors(){const t=document.getElementById("cartuplift-dynamic-styles")||document.createElement("style");t.id="cartuplift-dynamic-styles";const e=this.themeColors||this.detectThemeColors(),i=this.isGreenColor(e.primary)?"#121212":e.primary,n=this.settings.buttonColor&&!this.isGreenColor(this.settings.buttonColor)?this.settings.buttonColor:i,a=this.settings.shippingBarColor&&!this.isGreenColor(this.settings.shippingBarColor)?this.settings.shippingBarColor:"#10b981";t.textContent.includes("@keyframes cartupliftPulse")||(t.textContent+="\n@keyframes cartupliftPulse {\n  0% { transform: scale(1); }\n  50% { transform: scale(1.08); }\n  100% { transform: scale(1); }\n}\n.cartuplift-header-cart.cartuplift-pulse {\n  animation: cartupliftPulse 450ms ease-out;\n}\n"),document.documentElement.style.setProperty("--cartuplift-button-color",a),document.documentElement.style.setProperty("--cartuplift-shipping-fill",a);const r=document.querySelector("#cartuplift-cart-popup .cartuplift-drawer");if(r){r.querySelectorAll(".cartuplift-progress-bar").forEach((t=>{const e=t.querySelector(".cartuplift-progress-fill");e&&(e.style.setProperty("background",a,"important"),e.style.setProperty("display","block","important"),e.style.setProperty("opacity","1","important"))}))}const s=this.settings.cartBackgroundColor||this.settings.backgroundColor||"#ffffff",o=`\n        :root {\n          --cartuplift-success-color: ${i} !important;\n          --cartuplift-success: ${i} !important;\n          --cartuplift-button-color: ${a} !important;\n          --cartuplift-shipping-fill: ${a} !important;\n          ${this.settings.buttonTextColor?`--cartuplift-button-text-color: ${this.settings.buttonTextColor} !important;`:""}\n          --cartuplift-background: ${s} !important;\n          --cartuplift-cart-background: ${s} !important;\n          ${this.settings.textColor?`--cartuplift-primary: ${this.settings.textColor} !important;`:""}\n          ${this.settings.recommendationsBackgroundColor?`--cartuplift-recommendations-bg: ${this.settings.recommendationsBackgroundColor} !important;`:""}\n          ${this.settings.shippingBarBackgroundColor?`--cartuplift-progress-bg: ${this.settings.shippingBarBackgroundColor} !important;`:"--cartuplift-progress-bg: #E5E5E5 !important;"}\n        }\n        \n        /* CRITICAL: Force override ALL green color possibilities with !important */\n        .cartuplift-progress-fill,\n        .cartuplift-milestone.completed .cartuplift-milestone-icon,\n        .cartuplift-achievement-content,\n        .cartuplift-shipping-progress-bar .cartuplift-progress-fill,\n        .cartuplift-shipping-progress-fill {\n          background: ${a} !important;\n          background-color: ${a} !important;\n        }\n        \n        .cartuplift-milestone.completed .cartuplift-milestone-label,\n        .cartuplift-achievement-text {\n          color: ${a} !important;\n        }\n        \n        /* Prevent any green elements from CSS cascade */\n        .cartuplift-drawer .cartuplift-progress-fill,\n        .cartuplift-drawer .cartuplift-milestone-icon,\n        .cartuplift-drawer .cartuplift-shipping-progress-fill,\n        #cartuplift-cart-popup .cartuplift-progress-fill,\n        .cartuplift-shipping-progress .cartuplift-progress-fill,\n        .cartuplift-recommendations .cartuplift-progress-fill {\n          background-color: ${a} !important;\n        }\n        \n        .cartuplift-drawer [style*="#4CAF50"],\n        .cartuplift-drawer [style*="#22c55e"],\n        .cartuplift-drawer [style*="rgb(76, 175, 80)"],\n        .cartuplift-drawer [style*="rgb(34, 197, 94)"] {\n          background: ${i} !important;\n          color: ${i} !important;\n        }\n        \n        /* Apply background colors */\n        ${s?`\n        .cartuplift-drawer,\n        .cartuplift-header,\n        .cartuplift-content-wrapper,\n        .cartuplift-items,\n        .cartuplift-scrollable-content,\n        .cartuplift-footer {\n          background: ${s} !important;\n        }`:""}\n        \n        /* Apply text colors */\n        ${this.settings.textColor?`\n        .cartuplift-drawer,\n        .cartuplift-item-title,\n        .cartuplift-price,\n        .cartuplift-total-label,\n        .cartuplift-total-value {\n          color: ${this.settings.textColor} !important;\n        }`:""}\n        \n        /* Apply recommendations background */\n        ${this.settings.recommendationsBackgroundColor?`\n        .cartuplift-recommendations,\n        .cartuplift-recommendations-container {\n          background: ${this.settings.recommendationsBackgroundColor} !important;\n        }`:""}\n        \n        /* Apply button colors with green prevention */\n        .cartuplift-checkout-btn,\n        .cartuplift-discount-apply,\n        .cartuplift-add-recommendation {\n          background: ${n} !important;\n          background-color: ${n} !important;\n          ${this.settings.buttonTextColor?`color: ${this.settings.buttonTextColor} !important;`:"color: white !important;"}\n        }\n        \n        .cartuplift-add-recommendation-circle {\n          border-color: ${n} !important;\n          color: ${n} !important;\n        }\n        \n        .cartuplift-add-recommendation-circle:hover {\n          background: ${n} !important;\n          background-color: ${n} !important;\n          color: ${this.settings.buttonTextColor||"white"} !important;\n        }\n        \n        /* Apply shipping bar colors with green prevention */\n        .cartuplift-shipping-progress-fill {\n          background: ${a} !important;\n          background-color: ${a} !important;\n        }\n        \n        ${this.settings.shippingBarBackgroundColor?`\n        .cartuplift-shipping-progress {\n          background: ${this.settings.shippingBarBackgroundColor} !important;\n          background-color: ${this.settings.shippingBarBackgroundColor} !important;\n        }`:""}\n          \n        /* Hide ONLY Shopify's drawer and notifications when opened - let cart icon work naturally */\n        ${this.settings.enableApp?"\n        /* Hide native Shopify drawer when it opens */\n        cart-drawer[open]:not(#cartuplift-cart-popup),\n        #CartDrawer[open]:not(#cartuplift-cart-popup),\n        details.cart-drawer[open],\n        .drawer--cart[open],\n        cart-drawer-items,\n        .cart-drawer__overlay,\n        .drawer__overlay {\n          display: none !important;\n          visibility: hidden !important;\n          opacity: 0 !important;\n          pointer-events: none !important;\n        }\n        \n        /* Hide add-to-cart notifications only */\n        .cart-notification,\n        cart-notification,\n        .cart-notification-wrapper,\n        .cart-notification-product,\n        .cart__notification,\n        #CartNotification,\n        .ajax-cart-popup,\n        .product__notification,\n        .notification--cart,\n        .product-form__notification,\n        [data-cart-notification],\n        .added-to-cart,\n        .cart-success,\n        .cart-added,\n        .add-to-cart-notification {\n          display: none !important;\n          visibility: hidden !important;\n          opacity: 0 !important;\n          pointer-events: none !important;\n        }":""}\n        \n        /* Professional CSS override for any missed green elements */\n        [style*="color: rgb(76, 175, 80)"],\n        [style*="background: rgb(76, 175, 80)"],\n        [style*="background-color: rgb(76, 175, 80)"],\n        [style*="color: #4CAF50"],\n        [style*="background: #4CAF50"],\n        [style*="background-color: #4CAF50"],\n        [style*="color: #22c55e"],\n        [style*="background: #22c55e"],\n        [style*="background-color: #22c55e"] {\n          color: ${i} !important;\n          background: ${i} !important;\n          background-color: ${i} !important;\n        }\n      `;t.textContent=o,document.getElementById("cartuplift-dynamic-styles")||document.head.appendChild(t)}createDrawer(){let t=document.getElementById("cartuplift-app-container");t||(t=document.createElement("div"),t.id="cartuplift-app-container",t.innerHTML='\n          <div id="cartuplift-backdrop"></div>\n          <div id="cartuplift-cart-popup"></div>\n        ',document.body.appendChild(t));const e=t.querySelector("#cartuplift-cart-popup");e&&(e.innerHTML=this.getDrawerHTML(),e.setAttribute("data-cartuplift-title-caps",this.settings.enableTitleCaps?"true":"false")),this.attachDrawerEvents()}getDrawerHTML(){const t=this.cart?.item_count||0;let e=0,i=0;const n=[];this.cart?.items&&this.cart.items.forEach((t=>{t.properties&&"true"===t.properties._is_gift?(i+=t.original_line_price||t.line_price||t.price*t.quantity,n.push(t)):e+=t.original_line_price||t.line_price||t.price*t.quantity}));const a=this.cart?.cart_level_discount_applications||[],r=a.length>0;let s=0,o=[];r&&a.forEach((t=>{s+=Math.abs(t.total_allocated_amount||0),t.title&&o.push(t.title)}));let c=null;r||(c=this.computeEstimatedDiscount(e),c.hasDiscount&&(s=c.estimatedDiscountCents,o=[c.discountLabel]));const l=s>0,d=Math.max(0,e-s),p=this.cart&&this.cart.items&&this.cart.items.length>0,u=this.settings.enableRecommendations&&p&&(!this._recommendationsLoaded||this.recommendations&&this.recommendations.length>0),h=this.getInlineLinkConfig();return`\n        <div class="cartuplift-drawer${u?" has-recommendations":""}${this.settings.recommendationsScrollWithCart?" recommendations-scroll":" recommendations-fixed"}">\n          ${this.getHeaderHTML(t)}\n          \n          <div class="cartuplift-content-wrapper">\n            <div class="cartuplift-items">\n              <div class="cartuplift-items-list">\n              ${this.getCartItemsHTML()}\n            </div>\n            ${u&&this.settings.recommendationsScrollWithCart?this.getRecommendationsHTML():""}\n            ${this.settings.recommendationsScrollWithCart?(()=>{let t="";if(p){this.settings.enableAddons&&(t+=this.getAddonsHTML());const e=this.getInlineLinkConfig();(e.hasPromoLink||e.hasNotesLink)&&(t+=this.getInlineLinksHTML(e))}return t})():""}\n          </div>\n                      <div class="cartuplift-scrollable-content">\n              ${u&&!this.settings.recommendationsScrollWithCart?this.getRecommendationsHTML():""}\n              ${!this.settings.recommendationsScrollWithCart&&this.settings.enableAddons?this.getAddonsHTML():""}\n              ${this.settings.recommendationsScrollWithCart?"":(()=>p&&(h.hasPromoLink||h.hasNotesLink)?this.getInlineLinksHTML(h):"")()}\n            </div>\n          </div>\n          \n          <div class="cartuplift-footer">\n            ${i>0?`\n            <div class="cartuplift-gift-notice" style="margin-bottom:8px; font-size: 12px; color: #666;">\n              <span>${this.processGiftNoticeTemplate(this.settings.giftNoticeText,i,n)}</span>\n            </div>\n            `:""}\n            ${l?`\n            <div class="cartuplift-subtotal cartuplift-discount-line" style="margin-bottom:8px;">\n              <span>Discount${o.length>0?` (${o.join(", ")})`:""}</span>\n              <span class="cartuplift-subtotal-amount">- ${this.formatMoney(s)}</span>\n            </div>\n            `:""}\n            <div class="cartuplift-subtotal">\n              <span>Subtotal${l?" (after discount)":""}</span>\n              <span class="cartuplift-subtotal-amount">${this.formatMoney(d)}</span>\n            </div>\n            \n            <button class="cartuplift-checkout-btn" onclick="window.cartUpliftDrawer.proceedToCheckout()">\n              ${this.settings.checkoutButtonText||"Checkout"}\n            </button>\n            \n            ${(()=>this.settings.enableExpressCheckout?this.getExpressCheckoutHTML():"")()}\n          </div>\n        </div>\n      `}getHeaderHTML(t){return`\n        <div class="cartuplift-header">\n          <h2 class="cartuplift-cart-title">${this.settings.enableProductTitleCaps?`CART (${t})`:`Cart (${t})`}</h2>\n          \n          <button class="cartuplift-close" aria-label="Close cart">\n            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" style="width: 24px; height: 24px;">\n              <path stroke-linecap="round" stroke-linejoin="round" d="M6 18 18 6M6 6l12 12" />\n            </svg>\n          </button>\n        </div>\n        ${this.getUnifiedProgressHTML()}\n      `}getCartItemsHTML(){if(!this.cart||!this.cart.items||0===this.cart.items.length)return'\n          <div class="cartuplift-empty">\n            <h4>Your cart is empty. Start shopping!</h4>\n            <a href="/" class="cartuplift-empty-cta">Continue Shopping</a>\n          </div>\n        ';let t=[...this.cart.items];this._previewGiftItems&&this._previewGiftItems.length>0&&(t=[...this._previewGiftItems,...this.cart.items]);return t.sort(((t,e)=>{const i=t.properties&&"true"===t.properties._is_gift,n=e.properties&&"true"===e.properties._is_gift;return i&&!n?-1:!i&&n?1:0})).map(((t,e)=>{const i=t.properties&&"true"===t.properties._is_gift,n=t.product_title,a=this.settings.enableProductTitleCaps?n.toUpperCase():n;let r=this.settings.giftPriceText||"FREE";"$0.00"!==r&&"0.00"!==r&&"0"!==r||(r=this.formatMoney(0));const s=i?r:this.formatMoney(t.final_price),o=this._previewGiftItems?.includes(t);let c=0;return o||(c=this.cart.items.findIndex((e=>e.id===t.id||e.variant_id===t.variant_id&&e.key===t.key))+1),`\n        <div class="cartuplift-item${i?" cartuplift-gift-item":""}${o?" cartuplift-preview-item":""}" data-variant-id="${t.variant_id||""}" data-line="${c}">\n          <div class="cartuplift-item-image">\n            <img src="${t.image||"https://cdn.shopify.com/s/files/1/0533/2089/files/placeholder-images-product-1_large.png"}" alt="${t.product_title}" loading="lazy" onerror="this.src='https://cdn.shopify.com/s/files/1/0533/2089/files/placeholder-images-product-1_large.png'">\n          </div>\n          <div class="cartuplift-item-info">\n            <h4 class="cartuplift-item-title">\n              <a href="${t.url}" class="cartuplift-item-link">${a}</a>\n            </h4>\n            ${this.getVariantOptionsHTML(t)}\n            <div class="cartuplift-item-quantity-wrapper">\n              <div class="cartuplift-quantity">\n                <button class="cartuplift-qty-minus" data-line="${c}"${i||o?' style="display:none;"':""}>âˆ’</button>\n                <span class="cartuplift-qty-display">${t.quantity}</span>\n                <button class="cartuplift-qty-plus" data-line="${c}"${i||o?' style="display:none;"':""}>+</button>\n              </div>\n            </div>\n          </div>\n          <div class="cartuplift-item-price-actions">\n            <div class="cartuplift-item-price${i?" cartuplift-gift-price":""}">${s}</div>\n            <button class="cartuplift-item-remove-x" data-line="${c}" aria-label="Remove item"${i||o?' style="display:none;"':""}>\n              <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="size-6">\n                <path stroke-linecap="round" stroke-linejoin="round" d="M3 6h18M9 6V4h6v2m-9 0 1 14h10l1-14H6z"/>\n              </svg>\n            </button>\n          </div>\n        </div>\n      `})).join("")}getGiftProgressHTML(){try{const t=this.settings.giftThresholds?JSON.parse(this.settings.giftThresholds):[];if(0===t.length)return"";const e=t.sort(((t,e)=>t.amount-e.amount)),i=this.cart?this.cart.total_price/100:0,n=this.settings.giftProgressStyle||"single-next";if(1===e.length){const t=e[0],n=Math.min(i/t.amount*100,100),a=(this.settings.shippingBarColor,this.settings.shippingBarBackgroundColor,Math.max(0,Math.round(100*t.amount)-Math.round(100*i)));let r=t.productId;"string"==typeof r&&r.includes("gid://shopify/Product/")&&(r=r.replace("gid://shopify/Product/",""));const s=this.cart?.items?.some((t=>t.product_id.toString()===r.toString()&&t.properties&&"true"===t.properties._is_gift))||!1,o=i>=t.amount,c=this.formatMoney(Math.round(100*t.amount)),l=s?(this.settings.giftAchievedText||"ðŸŽ‰ {{ product_name }} unlocked!").replace(/\{\{\s*title\s*\}\}/g,String(t.title||"Gift")).replace(/\{title\}/g,String(t.title||"Gift")).replace(/\{\{\s*product_name\s*\}\}/g,String(t.title||"Gift")).replace(/\{product_name\}/g,String(t.title||"Gift")).replace(/\{\{\s*product\s*\}\}/g,String(t.title||"Gift")).replace(/\{product\}/g,String(t.title||"Gift")):o?(this.settings.giftReadyText||"Claim your {{ product_name }}!").replace(/\{\{\s*title\s*\}\}/g,String(t.title||"Gift")).replace(/\{title\}/g,String(t.title||"Gift")).replace(/\{\{\s*product_name\s*\}\}/g,String(t.title||"Gift")).replace(/\{product_name\}/g,String(t.title||"Gift")).replace(/\{\{\s*product\s*\}\}/g,String(t.title||"Gift")).replace(/\{product\}/g,String(t.title||"Gift")):(this.settings.giftProgressText||"Spend {{ amount }} more to unlock {{ product_name }}!").replace(/\{\{\s*amount\s*\}\}/g,this.formatMoney(a)).replace(/\{amount\}/g,this.formatMoney(a)).replace(/\{\{\s*title\s*\}\}/g,String(t.title||"Gift")).replace(/\{title\}/g,String(t.title||"Gift")).replace(/\{\{\s*product_name\s*\}\}/g,String(t.title||"Gift")).replace(/\{product_name\}/g,String(t.title||"Gift")).replace(/\{\{\s*product\s*\}\}/g,String(t.title||"Gift")).replace(/\{product\}/g,String(t.title||"Gift"));return`\n            <div class="cartuplift-section cartuplift-section--gift">\n              <div class="cartuplift-progress-section">\n                <div class="cartuplift-progress-bar">\n                  <div class="cartuplift-progress-fill" style="width: ${n>0?Math.max(n,4):0}%;"></div>\n                </div>\n                <div class="cartuplift-progress-info">\n                  ${s?`<span class="cartuplift-success-badge">âœ“ ${String(t.title||"Gift")} unlocked</span>`:`<span class="cartuplift-progress-message">${l}</span>`}\n                  <span class="cartuplift-progress-threshold">${c}</span>\n                </div>\n              </div>\n            </div>\n          `}if("stacked"===n)return`\n            <div class="cartuplift-section cartuplift-section--gift">\n              <div class="cartuplift-section-header">Gift</div>\n              <div class="cartuplift-gift-progress-container">\n                <div class="cartuplift-stacked-progress">\n                  ${e.map((t=>{const e=Math.min(i/t.amount*100,100);let n=t.productId;"string"==typeof n&&n.includes("gid://shopify/Product/")&&(n=n.replace("gid://shopify/Product/",""));const a=this.cart?.items?.some((t=>t.product_id.toString()===n.toString()&&t.properties&&"true"===t.properties._is_gift))||!1,r=i>=t.amount,s=Math.max(t.amount-i,0);return`\n                    <div class="cartuplift-gift-threshold">\n                      <div class="cartuplift-gift-info">\n                        <span class="cartuplift-gift-title">\n                          ${t.title} \n                          ${a?" âœ“ Unlocked":r?" Ready!":` ($${s.toFixed(0)} to go)`}\n                        </span>\n                        <span class="cartuplift-gift-progress-text">${Math.round(e)}%</span>\n                      </div>\n                      <div class="cartuplift-gift-bar">\n                        <div class="cartuplift-gift-fill" style="width: ${e}%; background: ${this.settings.shippingBarColor||"#121212"};"></div>\n                      </div>\n                    </div>\n                  `})).join("")}\n                </div>\n              </div>\n            </div>\n          `;if("single-multi"===n){const t=e[e.length-1].amount;return`\n            <div class="cartuplift-section cartuplift-section--gift">\n              <div class="cartuplift-section-header">Gift</div>\n              <div class="cartuplift-gift-progress-container">\n                <div class="cartuplift-single-multi-progress">\n                  <div class="cartuplift-milestone-bar">\n                    <div class="cartuplift-milestone-fill" style="width: ${Math.min(i/t*100,100)}%; background: ${this.settings.shippingBarColor||"#121212"};"></div>\n                    ${e.map((e=>{const n=e.amount/t*100;let a=e.productId;"string"==typeof a&&a.includes("gid://shopify/Product/")&&(a=a.replace("gid://shopify/Product/",""));const r=this.cart?.items?.some((t=>t.product_id.toString()===a.toString()&&t.properties&&"true"===t.properties._is_gift))||!1,s=i>=e.amount;return`\n                      <div class="cartuplift-milestone-marker" style="left: ${n}%;">\n                        <div class="cartuplift-milestone-dot ${r?"unlocked":""}">\n                          ${r?"âœ“":s?"â˜…":"â—‹"}\n                        </div>\n                        <div class="cartuplift-milestone-label">\n                          $${e.amount} ${e.title}\n                          ${s?r?"":" (Ready to claim!)":` ($${(e.amount-i).toFixed(0)} to go)`}\n                        </div>\n                      </div>\n                    `})).join("")}\n                  </div>\n                </div>\n              </div>\n            </div>\n          `}const a=e.find((t=>i<t.amount)),r=e.filter((t=>{let e=t.productId;return"string"==typeof e&&e.includes("gid://shopify/Product/")&&(e=e.replace("gid://shopify/Product/","")),this.cart?.items?.some((t=>t.product_id.toString()===e.toString()&&t.properties&&"true"===t.properties._is_gift))})),s=e.filter((t=>{const e=i>=t.amount;let n=t.productId;"string"==typeof n&&n.includes("gid://shopify/Product/")&&(n=n.replace("gid://shopify/Product/",""));const a=this.cart?.items?.some((t=>t.product_id.toString()===n.toString()&&t.properties&&"true"===t.properties._is_gift));return e&&!a}));return a||0!==r.length||0!==s.length?`\n          <div class="cartuplift-gift-progress-container">\n            <div class="cartuplift-next-goal-progress">\n              ${r.length>0?`\n                <div class="cartuplift-unlocked-gifts">\n                  ${r.map((t=>`\n                    <div class="cartuplift-unlocked-item">\n                      âœ“ ${t.title} UNLOCKED!\n                    </div>\n                  `)).join("")}\n                </div>\n              `:""}\n              \n              ${s.length>0?`\n                <div class="cartuplift-ready-gifts">\n                  ${s.map((t=>`\n                    <div class="cartuplift-ready-item">\n                      â˜… ${t.title} Ready to claim!\n                    </div>\n                  `)).join("")}\n                </div>\n              `:""}\n              \n              ${a?`\n                <div class="cartuplift-next-goal">\n                  <div class="cartuplift-next-info">\n                    Next: ${a.title} at $${a.amount} \n                    (spend $${(a.amount-i).toFixed(0)} more)\n                  </div>\n                  <div class="cartuplift-next-bar">\n                    <div class="cartuplift-next-fill" style="width: ${Math.min(i/a.amount*100,100)}%; background: ${this.settings.shippingBarColor||"#121212"};"></div>\n                  </div>\n                  <div class="cartuplift-progress-text">\n                    ${Math.round(i/a.amount*100)}% complete\n                  </div>\n                </div>\n              `:""}\n            </div>\n          </div>\n        `:""}catch(t){return e.error("CartUplift: Gift Progress Error:",t),""}}getUnifiedProgressHTML(){try{const t=this.settings.progressBarMode||"free-shipping",e=this.cart?this.cart.total_price:0,i=!!this.settings.enableFreeShipping,n=!!this.settings.enableGiftGating;if(!i&&!n)return"";const a=this.settings.shippingBarColor||"#10b981",r=this.settings.shippingBarBackgroundColor||"#f3f4f6",s=this.settings.freeShippingThresholdCents??this.getFreeShippingThresholdCents(),o=i&&"number"==typeof s?s:null,c="number"==typeof o?Math.max(0,o-e):null,l="number"==typeof o&&e>=o;l&&(this._freeShippingHadUnlocked=!0);let d=[];if(n&&this.settings.giftThresholds)try{d=JSON.parse(this.settings.giftThresholds)||[]}catch{}const p=d.sort(((t,e)=>t.amount-e.amount)),u=t=>{if(!t||!t.productId)return!1;let e=t.productId;return"string"==typeof e&&e.includes("gid://shopify/Product/")&&(e=e.replace("gid://shopify/Product/","")),this.cart?.items?.some((t=>t.product_id.toString()===e.toString()&&t.properties&&"true"===t.properties._is_gift))||!1},h=p.find((t=>e<Math.round(100*t.amount))),m=p.find((t=>{const i=Math.round(100*t.amount);return e>=i&&!u(t)})),f=h||m||null,g=f?Math.round(100*f.amount):null,y=(null!=g&&Math.max(0,g-e),!!f&&(e>=g&&u(f)));let v="",w="",b="",C=0,_=`background:${a};`;const S=t=>this.formatMoney(Math.max(0,t)),k=()=>{if("number"!=typeof o)return"";const t=Math.max(0,o-e);return(this.settings.freeShippingText||"You're {{ amount }} away from free shipping!").replace(/\{\{\s*amount\s*\}\}/g,S(t)).replace(/\{amount\}/g,S(t))};let $=this.settings.freeShippingAchievedText||"âœ“ Free shipping";try{$=String($).replace(/^\s*ðŸŽ‰\s*/i,"").replace(/^\s*congratulations!?\s*/i,"").trim()}catch{}const T=(t,i=!1)=>{if(!t)return"";const n=Math.max(0,Math.round(100*t.amount)-e);let a=this.settings.giftProgressText||"Spend {{ amount }} more to unlock {{ product }}!";if(a.includes("|")){const t=a.split("|").map((t=>t.trim()));a=i?t[1]||t[0]:t[0]||""}return a.replace(/\{\{\s*amount\s*\}\}/g,S(n)).replace(/\{amount\}/g,S(n)).replace(/\{\{\s*title\s*\}\}/g,String(t.title||"reward")).replace(/\{title\}/g,String(t.title||"reward")).replace(/\{\{\s*product_name\s*\}\}/g,String(t.title||"reward")).replace(/\{product_name\}/g,String(t.title||"reward")).replace(/\{\{\s*product\s*\}\}/g,String(t.title||"reward")).replace(/\{product\}/g,String(t.title||"reward"))},M=t=>(this.settings.giftAchievedText||"âœ“ {{ product_name }} unlocked!").replace(/\{\{\s*title\s*\}\}/g,String(t?.title||"reward")).replace(/\{title\}/g,String(t?.title||"reward")).replace(/\{\{\s*product_name\s*\}\}/g,String(t?.title||"reward")).replace(/\{product_name\}/g,String(t?.title||"reward")).replace(/\{\{\s*product\s*\}\}/g,String(t?.title||"reward")).replace(/\{product\}/g,String(t?.title||"reward"));if("free-shipping"===t||"gift-gating"!==t&&0===d.length){if(!i||"number"!=typeof o||o<=0)return"";if(C=Math.min(100,e/o*100),v="",l)b=`<div class="cartuplift-progress-toprow"><span class="cartuplift-success-badge">${$}</span></div>`,w="";else if(this._freeShippingHadUnlocked&&c>0){const t=this.settings.freeShippingMaintainText||"Keep above {threshold} for free shipping";b=`<div class="cartuplift-progress-toprow"><span class="cartuplift-progress-message">${t.replace(/\{\{\s*threshold\s*\}\}/g,S(o)).replace(/\{threshold\}/g,S(o))}</span></div>`,w=""}else b=`<div class="cartuplift-progress-toprow"><span class="cartuplift-progress-message">${k()}</span></div>`,w=""}else if("gift-gating"===t&&n)if(f){C=Math.min(100,e/g*100),v="";const t=e>=g;y?(b=`<div class="cartuplift-progress-toprow"><span class="cartuplift-success-badge">${M(f)}</span></div>`,w=""):t?(b=`<div class="cartuplift-progress-toprow"><span class="cartuplift-progress-message">${T(f,!0)}</span></div>`,w=""):(b=`<div class="cartuplift-progress-toprow"><span class="cartuplift-progress-message">${T(f,!1)}</span></div>`,w="")}else{const t=p[p.length-1];if(t&&u(t))b=`<div class="cartuplift-progress-toprow"><span class="cartuplift-success-badge">${M(t)}</span></div>`,C=100;else{b=`<div class="cartuplift-progress-toprow"><span class="cartuplift-progress-message">${t?T(t,!0):"Gift ready to claim!"}</span></div>`,C=100}v="",w=""}else if(l){const t=p.every((t=>u(t)));if(!f&&t)C=100,v="",b='<div class="cartuplift-progress-toprow"><span class="cartuplift-success-badge">ðŸŽ‰ All rewards unlocked!</span></div>',w="";else if(f){if(e>=g){b=`<div class="cartuplift-progress-toprow"><span class="cartuplift-success-badge">${this.settings.allRewardsUnlockedText||"ðŸŽ‰ All rewards unlocked!"}</span></div>`,C=100,v="",w=""}else{b=`<div class="cartuplift-progress-toprow" style="display: flex; justify-content: space-between; gap: 8px;"><span class="cartuplift-progress-message" style="text-align: left;">${"âœ“ Free shipping unlocked!"}</span><span class="cartuplift-progress-message" style="text-align: right;">${T(f,!1)}</span></div>`,C=Math.min(100,e/g*100),v="",_=`background: ${a};`,w=""}}else{const t=p.find((t=>!u(t)));if(t){b=`<div class="cartuplift-progress-toprow"><span class="cartuplift-progress-message">âœ“ Free shipping unlocked! ${T(t,!0)}</span></div>`}else b='<div class="cartuplift-progress-toprow"><span class="cartuplift-success-badge">ðŸŽ‰ All rewards unlocked!</span></div>';C=100,v="",w=""}}else{C="number"==typeof o&&o>0?Math.min(100,e/o*100):0,v="";b=`<div class="cartuplift-progress-toprow"><span class="cartuplift-progress-message">${k()}</span></div>`,w=""}return`\n          <div class="cartuplift-progress-section">\n            ${b}\n            ${(()=>{const n=[];if("gift-gating"!==t&&i&&"number"==typeof o&&o>0&&n.push({type:"shipping",amount:o,label:"Free Shipping"}),"free-shipping"!==t)for(const t of p)if(t.amount&&t.amount>0){const e=Math.round(100*t.amount);n.push({type:"gift",amount:e,label:t.title||"Gift",data:t})}if(n.sort(((t,e)=>t.amount-e.amount)),0===n.length)return'<div class="cartuplift-progress-bar"><div class="cartuplift-progress-fill" style="width:0%;"></div></div>';if(1===n.length){const t=n[0],i=Math.min(100,e/t.amount*100),s="shipping"===t.type?a:this.settings.giftBarColor||"#f59e0b";return`\n              <div class="cartuplift-progress-bar" style="background: ${r}; border-radius: 4px; height: 7px;">\n                <div class="cartuplift-progress-fill" style="width: ${i}%; background: ${s}; height: 100%; border-radius: 3px; transition: width 0.5s ease;"></div>\n              </div>\n            `}const s=n[n.length-1].amount;let c="",l="",d=0;for(let t=0;t<n.length;t++){const i=n[t],r=(i.amount-d)/s*100,o=e>=i.amount,p=!o&&(0===t||e>=n[t-1].amount);let u=0;if(o)u=100;else if(p){const a=t>0?n[t-1].amount:0,r=i.amount-a,s=Math.max(0,e-a);u=Math.min(100,s/r*100)}const h="shipping"===i.type?a:this.settings.giftBarColor||"#f59e0b",m=o?"cartuplift-segment-completed":"",f=p?"cartuplift-segment-current":"",g=o||p?"":"cartuplift-segment-locked";c+=`\n              <div class="cartuplift-progress-segment ${m} ${f} ${g}" style="width: ${r}%; ${g?"":`border-color: ${h};`}">\n                <div class="cartuplift-segment-fill" style="width: ${u}%; background: ${h};"></div>\n              </div>\n            `;l+=`\n              <div class="cartuplift-segment-label ${m} ${f} ${g}" style="width: ${r}%;">\n                <div class="cartuplift-segment-label-amount" style="${g?"":`color: ${h};`}">${S(i.amount)}</div>\n              </div>\n            `,d=i.amount}return`\n            <div class="cartuplift-segmented-bar-container">\n              <div class="cartuplift-progress-bar cartuplift-segmented-bar">${c}</div>\n              <div class="cartuplift-segmented-labels">${l}</div>\n            </div>\n          `})()}\n            <div class="cartuplift-progress-info">\n              ${w}\n              <span class="cartuplift-progress-threshold">${v}</span>\n            </div>\n          </div>\n        `}catch(t){return e.error("CartUplift: Unified Progress Error:",t),""}}getMobileProgressHTML(){try{const t=this.cart?this.cart.total_price:0;this.settings.shippingBarColor,this.settings.shippingBarBackgroundColor;let e=0,i="",n="",a=!1;const r=this.settings.freeShippingThresholdCents??this.getFreeShippingThresholdCents(),s=!!this.settings.enableFreeShipping&&"number"==typeof r,o=s?r:null,c="number"==typeof o?Math.max(0,o-t):null,l="number"==typeof o&&t>=o;let d=[];if(this.settings.enableGiftGating&&this.settings.giftThresholds)try{d=JSON.parse(this.settings.giftThresholds).sort(((t,e)=>t.amount-e.amount))}catch{}const p=d.length?d.find((e=>t<Math.round(100*e.amount))):null;if((l||!s)&&(!d.length||!p)&&(s||d.length)){e=100,n="",a=!0;const t=d.length?d[d.length-1]:null;if(t){const e="number"==typeof t.price?t.price:t.price?.amount?Math.round(100*t.price.amount):null,n=null!=e?this.formatMoney(e):"",a="free gift";i=this.settings.combinedSuccessTemplate||this.settings.allRewardsAchievedText||"âœ“ Free shipping + free gift added free",/All rewards unlocked!?/i.test(i)&&(i=i.replace(/All rewards unlocked!?/gi,"").trim()),/free shipping/i.test(i)||(i=`âœ“ Free shipping + ${i.replace(/^âœ“\s*/,"")}`),/^âœ“/.test(i)||(i=`âœ“ ${i}`),i=i.replace(/\{\{\s*title\s*\}\}/g,a).replace(/\{title\}/g,a).replace(/\{\{\s*product_name\s*\}\}/g,a).replace(/\{product_name\}/g,a).replace(/\{\{\s*product\s*\}\}/g,a).replace(/\{product\}/g,a).replace(/\{\{\s*value\s*\}\}/g,n).replace(/\{value\}/g,n).replace(/\bworth\s+\(/i,"(").replace(/\{\{?\s*(title|value|product_name|product)\s*\}?\}/g,"").replace(/\s{2,}/g," ").replace(/\(\s*\)/g,"").replace(/\s*!/g,"!").trim()}else i=this.settings.allRewardsAchievedText&&/free shipping/i.test(this.settings.allRewardsAchievedText)?this.settings.allRewardsAchievedText:"âœ“ Free shipping unlocked!"}else if(s&&!l){const r=o,s=c;e=Math.min(t/r*100,100),n=this.formatMoney(r),i=(this.settings.freeShippingText||"{{ amount }} more for free shipping!").replace(/\{\{\s*amount\s*\}\}/g,this.formatMoney(s)).replace(/\{amount\}/g,this.formatMoney(s)),a=!0}else if(d.length){const r=p||d[0],s=Math.round(100*r.amount),o=Math.max(0,s-t);e=Math.min(t/s*100,100),n=this.formatMoney(s);i=0===o&&t>=s?(this.settings.giftAchievedText||"ðŸŽ‰ Free gift unlocked!").replace(/\{\{\s*title\s*\}\}/g,"Free gift").replace(/\{title\}/g,"Free gift").replace(/\{\{\s*product_name\s*\}\}/g,"Free gift").replace(/\{product_name\}/g,"Free gift").replace(/\{\{\s*product\s*\}\}/g,"Free gift").replace(/\{product\}/g,"Free gift"):(this.settings.giftProgressText||"Free shipping unlocked! âœ“ Spend {{ amount }} more for free gift!").replace(/\{\{\s*amount\s*\}\}/g,this.formatMoney(o)).replace(/\{amount\}/g,this.formatMoney(o)).replace(/\{\{\s*title\s*\}\}/g,"free gift").replace(/\{title\}/g,"free gift").replace(/\{\{\s*product_name\s*\}\}/g,"free gift").replace(/\{product_name\}/g,"free gift").replace(/\{\{\s*product\s*\}\}/g,"free gift").replace(/\{product\}/g,"free gift"),a=!0}return a?`\n          <div class="cartuplift-mobile-progress" role="region" aria-live="polite">\n            <div class="cartuplift-mobile-progress-inner">\n              <div class="cartuplift-progress-section">\n                <div class="cartuplift-progress-bar">\n                  <div class="cartuplift-progress-fill" style="width:${e>0?Math.max(e,4):0}%;"></div>\n                </div>\n                <div class="cartuplift-progress-info">\n                  <span class="cartuplift-progress-message">${i.replace(/\$?([0-9]+(?:\.[0-9]{2})?)/,'<span class=\\"cartuplift-mobile-amount\\">$$1</span>')}</span>\n                  <span class="cartuplift-progress-threshold">${n}</span>\n                </div>\n              </div>\n            </div>\n          </div>\n        `:""}catch{return""}}getFreeShippingProgressHTML(){const t=this.cart?this.cart.total_price:0,e=this.settings.freeShippingThresholdCents??this.getFreeShippingThresholdCents(),i=Number(this.settings.freeShippingThreshold)||100,n=Math.max(0,Math.round(100*i)),a="number"==typeof e&&e>0?e:n>0?n:1e4,r=a>0?Math.min(t/a*100,100):0,s=(this.settings.shippingBarColor,this.settings.shippingBarBackgroundColor,Math.max(0,a-t)),o=a>0&&t>=a,c=this.formatMoney(a);let l=o?this.settings.freeShippingAchievedText||"âœ“ Free shipping":(this.settings.freeShippingText||"Spend {{ amount }} more for free shipping!").replace(/\{\{\s*amount\s*\}\}/g,this.formatMoney(s)).replace(/\{amount\}/g,this.formatMoney(s));if(o)try{l=String(l).replace(/^\s*ðŸŽ‰\s*/i,"").replace(/^\s*congratulations!?\s*/i,"").trim()}catch{}return`\n        <div class="cartuplift-section cartuplift-section--free-shipping">\n          <div class="cartuplift-progress-section">\n            <div class="cartuplift-progress-bar">\n              <div class="cartuplift-progress-fill" style="width: ${r>0?Math.max(r,4):0}%;"></div>\n            </div>\n            <div class="cartuplift-progress-info">\n              ${o?`<span class="cartuplift-success-badge">${l||"âœ“ Free shipping"}</span>`:`<span class="cartuplift-progress-message">${l}</span>`}\n              <span class="cartuplift-progress-threshold">${c}</span>\n            </div>\n          </div>\n        </div>\n      `}getCombinedProgressHTML(){return this.getUnifiedProgressHTML()}renderStackedProgress(t,e){return`\n        <div class="cartuplift-gift-progress-container">\n          <div class="cartuplift-stacked-progress">\n            ${t.map((t=>{const i=Math.min(e/t.amount*100,100),n=e>=t.amount;return`\n          <div class="cartuplift-gift-threshold">\n            <div class="cartuplift-gift-info">\n              <span class="cartuplift-gift-title">\n                ${t.title} ${n?"âœ“":`($${t.amount})`}\n              </span>\n              <span class="cartuplift-gift-progress-text">${Math.round(i)}%</span>\n            </div>\n            <div class="cartuplift-gift-bar">\n              <div class="cartuplift-gift-fill" style="width: ${i}%; background: ${n&&this.themeColors.primary||"#121212"};"></div>\n            </div>\n          </div>\n        `})).join("")}\n          </div>\n        </div>\n      `}renderSingleMultiProgress(t,e){const i=Math.max(...t.map((t=>t.amount))),n=Math.min(e/i*100,100),a=t.map((t=>{const n=t.amount/i*100,a=e>=t.amount;return`\n          <div class="cartuplift-milestone-marker" style="left: ${n}%;">\n            <div class="cartuplift-milestone-dot ${a?"unlocked":""}">\n              ${a?"âœ“":"$"}\n            </div>\n            <div class="cartuplift-milestone-label">${t.title}</div>\n          </div>\n        `})).join("");return`\n        <div class="cartuplift-gift-progress-container">\n          <div class="cartuplift-single-multi-progress">\n            <div class="cartuplift-milestone-bar">\n              <div class="cartuplift-milestone-fill" style="width: ${n}%; background: ${this.themeColors.primary||"#121212"};"></div>\n              ${a}\n            </div>\n          </div>\n        </div>\n      `}renderSingleNextProgress(t,e){const i=t.filter((t=>e>=t.amount)),n=t.find((t=>e<t.amount));let a="";return i.length>0&&(a=`\n          <div class="cartuplift-unlocked-gifts">\n            ${i.map((t=>`\n              <div class="cartuplift-unlocked-item">âœ“ ${t.title} unlocked!</div>\n            `)).join("")}\n          </div>\n        `),`\n        <div class="cartuplift-gift-progress-container">\n          <div class="cartuplift-next-goal-progress">\n            ${a}\n            ${n?`\n              <div class="cartuplift-next-goal">\n                <div class="cartuplift-next-info">\n                  Next: ${n.title} \n                  (spend $${(n.amount-e).toFixed(0)} more)\n                </div>\n                <div class="cartuplift-next-bar">\n                  <div class="cartuplift-next-fill" style="width: ${Math.min(e/n.amount*100,100)}%; background: ${this.themeColors.primary||"#121212"};"></div>\n                </div>\n                <div class="cartuplift-progress-text">\n                  ${Math.round(e/n.amount*100)}% complete\n                </div>\n              </div>\n            `:""}\n          </div>\n        </div>\n      `}getRecommendationsHTML(){const t=this.settings.recommendationLayout||"column",e={horizontal:"row",row:"row",carousel:"row",vertical:"column",column:"column",list:"column",grid:"grid"}[t]||t,i=this.settings.recommendationsTitle||"Hand picked for you",n=`\n        <div class="cartuplift-carousel-controls">\n          <button class="cartuplift-carousel-nav prev" data-nav="prev" aria-label="Previous">\n            <svg width="16" height="16" viewBox="0 0 16 16" fill="none" stroke="currentColor" stroke-width="2">\n              <path d="M10 12l-4-4 4-4"/>\n            </svg>\n          </button>\n          <button class="cartuplift-carousel-nav next" data-nav="next" aria-label="Next">\n            <svg width="16" height="16" viewBox="0 0 16 16" fill="none" stroke="currentColor" stroke-width="2">\n              <path d="M6 12l4-4-4-4"/>\n            </svg>\n          </button>\n          <div class="cartuplift-carousel-dots">\n            ${this.recommendations.map(((t,e)=>`\n              <button type="button" class="cartuplift-carousel-dot${0===e?" active":""}"\n                data-index="${e}"\n                aria-label="Go to slide ${e+1}"\n                aria-current="${0===e?"true":"false"}"></button>\n            `)).join("")}\n          </div>\n        </div>`;return`\n        <div class="cartuplift-recommendations cartuplift-recommendations-${e}${"row"===e?" cartuplift-recommendations-row":""}${"grid"===e?" cartuplift-recommendations-grid":""}">\n          <div class="cartuplift-recommendations-header">\n            <h3 class="cartuplift-recommendations-title">${i}</h3>\n            <button type="button" class="cartuplift-recommendations-toggle" data-toggle="recommendations" aria-expanded="true" aria-controls="cartuplift-recommendations-content" aria-label="Toggle recommendations">\n              <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">\n                <path stroke-linecap="round" stroke-linejoin="round" d="m4.5 15.75 7.5-7.5 7.5 7.5" />\n              </svg>\n            </button>\n          </div>\n          <div class="cartuplift-recommendations-content" id="cartuplift-recommendations-content" aria-hidden="false">\n            ${this.getRecommendationItems()}\n          </div>\n          ${"row"===e?n:""}\n        </div>\n      `}updateRecommendationsSection(){const t=document.querySelector(".cartuplift-recommendations");if(!t)return this.settings.enableRecommendations&&this._recommendationsLoaded&&this.recommendations.length>0?void this.updateDrawerContent():void 0;const e=this.settings.recommendationLayout||"column",i={horizontal:"row",row:"row",carousel:"row",vertical:"column",column:"column",list:"column",grid:"grid"}[e]||e;t.className=`cartuplift-recommendations cartuplift-recommendations-${i}${"row"===i?" cartuplift-recommendations-row":""}${"grid"===i?" cartuplift-recommendations-grid":""}`;const n=t.querySelector(".cartuplift-recommendations-title");n&&(n.textContent=this.settings.recommendationsTitle||"Hand picked for you");const a=t.querySelector(".cartuplift-recommendations-content");a&&(a.innerHTML=this.getRecommendationItems(),"row"===i&&setTimeout((()=>{this.setupScrollControls(a),this.updateCarouselButtons(a),this.updateDots(a)}),100),"grid"===i&&setTimeout((()=>{this.attachGridHoverHandlers()}),50))}debouncedUpdateRecommendations(){this._updateDebounceTimer&&clearTimeout(this._updateDebounceTimer),this._updateDebounceTimer=setTimeout((()=>{this.rebuildRecommendationsFromMaster(),this._updateDebounceTimer=null}),150)}rebuildRecommendationsFromMaster(){this._allRecommendations.length&&(this._rebuildInProgress||(this._rebuildInProgress=!0,requestAnimationFrame((()=>{if(this.settings.hideRecommendationsAfterThreshold&&this.checkIfAllThresholdsMet())return this.recommendations=[],void(this._rebuildInProgress=!1);const t=(this.cart?.items||[]).map((t=>t.product_id)),e=this.normalizeMaxRecommendations(this.settings.maxRecommendations);let i=[];for(const n of this._allRecommendations){const a=t.includes(n.id),r=t.some((t=>t===n.id));if(!a&&!r&&(i.push(n),i.length>=e))break}this.settings.enableThresholdBasedSuggestions&&(i=this.filterRecommendationsForThreshold(i));const n=(this.recommendations||[]).map((t=>t.id)).sort(),a=i.map((t=>t.id)).sort();JSON.stringify(n)!==JSON.stringify(a)&&(this.recommendations=i),this._rebuildInProgress=!1}))))}rebuildRecommendationsFromMasterSync(){if(!this._allRecommendations.length)return;if(this._rebuildInProgress)return;if(this.settings.hideRecommendationsAfterThreshold&&this.checkIfAllThresholdsMet())return void(this.recommendations=[]);const t=(this.cart?.items||[]).map((t=>t.product_id)),e=this.normalizeMaxRecommendations(this.settings.maxRecommendations);let i=[];for(const n of this._allRecommendations){const a=t.includes(n.id),r=t.some((t=>t===n.id));if(!a&&!r&&(i.push(n),i.length>=e))break}this.settings.enableThresholdBasedSuggestions&&(i=this.filterRecommendationsForThreshold(i));const n=(this.recommendations||[]).map((t=>t.id)).sort(),a=i.map((t=>t.id)).sort();JSON.stringify(n)!==JSON.stringify(a)&&(this.recommendations=i)}getRecommendationItems(){if(!this._recommendationsLoaded)return"";if(!this.recommendations||0===this.recommendations.length)return"";const t=this.settings.recommendationLayout||"row",e={horizontal:"row",row:"row",carousel:"row",vertical:"column",column:"column",list:"column",grid:"grid"}[t]||t;return"row"===e?`\n          <div class="cartuplift-recommendations-track">\n            ${this.recommendations.map((t=>{const e=this.formatProductReview(t);return`\n              <div class="cartuplift-recommendation-card">\n                <div class="cartuplift-card-content">\n                  <div class="cartuplift-product-image">\n                    <img src="${t.image||"https://cdn.shopify.com/s/files/1/0533/2089/files/placeholder-images-product-1_large.png"}" alt="${t.title}" loading="lazy" onerror="this.src='https://cdn.shopify.com/s/files/1/0533/2089/files/placeholder-images-product-1_large.png'">\n                  </div>\n                  <div class="cartuplift-product-info">\n                    <h4 class="cartuplift-product-title"><a href="${t.url}" class="cartuplift-product-link">${this.settings.enableRecommendationTitleCaps?t.title.toUpperCase():t.title}</a></h4>\n                    ${e?`<div class="cartuplift-product-review">${e}</div>`:""}\n                    ${this.generateVariantSelector(t)}\n                  </div>\n                  <div class="cartuplift-product-actions">\n                    <div class="cartuplift-recommendation-price">${this.formatMoney(t.priceCents||0)}</div>\n                    <button class="cartuplift-add-recommendation" data-product-id="${t.id}" data-variant-id="${t.variant_id}">\n                      ${this.settings.addButtonText||"Add"}\n                    </button>\n                  </div>\n                </div>\n              </div>\n            `})).join("")}\n          </div>\n        `:"grid"===e?this.generateDynamicGrid():this.recommendations.map((t=>{const e=this.formatProductReview(t);return`\n          <div class="cartuplift-recommendation-item">\n            <img src="${t.image||"https://cdn.shopify.com/s/files/1/0533/2089/files/placeholder-images-product-1_large.png"}" alt="${t.title}" loading="lazy" onerror="this.src='https://cdn.shopify.com/s/files/1/0533/2089/files/placeholder-images-product-1_large.png'">\n            <div class="cartuplift-recommendation-info">\n              <h4><a href="${t.url}" class="cartuplift-product-link">${this.settings.enableRecommendationTitleCaps?t.title.toUpperCase():t.title}</a></h4>\n              ${e?`<div class="cartuplift-product-review">${e}</div>`:""}\n              <div class="cartuplift-recommendation-price">${this.formatMoney(t.priceCents||0)}</div>\n            </div>\n            <button class="cartuplift-add-recommendation-circle" data-product-id="${t.id}" data-variant-id="${t.variant_id}">\n              +\n            </button>\n          </div>\n        `})).join("")}generateDynamicGrid(){if(!this.recommendations||0===this.recommendations.length)return"";const t=window.innerWidth<=768,e=this.normalizeMaxRecommendations(this.settings.maxRecommendations),i=Math.min(this.recommendations.length,e);let n,a=!0;n=Math.min(3,i),a=i<=n;const r=this.recommendations.slice(0,n);this._recommendationPool=this.recommendations.slice(0,e),this._visibleRecommendations=[...r],this._nextRecommendationIndex=Math.min(e,n);const s=`\n\n        <div class="cartuplift-grid-container${a?" collapsed":""}" \n             data-original-title="${(this.settings.recommendationsTitle||"Hand picked for you").replace(/"/g,"&quot;")}"\n             data-mode="${a?"collapsed":"standard"}"\n             data-mobile="${t}"\n             data-cartuplift-title-caps="${this.settings.enableTitleCaps?"true":"false"}">\n          ${r.map(((t,e)=>{const i=t.title||"",n=(this.settings.enableRecommendationTitleCaps?i.toUpperCase():i).replace(/"/g,"&quot;"),a=i.replace(/"/g,"&quot;"),r=i.replace(/"/g,"");return`\n            <div class="cartuplift-grid-item" \n                 data-product-id="${t.id}" \n                 data-product-handle="${t.handle||""}"\n                 data-variant-id="${t.variant_id}" \n                 data-title="${n}" \n                 data-price="${this.formatMoney(t.priceCents||0)}"\n                 data-grid-index="${e}">\n              <div class="cartuplift-grid-image">\n                <img src="${t.image||"https://cdn.shopify.com/s/files/1/0533/2089/files/placeholder-images-product-1_large.png"}" \n                     alt="${a}" \n                     loading="lazy" \n                     decoding="async" \n                     onerror="this.src='https://cdn.shopify.com/s/files/1/0533/2089/files/placeholder-images-product-1_large.png'">\n                <div class="cartuplift-grid-hover">\n                  <button class="cartuplift-grid-add-btn"\n                          data-product-id="${t.id}"\n                          data-variant-id="${t.variant_id}"\n                          data-grid-index="${e}"\n                          aria-label="Add ${r}">\n                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="size-6">\n                      <path stroke-linecap="round" stroke-linejoin="round" d="M15.75 10.5V6a3.75 3.75 0 1 0-7.5 0v4.5m11.356-1.993 1.263 12c.07.665-.45 1.243-1.119 1.243H4.25a1.125 1.125 0 0 1-1.12-1.243l1.264-12A1.125 1.125 0 0 1 5.513 7.5h12.974c.576 0 1.059.435 1.119 1.007ZM8.625 10.5a.375.375 0 1 1-.75 0 .375.375 0 0 1 .75 0Zm7.5 0a.375.375 0 1 1-.75 0 .375.375 0 0 1 .75 0Z" />\n                    </svg>\n                  </button>\n                </div>\n              </div>\n            </div>`})).join("")}\n        </div>\n      `;return setTimeout((()=>{this.attachGridHoverHandlers(),this.setupDynamicGridHandlers(),t&&this.setupMobileGridScroll()}),10),s}setupDynamicGridHandlers(){}swapInNextRecommendation(t){if(this._nextRecommendationIndex<this._recommendationPool.length){const e=this._recommendationPool[this._nextRecommendationIndex];this._visibleRecommendations[t]=e,this._nextRecommendationIndex++,this.updateGridItem(t,e)}}revertRecommendation(t,e){e<this._visibleRecommendations.length&&(this._visibleRecommendations[e]=t,this.updateGridItem(e,t))}updateGridItem(t,e){const i=document.querySelector(`.cartuplift-grid-item[data-grid-index="${t}"]`);if(i){const t=e.title||"",n=(this.settings.enableRecommendationTitleCaps?t.toUpperCase():t).replace(/"/g,"&quot;"),a=t.replace(/"/g,"&quot;"),r=t.replace(/"/g,"");i.dataset.productId=e.id,i.dataset.variantId=e.variant_id,i.dataset.title=n,i.dataset.price=this.formatMoney(e.priceCents||0);const s=i.querySelector("img");s&&(s.src=e.image||"https://cdn.shopify.com/s/files/1/0533/2089/files/placeholder-images-product-1_large.png",s.alt=a);const o=i.querySelector(".cartuplift-grid-add-btn");o&&(o.dataset.variantId=e.variant_id,o.setAttribute("aria-label",`Add ${r}`))}}setupMobileGridScroll(){const t=document.querySelector(".cartuplift-grid-container");t&&(t.style.scrollBehavior="smooth",t.style.webkitOverflowScrolling="touch")}generateVariantSelector(t){if(t.variants&&t.variants.length>1){let e=-1;const i=t.variants.filter(((t,i)=>(t.available&&-1===e&&(e=i),t.available)));return`\n          <div class="cartuplift-product-variation">\n            <select class="cartuplift-size-dropdown" data-product-id="${t.id}">\n              ${i.map(((t,e)=>`\n                <option value="${t.id}" data-price-cents="${t.price_cents}" ${0===e?"selected":""}>\n                  ${t.title}\n                </option>\n              `)).join("")}\n            </select>\n          </div>\n        `}return'<div class="cartuplift-product-variation hidden"></div>'}refreshRecommendationLayout(){const t=document.querySelector(".cartuplift-recommendations-content");if(t&&this._recommendationsLoaded){t.innerHTML=this.getRecommendationItems();const i=document.querySelector(".cartuplift-recommendations");if(i){const t={horizontal:"row",vertical:"column",grid:"grid",carousel:"row",list:"column"},n=this.settings.recommendationLayout||"column",a=t[n]||n;if(i.classList.remove("cartuplift-recommendations-row","cartuplift-recommendations-column","cartuplift-recommendations-grid"),i.classList.add(`cartuplift-recommendations-${a}`),"row"===a&&i.classList.add("cartuplift-recommendations-row"),"grid"===a&&this.attachGridHoverHandlers(),"grid"===a&&i.classList.add("cartuplift-recommendations-grid"),"row"===a){const t=document.querySelector(".cartuplift-recommendations");if(t&&!t.querySelector(".cartuplift-carousel-controls")){const e=document.createElement("div");e.className="cartuplift-carousel-controls",e.innerHTML=`\n                <button class="cartuplift-carousel-nav prev" data-nav="prev" aria-label="Previous">\n                  <svg width="16" height="16" viewBox="0 0 16 16" fill="none" stroke="currentColor" stroke-width="2">\n                    <path d="M10 12l-4-4 4-4"/>\n                  </svg>\n                </button>\n                <button class="cartuplift-carousel-nav next" data-nav="next" aria-label="Next">\n                  <svg width="16" height="16" viewBox="0 0 16 16" fill="none" stroke="currentColor" stroke-width="2">\n                    <path d="M6 12l4-4-4-4"/>\n                  </svg>\n                </button>\n                <div class="cartuplift-carousel-dots">\n                  ${this.recommendations.map(((t,e)=>`\n                    <button type="button" class="cartuplift-carousel-dot${0===e?" active":""}"\n                      data-index="${e}"\n                      aria-label="Go to slide ${e+1}"\n                      aria-current="${0===e?"true":"false"}"></button>\n                  `)).join("")}\n                </div>`,t.appendChild(e)}setTimeout((()=>{const t=document.querySelector(".cartuplift-recommendations-content");t?(this.setupScrollControls(t),this.updateCarouselButtons(t),t.addEventListener("scroll",(()=>{this.updateCarouselButtons(t),this.updateDots(t)}))):e.log("[CartUplift] ERROR: Scroll container not found")}),100)}}}}getCartIconSVG(){switch(this.settings.cartIcon||"cart"){case"bag":return'<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><path d="M6 8V7a6 6 0 0 1 12 0v1"/><path d="M6 8h12l1 13H5L6 8Z"/></svg>';case"basket":return'<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><path d="M5 11h14l-1.5 8h-11L5 11Z"/><path d="M9 11V7a3 3 0 0 1 6 0v4"/></svg>';default:return'<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><path d="M6 6h15l-1.5 12.5a2 2 0 0 1-2 1.5H8a2 2 0 0 1-2-1.5L4.5 6H20"/><path d="M9 6V4a2 2 0 0 1 2-2h2a2 2 0 0 1 2 2v2"/></svg>'}}attachGridHoverHandlers(){const t=document.querySelector(".cartuplift-grid-container");if(!t)return;const e=document.querySelector(".cartuplift-recommendations-title"),i=document.querySelector(".cartuplift-recommendations-toggle");if(!e||!i)return;const n=t.getAttribute("data-original-title")||e.textContent;this._originalRecommendationsTitle=n;let a=document.querySelector(".cartuplift-hover-price");a||(a=document.createElement("span"),a.className="cartuplift-hover-price",a.style.cssText="font-weight: 500; color: #333; display: none;",i.parentNode.insertBefore(a,i.nextSibling)),t.querySelectorAll(".cartuplift-grid-item").forEach((t=>{t.addEventListener("mouseenter",(()=>{let n=t.getAttribute("data-title");const r=t.getAttribute("data-price");n&&this.settings.enableRecommendationTitleCaps&&(n=n.toUpperCase()),n&&e&&(e.textContent=n),r&&a&&(a.textContent=r,a.style.display="inline"),i.classList.add("cartuplift-toggle-hidden")}))})),t.addEventListener("mouseleave",(()=>{e.textContent=this._originalRecommendationsTitle,a&&(a.style.display="none"),i.classList.remove("cartuplift-toggle-hidden")}))}setupScrollControls(t){const e=window.innerWidth<=768;this.scrollAmount=e?t.clientWidth:346;const i=document.querySelector(".cartuplift-carousel-nav.prev"),n=document.querySelector(".cartuplift-carousel-nav.next");i&&n&&(i.addEventListener("click",(()=>this.scrollPrev(t))),n.addEventListener("click",(()=>this.scrollNext(t))));document.querySelectorAll(".cartuplift-carousel-dot").forEach(((e,i)=>{e.addEventListener("click",(()=>this.scrollToIndex(t,i))),e.addEventListener("keydown",(e=>{"Enter"!==e.key&&" "!==e.key||(e.preventDefault(),this.scrollToIndex(t,i))}))})),e&&this.setupTouchEvents(t)}setupTouchEvents(t){let e=0,i=0,n=!1;t.addEventListener("touchstart",(a=>{n=!0,e=a.touches[0].pageX-t.offsetLeft,i=t.scrollLeft})),t.addEventListener("touchend",(()=>{n=!1})),t.addEventListener("touchmove",(a=>{if(!n)return;a.preventDefault();const r=2*(a.touches[0].pageX-t.offsetLeft-e);t.scrollLeft=i-r}))}scrollToIndex(t,e){if(!t)return;const i=t.querySelectorAll(".cartuplift-recommendation-card, .cartuplift-recommendation-item");if(!i||e>=i.length)return;const n=i[e];if(!n)return;const a=t.getBoundingClientRect(),r=n.getBoundingClientRect(),s=t.scrollLeft+(r.left-a.left)-(a.width-r.width)/2;t.scrollTo({left:Math.max(0,s),behavior:"smooth"})}scrollPrev(t){if(!t)return;const e=this.getCurrentCardIndex(t);e>0&&this.scrollToIndex(t,e-1)}scrollNext(t){if(!t)return;const e=t.querySelectorAll(".cartuplift-recommendation-card, .cartuplift-recommendation-item"),i=this.getCurrentCardIndex(t);i<e.length-1&&this.scrollToIndex(t,i+1)}getCurrentCardIndex(t){const e=t.querySelectorAll(".cartuplift-recommendation-card, .cartuplift-recommendation-item"),i=t.getBoundingClientRect(),n=i.left+i.width/2;let a=0,r=1/0;return e.forEach(((t,e)=>{const i=t.getBoundingClientRect(),s=i.left+i.width/2,o=Math.abs(s-n);o<r&&(r=o,a=e)})),a}updateCarouselButtons(t){if(!t)return void e.log("[CartUplift] updateCarouselButtons: No scroll container");const i=document.querySelector(".cartuplift-carousel-nav.prev"),n=document.querySelector(".cartuplift-carousel-nav.next");if(!i||!n)return void e.log("[CartUplift] Navigation buttons not found:",{prevBtn:i,nextBtn:n});const a=t.scrollLeft,r=t.scrollWidth-t.clientWidth,s=document.querySelector(".cartuplift-carousel-controls");if(s){document.querySelectorAll(".cartuplift-recommendation-card").length>0?(s.style.display="flex",s.style.visibility="visible"):s.style.display="none"}else e.log("[CartUplift] Carousel controls not found");i.disabled=a<=0,n.disabled=a>=r-1,i.disabled?i.style.opacity="0.3":i.style.opacity="1",n.disabled?n.style.opacity="0.3":n.style.opacity="1"}updateDots(t){if(!t)return;const e=document.querySelectorAll(".cartuplift-carousel-dot");if(0===e.length)return;const i=this.getCurrentCardIndex(t);e.forEach(((t,e)=>{const n=e===i;t.classList.toggle("active",n),t.setAttribute("aria-current",n?"true":"false")}))}handleVariantChange(t){const e=t.closest(".cartuplift-recommendation-card");if(!e)return;const i=t.value,n=t.options[t.selectedIndex].dataset.priceCents,a=e.querySelector(".cartuplift-add-recommendation");if(a&&i&&(a.dataset.variantId=i),n){const t=e.querySelector(".cartuplift-recommendation-price");t&&(t.textContent=this.formatMoney(parseInt(n,10)))}}showToast(t,e="info"){const i=document.createElement("div");i.className=`cartuplift-toast cartuplift-toast-${e}`,i.textContent=t;const n="success"===e?"#121212":"error"===e?"#ef4444":"#3b82f6";i.style.cssText=`\n        position: fixed;\n        bottom: 20px;\n        right: 20px;\n        padding: 12px 20px;\n        background: ${n};\n        color: white;\n        border-radius: 8px;\n        font-size: 14px;\n        font-weight: 500;\n        z-index: 99999;\n        animation: cartupliftSlideUp 0.3s ease;\n        box-shadow: 0 4px 12px rgba(0,0,0,0.15);\n      `,document.body.appendChild(i),setTimeout((()=>{i.style.opacity="0",i.style.transform="translateY(10px)",setTimeout((()=>{i.parentNode&&i.parentNode.removeChild(i)}),300)}),3e3)}getAddonsHTML(){return'\n        <div class="cartuplift-addons">\n          <button class="cartuplift-addon-btn">\n            Add Gift Note & Logo Free Packaging +\n          </button>\n        </div>\n      '}getInlineLinkConfig(){const t="string"==typeof this.settings.discountLinkText?this.settings.discountLinkText:"",e="string"==typeof this.settings.notesLinkText?this.settings.notesLinkText:"",i=t.trim(),n=e.trim();return{hasPromoLink:Boolean(this.settings.enableDiscountCode&&i.length>0),hasNotesLink:Boolean(this.settings.enableNotes&&n.length>0),promoText:i,notesText:n}}getInlineLinksHTML(t){const{hasPromoLink:e,hasNotesLink:i,promoText:n,notesText:a}=t||this.getInlineLinkConfig(),r=[];if(e){const t=n.replace(/^\+\s*/,""),e=t.length>0?t:n;r.push(`<span class="cartuplift-inline-link" onclick="window.cartUpliftDrawer.openDiscountModal()">${this.escapeHtml(e)}</span>`)}if(i){const t=a.replace(/^\+\s*/,""),e=t.length>0?t:a;r.push(`<span class="cartuplift-inline-link" onclick="window.cartUpliftDrawer.openNotesModal()">${this.escapeHtml(e)}</span>`)}return r.length?`<div class="cartuplift-inline-links">${r.join(" ")}</div>`:""}getNotesHTML(){return'\n        <div class="cartuplift-notes">\n          <textarea id="cartuplift-notes-input" class="cartuplift-notes-input" placeholder="Order notes..." rows="3"></textarea>\n        </div>\n      '}openCustomModal(){let t=document.getElementById("cartuplift-custom-modal");t&&t.remove(),t=document.createElement("div"),t.id="cartuplift-custom-modal",t.className="cartuplift-custom-modal";let i="";e.log("ðŸ›’ Cart Uplift: Building modal with settings:",{enableDiscountCode:this.settings.enableDiscountCode,enableNotes:this.settings.enableNotes,enableGiftMessage:this.settings.enableGiftMessage});if(i+=`\n        <div class="cartuplift-modal-content">\n          <div class="cartuplift-modal-header">\n            <h3 class="cartuplift-modal-title">${!this.settings.enableDiscountCode||this.settings.enableNotes||this.settings.enableGiftMessage?this.settings.enableDiscountCode||!this.settings.enableNotes||this.settings.enableGiftMessage?"Add to order":"Order notes":"Promotion code"}</h3>\n            <button class="cartuplift-modal-close" onclick="window.cartUpliftDrawer.closeCustomModal()">Ã—</button>\n          </div>\n          <div class="cartuplift-modal-body">\n      `,this.settings.enableDiscountCode){const t=this.cart?.attributes?.discount_code?String(this.cart.attributes.discount_code):"",e=this.cart?.attributes?.discount_summary?String(this.cart.attributes.discount_summary):"";i+=`\n          <div class="cartuplift-modal-section">\n            <label class="cartuplift-modal-label">${this.settings.discountSectionTitle||"Discount Code"}</label>\n            <div class="cartuplift-modal-input-group">\n              <input type="text" id="modal-discount-code" class="cartuplift-modal-input" \n                     placeholder="${this.settings.discountPlaceholder||"Enter your voucher code"}" \n                     ${t?`value="${t}" disabled`:""}\n                     onkeyup="window.cartUpliftDrawer.handleDiscountInput(event)">\n              ${t?'\n                <button type="button" class="cartuplift-modal-apply-btn" \n                        onclick="window.cartUpliftDrawer.removeDiscountCode()">Remove</button>\n              ':`\n                <button type="button" class="cartuplift-modal-apply-btn" \n                        onclick="window.cartUpliftDrawer.applyModalDiscount()">${this.settings.applyButtonText||"Apply"}</button>\n              `}\n            </div>\n            <div id="modal-discount-message" class="cartuplift-modal-message">${t?`<span class="success">${e||`âœ“ Discount code "${t}" saved! Will be applied at checkout.`}</span>`:""}</div>\n          </div>\n        `}if(this.settings.enableNotes){const t=this.cart?.attributes?.["Order Notes"]?String(this.cart.attributes["Order Notes"]):"";i+=`\n          <div class="cartuplift-modal-section">\n            <label class="cartuplift-modal-label">${this.settings.notesSectionTitle||"Order Notes"}</label>\n            <textarea id="modal-order-notes" class="cartuplift-modal-textarea" \n                      placeholder="${this.settings.notesPlaceholder||"Add any special instructions or notes..."}" rows="3" maxlength="250"\n                      onkeyup="window.cartUpliftDrawer.updateCharCount(this, 'notes-char-count', 250)">${t}</textarea>\n            <div class="cartuplift-modal-char-count">\n              <span id="notes-char-count">${250-t.length}</span> characters remaining\n            </div>\n          </div>\n        `}if(this.settings.enableGiftMessage){const t=this.cart?.attributes?.["Gift Message"]?String(this.cart.attributes["Gift Message"]):"";i+=`\n          <div class="cartuplift-modal-section">\n            <label class="cartuplift-modal-label">${this.settings.giftSectionTitle||"Gift Message"}</label>\n            <textarea id="modal-gift-message" class="cartuplift-modal-textarea" \n                      placeholder="${this.settings.giftPlaceholder||"Write a personal message for this gift..."}" rows="3" maxlength="200"\n                      onkeyup="window.cartUpliftDrawer.updateCharCount(this, 'gift-char-count', 200)">${t}</textarea>\n            <div class="cartuplift-modal-char-count">\n              <span id="gift-char-count">${200-t.length}</span> characters remaining\n            </div>\n          </div>\n        `}i+='\n          </div>\n          <div class="cartuplift-modal-footer">\n            <button class="cartuplift-modal-btn secondary" onclick="window.cartUpliftDrawer.closeCustomModal()">Cancel</button>\n            <button class="cartuplift-modal-btn primary" onclick="window.cartUpliftDrawer.saveModalOptions()">Save Changes</button>\n          </div>\n        </div>\n      ',t.innerHTML=i,e.log("ðŸ›’ Cart Uplift: Modal HTML length:",i.length,"chars");const n=t.querySelector(".cartuplift-modal-body");n?e.log("ðŸ›’ Cart Uplift: Modal body has",n.children.length,"sections"):e.error("âŒ Cart Uplift: Modal body not found!"),document.body.appendChild(t),e.log("ðŸ›’ Cart Uplift: Modal HTML length:",i.length,"chars"),e.log("ðŸ›’ Cart Uplift: Modal body content:",t.querySelector(".cartuplift-modal-body")?.innerHTML?.substring(0,200)),t.classList.add("active");const a=t.querySelector("input, textarea");a&&setTimeout((()=>a.focus()),80);const r=t=>{try{t.style.height="auto",t.style.height=`${Math.min(t.scrollHeight,320)}px`}catch(t){}};t.querySelectorAll("textarea").forEach((t=>{r(t),t.addEventListener("input",(()=>r(t)))})),e.log("ðŸ›’ Cart Uplift: Modal settings:",{enableDiscountCode:this.settings.enableDiscountCode,enableNotes:this.settings.enableNotes,enableGiftMessage:this.settings.enableGiftMessage})}openDiscountModal(){const t={enableDiscountCode:this.settings.enableDiscountCode,enableNotes:this.settings.enableNotes,enableGiftMessage:this.settings.enableGiftMessage};this.settings.enableDiscountCode=!0,this.settings.enableNotes=!1,this.settings.enableGiftMessage=!1,this.openCustomModal(),this.settings.enableDiscountCode=t.enableDiscountCode,this.settings.enableNotes=t.enableNotes,this.settings.enableGiftMessage=t.enableGiftMessage}openNotesModal(){const t={enableDiscountCode:this.settings.enableDiscountCode,enableNotes:this.settings.enableNotes,enableGiftMessage:this.settings.enableGiftMessage};this.settings.enableDiscountCode=!1,this.settings.enableNotes=!0,this.settings.enableGiftMessage=!1,this.openCustomModal(),this.settings.enableDiscountCode=t.enableDiscountCode,this.settings.enableNotes=t.enableNotes,this.settings.enableGiftMessage=t.enableGiftMessage}closeCustomModal(){const t=document.getElementById("cartuplift-custom-modal");t&&t.classList.remove("active")}updateCharCount(t,e,i){const n=document.getElementById(e);if(n){const e=i-t.value.length;n.textContent=e,n.style.color=e<50?"#e74c3c":"#666"}}handleDiscountInput(t){"Enter"===t.key&&this.applyModalDiscount()}async applyModalDiscount(){const t=document.getElementById("cartuplift-custom-modal"),i=t?.querySelector("#modal-discount-code"),n=t?.querySelector("#modal-discount-message"),a=t?.querySelector(".cartuplift-modal-apply-btn");if(!i||!i.value.trim())return void(n&&(n.innerHTML='<span class="error">Please enter a discount code</span>'));const r=i.value.trim().toUpperCase(),s=this.cart?.attributes?String(this.cart.attributes.discount_code||"").toUpperCase():"";if(s&&s===r)n&&(n.innerHTML=`<span class="success">Code "${r}" is already applied.</span>`);else{a&&(a.disabled=!0,a.textContent="Applying...");try{const t=await fetch("/apps/cart-uplift/api/discount",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({discountCode:r})});if(!t.ok&&(404===t.status||401===t.status||403===t.status||t.status>=500)){const t=await fetch(`/cart/discounts/${encodeURIComponent(r)}`,{method:"POST",headers:{"Content-Type":"application/json"}});if(t.ok)await this.fetchCart(),this.updateDrawerContent(),n&&(n.innerHTML=`<span class="success">âœ“ Discount code "${r}" applied successfully!</span>`),i&&(i.value=""),this.showToast("Discount code applied!","success"),this.openCustomModal();else{const e=(await t.json().catch((()=>({})))).description||"Invalid discount code";n&&(n.innerHTML=`<span class="error">âœ— ${e}</span>`),this.showToast("Invalid discount code","error")}return}const e=await t.json().catch((()=>({})));if(!t.ok&&e&&e.error)try{if((await fetch(`/cart/discounts/${encodeURIComponent(r)}`,{method:"POST",headers:{"Content-Type":"application/json"}})).ok)return await this.fetchCart(),this.updateDrawerContent(),n&&(n.innerHTML=`<span class="success">âœ“ Discount code "${r}" applied successfully!</span>`),i&&(i.value=""),this.showToast("Discount code applied!","success"),void this.openCustomModal()}catch(t){}if(e.success){const t=await fetch("/cart.js").then((t=>t.json())),a=e.discount.kind||"",s=e.discount.percent,o=e.discount.amountCents,c="number"==typeof s?s:"string"==typeof s?parseFloat(s):void 0,l="number"==typeof o?o:"string"==typeof o?Math.round(parseFloat(o)):void 0,d={attributes:{...t.attributes,discount_code:r,discount_summary:e.discount.summary||`Discount: ${r}`,discount_kind:a,discount_percent:"number"!=typeof c||Number.isNaN(c)?"":String(c),discount_amount_cents:"number"!=typeof l||Number.isNaN(l)?"":String(l)}};this._lastDiscountCode=r,this._lastDiscountKind=a||void 0,this._lastDiscountPercent="number"!=typeof c||Number.isNaN(c)?void 0:c,this._lastDiscountAmountCents="number"!=typeof l||Number.isNaN(l)?void 0:l,this.updateDrawerContent();if(!(await fetch("/cart/update.js",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(d)})).ok)throw new Error("Failed to save discount to cart");await this.fetchCart(),this.updateDrawerContent(),n&&(n.innerHTML=`<span class="success">âœ“ Discount code "${r}" validated! Previewed below and will apply at checkout.</span>`),i&&(i.value=""),this.showToast("Discount code validated!","success"),this.openCustomModal()}else n&&(n.innerHTML=`<span class="error">${e.error||"Invalid discount code"}</span>`),this.showToast("Invalid discount code","error")}catch(t){e.error("Error validating discount:",t),n&&(n.innerHTML='<span class="error">Unable to validate discount code. Please check the code and try again.</span>'),this.showToast("Discount validation failed","error")}finally{a&&(a.disabled=!1,a.textContent="Apply")}}}async removeDiscountCode(){try{const t={...(await fetch("/cart.js").then((t=>t.json()))).attributes||{}};t.discount_code=null,t.discount_summary=null,t.discount_kind=null,t.discount_percent=null,t.discount_amount_cents=null;(await fetch("/cart/update.js",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({attributes:t})})).ok?(await this.fetchCart(),this.updateDrawerContent(),this.showToast("Discount removed","success"),this._lastDiscountCode=void 0,this._lastDiscountKind=void 0,this._lastDiscountPercent=void 0,this._lastDiscountAmountCents=void 0,this.openCustomModal()):this.showToast("Could not remove discount","error")}catch(t){e.error("Error removing discount:",t),this.showToast("Could not remove discount","error")}}async saveModalOptions(){const t=document.getElementById("cartuplift-custom-modal");if(!t)return;const e={},i=t.querySelector("#modal-order-notes");i?.value.trim()&&(e.orderNotes=i.value.trim());const n=t.querySelector("#modal-gift-message");n?.value.trim()&&(e.giftMessage=n.value.trim()),await this.saveCartAttributes(e),this.closeCustomModal(),this.showToast("Your preferences have been saved!","success")}async saveCartAttributes(t){try{const e={};t.orderNotes&&(e["Order Notes"]=t.orderNotes),t.giftMessage&&(e["Gift Message"]=t.giftMessage),t.specialRequests&&(e["Special Requests"]=t.specialRequests),t.deliveryInstructions&&(e["Delivery Instructions"]=t.deliveryInstructions),t.giftWrapping&&(e["Gift Wrapping"]="Yes");(await fetch("/cart/update.js",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({attributes:e})})).ok&&await this.fetchCart()}catch(t){e.error("Error saving cart attributes:",t)}}async applyInlineDiscount(){const t=document.getElementById("cartuplift-discount-input"),i=document.getElementById("cartuplift-discount-message"),n=document.querySelector(".cartuplift-discount-apply");if(!t||!t.value.trim())return void(i&&(i.innerHTML='<span class="error">Please enter a discount code</span>'));const a=t.value.trim();n&&(n.disabled=!0,n.textContent="Applying...");try{const e=await fetch(`/cart/discounts/${encodeURIComponent(a)}`,{method:"POST",headers:{"Content-Type":"application/json"}});if(e.ok)await this.fetchCart(),this.updateDrawerContent(),i&&(i.innerHTML='<span class="success">âœ“ Discount applied successfully!</span>'),t&&(t.value="");else{const t=(await e.json().catch((()=>({})))).description||"Invalid discount code";i&&(i.innerHTML=`<span class="error">âœ— ${t}</span>`)}}catch(t){e.error("Error applying discount:",t),i&&(i.innerHTML='<span class="error">âœ— Error applying discount code</span>')}finally{n&&(n.disabled=!1,n.textContent="Apply")}}async applyDiscountCode(t=null){const i=t||document.getElementById("discount-code")?.value;if(i)try{(await fetch(`/discount/${encodeURIComponent(i)}`,{method:"POST"})).ok?(await this.fetchCart(),this.updateDrawerContent(),this.showToast("Discount applied!","success")):this.showToast("Invalid discount code","error")}catch(t){e.error("Error applying discount:",t),this.showToast("Error applying discount","error")}}getExpressCheckoutHTML(){return'\n        <div class="cartuplift-express-checkout">\n          <div class="cartuplift-express-slot"></div>\n        </div>\n      '}attachDrawerEvents(){const t=document.getElementById("cartuplift-app-container");if(!t)return;if("true"===t.dataset.eventsAttached)return;t.dataset.eventsAttached="true";const i=t.querySelector(".cartuplift-close");i&&i.addEventListener("click",(()=>this.closeDrawer()));const a=t.querySelector("#cartuplift-backdrop");a&&a.addEventListener("click",(t=>{const e=document.getElementById("cartuplift-custom-modal");e?.classList.contains("active")||t.target===a&&this.closeDrawer()})),document.addEventListener("mousedown",(t=>{if(!this.isOpen)return;const e=document.getElementById("cartuplift-custom-modal");if(e?.classList.contains("active"))return;const i=document.getElementById("cartuplift-cart-popup");i&&(i.contains(t.target)||this.closeDrawer())})),document.addEventListener("keydown",(t=>{if("Escape"===t.key&&this.isOpen){const t=document.getElementById("cartuplift-custom-modal");t?.classList.contains("active")?this.closeCustomModal():this.closeDrawer()}})),t.addEventListener("click",(async i=>{if(i.target.classList.contains("cartuplift-qty-plus")){const e=i.target.dataset.line,n=t.querySelector(`[data-line="${e}"] .cartuplift-qty-display`);if(n){const t=parseInt(n.textContent,10)||0;this.updateQuantity(e,t+1)}}else if(i.target.classList.contains("cartuplift-qty-minus")){const e=i.target.dataset.line,n=t.querySelector(`[data-line="${e}"] .cartuplift-qty-display`);if(n){const t=parseInt(n.textContent,10)||0;this.updateQuantity(e,Math.max(0,t-1))}}else if(i.target.classList.contains("cartuplift-item-remove-x")||i.target.closest(".cartuplift-item-remove-x")){const t=(i.target.classList.contains("cartuplift-item-remove-x")?i.target:i.target.closest(".cartuplift-item-remove-x")).dataset.line;this.updateQuantity(t,0)}else if(i.target.classList.contains("cartuplift-add-recommendation")){i.preventDefault(),i.stopPropagation();const t=i.target.closest(".cartuplift-recommendation-card");if(!t)return;const e=t.querySelector(".cartuplift-size-dropdown:not([disabled])");let a=i.target.dataset.variantId;if(e&&!e.value)return this.showToast("Please select an option","error"),void e.focus();if(e?.value&&(a=e.value),!a)return void this.showToast("Please select options","error");const r=t.querySelector("h4")?.textContent||`Product ${a}`,s=Array.from(t.parentElement.children).indexOf(t),o=i.target.dataset.productId;n.trackEvent("click",{productId:a,variantId:a,parentProductId:o,productTitle:r,source:"cart_drawer",position:s}),this.addToCart(a,1)}else if(i.target.classList.contains("cartuplift-size-dropdown"))this.handleVariantChange(i.target);else if(i.target.classList.contains("cartuplift-add-recommendation-circle")){i.preventDefault(),i.stopPropagation(),i.stopImmediatePropagation();const t=i.target;if("true"===t.dataset.processing)return;t.dataset.processing="true";const e=i.target.closest(".cartuplift-recommendation-item");if(!e)return void(t.dataset.processing="false");const a=e.querySelector(".cartuplift-product-link");if(!a)return void(t.dataset.processing="false");const r=a.getAttribute("href"),s=r?r.split("/").pop().split("?")[0]:null,o=i.target.dataset.variantId,c=i.target.dataset.productId,l=a.textContent,d=Array.from(e.parentElement.children).indexOf(e);n.trackEvent("click",{productId:o,variantId:o,parentProductId:c,productTitle:l,source:"cart_drawer",position:d}),s&&o?this.handleListProductAdd(s,o,l,t):t.dataset.processing="false"}else if(i.target.classList.contains("cartuplift-grid-add-btn")||i.target.closest(".cartuplift-grid-add-btn")){i.preventDefault(),i.stopPropagation(),i.stopImmediatePropagation();const t=i.target.classList.contains("cartuplift-grid-add-btn")?i.target:i.target.closest(".cartuplift-grid-add-btn");if("true"===t.dataset.processing)return;t.dataset.processing="true";const a=t.dataset.variantId,r=t.dataset.productId,s=t.dataset.gridIndex,o=t.closest(".cartuplift-grid-item"),c=o?o.dataset.productHandle:null,l=o?o.dataset.title:`Product ${a}`;n.trackEvent("click",{productId:a,variantId:a,parentProductId:r,productTitle:l,source:"cart_drawer",position:s}),c&&a?await this.handleGridProductAdd(c,a,s,l):a?(e.warn("ðŸ›’ No product handle found, adding directly to cart"),this.addToCart(a,1),void 0!==s&&setTimeout((()=>{this.swapInNextRecommendation(parseInt(s,10))}),500)):e.error("ðŸ›’ No variant ID found for add to cart"),setTimeout((()=>{t.dataset.processing="false"}),1e3),this.settings.enableAnalytics&&n.trackEvent("product_click",{productId:a,productTitle:l})}else if(i.target.classList.contains("cartuplift-recommendations-toggle")||i.target.closest(".cartuplift-recommendations-toggle")){i.preventDefault(),i.stopPropagation();const e=i.target.classList.contains("cartuplift-recommendations-toggle")?i.target:i.target.closest(".cartuplift-recommendations-toggle");let n=e.closest(".cartuplift-recommendations");if(n||(n=t.querySelector(".cartuplift-recommendations")),n){const t=n.classList.contains("collapsed");n.classList.toggle("collapsed");const i=n.classList.contains("collapsed"),a=n.querySelector("#cartuplift-recommendations-content");a&&a.setAttribute("aria-hidden",i?"true":"false");const r=e.querySelector("svg path");r&&(t?r.setAttribute("d","m4.5 15.75 7.5-7.5 7.5 7.5"):r.setAttribute("d","m19.5 8.25-7.5 7.5-7.5-7.5")),e.setAttribute("aria-expanded",i?"false":"true")}}else if(i.target.classList.contains("cartuplift-carousel-nav")||i.target.closest(".cartuplift-carousel-nav")){const e=(i.target.classList.contains("cartuplift-carousel-nav")?i.target:i.target.closest(".cartuplift-carousel-nav")).dataset.nav,n=t.querySelector(".cartuplift-recommendations-content");n&&e&&(this.setupScrollControls(n),"prev"===e?this.scrollPrev(n):"next"===e&&this.scrollNext(n),setTimeout((()=>{this.updateCarouselButtons(n),this.updateDots(n)}),100))}else if(i.target.classList.contains("cartuplift-carousel-dot")){const e=i.target,n=parseInt(e.dataset.index,10),a=t.querySelector(".cartuplift-recommendations-content");if(a&&!Number.isNaN(n)){this.setupScrollControls(a),this.scrollToIndex(a,n);document.querySelectorAll(".cartuplift-carousel-dot").forEach(((t,e)=>{t.classList.toggle("active",e===n)}))}}})),t.addEventListener("change",(t=>{const e=t.target;e?.classList?.contains("cartuplift-size-dropdown")&&this.handleVariantChange(e)})),t.addEventListener("touchend",(t=>{const e=t.target.classList?.contains("cartuplift-recommendations-toggle")?t.target:t.target.closest?.(".cartuplift-recommendations-toggle");e&&(t.preventDefault(),t.stopPropagation(),e.click())}),{passive:!1})}async fetchCart(t=!1){try{if(!t&&this._prewarmData)this.cart=this._prewarmData,this._prewarmData=null;else if(!t&&this._prewarmPromise)this.cart=await this._prewarmPromise,this._prewarmPromise=null;else if(t){const t=Date.now(),e=await fetch(`/cart.js?t=${t}`);this.cart=await e.json()}else{const t=await fetch("/cart.js");this.cart=await t.json()}this._lastCartFetch=Date.now(),this.rebuildRecommendationsFromMaster()}catch(t){e.error("CartUplift: Error fetching cart:",t),this.cart={items:[],item_count:0,total_price:0}}}updateThemeCartCount(t){try{["#cart-icon-bubble",".cart-count-bubble",".cart-count","[data-cart-count]",".header__icon--cart .badge",".site-header__cart-count","cart-icon-bubble",".cart-icon-bubble","#CartCount",".CartCount",'[id*="cart-count"]','[class*="cart-count"]'].forEach((e=>{document.querySelectorAll(e).forEach((e=>{void 0!==e.textContent&&(e.textContent=t),e.hasAttribute("data-cart-count")&&e.setAttribute("data-cart-count",t),t>0?(e.style.display="",e.classList.remove("hidden")):"false"!==e.dataset.hideWhenEmpty&&(e.style.display="none")}))})),document.dispatchEvent(new CustomEvent("cart:updated",{detail:{item_count:t,cart:this.cart}})),e.log(`ðŸ”„ Updated theme cart count to: ${t}`)}catch(t){e.warn("Failed to update theme cart count:",t)}}async updateQuantity(t,i){if(!this._quantityBusy){this._quantityBusy=!0;try{const n=new FormData;n.append("line",t),n.append("quantity",i);const a=await fetch("/cart/change.js",{method:"POST",body:n});a.ok?(this.cart=await a.json(),this._cartModified=!0,this._lastCartFetch=Date.now(),this.rebuildRecommendationsFromMaster(),this.updateDrawerContent(),await this.checkAndAddGiftThresholds()):e.error("ðŸ”„ Update failed with status:",a.status)}catch(t){e.error("CartUplift: Error updating quantity:",t)}finally{this._quantityBusy=!1}}}async consolidateDuplicateCartItems(){if(this.cart&&this.cart.items&&!(this.cart.items.length<=1))try{const t=new Map;this.cart.items.forEach(((e,i)=>{const n=String(e.variant_id||e.id);t.has(n)||t.set(n,[]),t.get(n).push({item:e,originalIndex:i})}));const i=[];if(t.forEach(((t,e)=>{t.length>1&&i.push({variantId:e,items:t})})),0===i.length)return;e.log(`ðŸ”„ Found ${i.length} duplicate variant(s), consolidating...`);for(const{variantId:t,items:n}of i){let i=0,a=0,r=0,s=null;n.forEach((({item:t})=>{const e=t.properties||{},n=parseInt(e._source_manual_qty||0),o=parseInt(e._source_rec_qty||0),c=parseInt(e._source_bundle_qty||0);0===n&&0===o&&0===c?i+=t.quantity:(i+=n,a+=o,r+=c),e._bundle_id&&!s&&(s={_bundle_id:e._bundle_id,_bundle_name:e._bundle_name})}));const o=i+a+r;for(const{item:t}of n)await(window.CartUpliftAAInternal?.originals?.fetch||window.fetch)("/cart/change.js",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({id:t.key,quantity:0})});const c={id:t,quantity:o,properties:{}};i>0&&(c.properties._source_manual_qty=String(i)),a>0&&(c.properties._source_rec_qty=String(a)),r>0&&(c.properties._source_bundle_qty=String(r),s&&(c.properties._bundle_id=s._bundle_id,s._bundle_name&&(c.properties._bundle_name=s._bundle_name))),await(window.CartUpliftAAInternal?.originals?.fetch||window.fetch)("/cart/add.js",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({items:[c]})}),e.log(`âœ… Consolidated ${n.length} line items for variant ${t}:`,{manual:i,rec:a,bundle:r,total:o})}await this.fetchCart(!0)}catch(t){e.error("CartUplift: Error consolidating duplicate items:",t)}}async addToCart(t,i=1){if(!this._addToCartBusy){this._addToCartBusy=!0;try{if(!t||"undefined"===t||"null"===t)return e.error("ðŸ›’ Invalid variant ID:",t),void(this._addToCartBusy=!1);const n=document.querySelectorAll(`[data-variant-id="${t}"]`);n.forEach((t=>{t.disabled=!0,t.style.opacity="0.6",t.style.transform="scale(0.95)"})),await new Promise((t=>setTimeout(t,150)));const a=await fetch("/cart.js"),r=a.ok?await a.json():{items:[]},s=String(t).replace(/[^0-9]/g,""),o=(r.items||[]).find((t=>String(t.variant_id||t.id)===s));let c;if(o){const t=o.properties||{};let e=parseInt(t._source_manual_qty||0),n=parseInt(t._source_rec_qty||0),a=parseInt(t._source_bundle_qty||0);0===e&&0===n&&0===a&&(e=o.quantity),n+=i;const r=e+n+a;await fetch("/cart/change.js",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({id:o.key,quantity:0})}),c={id:s,quantity:r,properties:{}},e>0&&(c.properties._source_manual_qty=String(e)),n>0&&(c.properties._source_rec_qty=String(n)),a>0&&(c.properties._source_bundle_qty=String(a),t._bundle_id&&(c.properties._bundle_id=t._bundle_id),t._bundle_name&&(c.properties._bundle_name=t._bundle_name))}else c={id:s,quantity:i,properties:{_source_rec_qty:String(i)}};const l=await fetch("/cart/add.js",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({items:[c]})});if(l.ok){await l.json();this._cartModified=!0,n.forEach((t=>{t.disabled=!1,t.style.opacity="1",t.style.transform="scale(1)";const e=this.settings.buttonColor||"#121212";t.style.background=e,setTimeout((()=>{t.style.background=""}),300)})),this.debouncedUpdateRecommendations();const t=this.fetchCart(!0).then((()=>{this.updateDrawerContent()})),i=this.checkAndAddGiftThresholds();if(await Promise.all([t,i]),this.isOpen){const t=document.getElementById("cartuplift-recommendations-content");t&&(t.innerHTML=this.getRecommendationItems())}this.settings.autoOpenCart&&this.settings.enableApp&&(e.log("ðŸ”§ Auto-opening cart after adding from recommendations"),this.hideThemeNotifications(),this.tryAutoOpenDrawer())}else 429===l.status?(e.error("ðŸ›’ Rate limited, retrying with longer delay..."),n.forEach((t=>{t.disabled=!1,t.style.opacity="1",t.style.transform="scale(1)"}))):422===l.status?(e.error("ðŸ›’ Variant not found (422 error) for variant ID:",t),this.removeInvalidRecommendation(t),n.forEach((t=>{t.disabled=!1,t.style.opacity="1",t.style.transform="scale(1)",t.style.display="none"}))):(e.error("ðŸ›’ Error adding to cart:",l.status,l.statusText),n.forEach((t=>{t.disabled=!1,t.style.opacity="1",t.style.transform="scale(1)",t.style.animation="shake 0.3s ease-in-out",setTimeout((()=>{t.style.animation=""}),300)})))}catch(i){e.error("CartUplift: Error adding to cart:",i);document.querySelectorAll(`[data-variant-id="${t}"]`).forEach((t=>{t.disabled=!1,t.style.opacity="1",t.style.transform="scale(1)"}))}finally{setTimeout((()=>{this._addToCartBusy=!1}),500)}}}async handleGridProductAdd(t,i,n,a){try{e.log("ðŸ›’ handleGridProductAdd called:",{productHandle:t,variantId:i,gridIndex:n,productTitle:a});const r=await fetch(`/products/${t}.js`);if(!r.ok)return e.error("ðŸ›’ Failed to fetch product data, status:",r.status),void this.addToCart(i,1);const s=await r.json(),o=this.prepareVariantModalState(s);if(e.log("ðŸ›’ Product data fetched:",s.title),e.log("ðŸ›’ Variant summary:",{total:o.allVariants.length,available:o.availableVariants.length,optionNames:o.optionNames,requiresSelection:o.requiresSelection}),o.requiresSelection)e.log("ðŸ›’ Showing product modal for variant selection"),this.showProductModal(s,n,o);else{e.log("ðŸ›’ Single variant product, adding directly to cart");const t=o.initialVariant||s.variants?.[0],a=t?.id||i;a&&await this.addToCart(a,1),void 0!==n&&setTimeout((()=>{this.swapInNextRecommendation(parseInt(n,10))}),500)}}catch(t){e.error("Error handling grid product add:",t),this.addToCart(i,1)}}async handleListProductAdd(t,i,n,a){try{const n=await fetch(`/products/${t}.js`);if(!n.ok)return e.error("ðŸ›’ Failed to fetch product data, status:",n.status),this.addToCart(i,1),void(a.dataset.processing="false");const r=await n.json(),s=this.prepareVariantModalState(r);if(s.requiresSelection)this.showProductModal(r,void 0,s),a.dataset.processing="false";else{const t=s.initialVariant||r.variants?.[0],e=t?.id||i;e&&await this.addToCart(e,1),a.dataset.processing="false"}}catch(t){e.error("Error handling list product add:",t),this.addToCart(i,1),a.dataset.processing="false"}}async handleListProductAdd(t,i,n,a){try{const n=await fetch(`/products/${t}.js`);if(!n.ok)return e.error("ðŸ›’ Failed to fetch product data, status:",n.status),this.addToCart(i,1),void(a.dataset.processing="false");const r=await n.json(),s=this.prepareVariantModalState(r);if(s.requiresSelection)this.showProductModal(r,void 0,s),a.dataset.processing="false";else{const t=s.initialVariant||r.variants?.[0],e=t?.id||i;e&&await this.addToCart(e,1),a.dataset.processing="false"}}catch(t){e.error("Error handling list product add:",t),this.addToCart(i,1),a.dataset.processing="false"}}getProductOptionNames(t){if(!t||!Array.isArray(t.options))return[];const e=t.options;return 0===e.length?[]:"string"==typeof e[0]?e.filter((t=>"string"==typeof t)).map((t=>t.trim())).filter((t=>t.length>0&&"title"!==t.toLowerCase())):e.map((t=>t?"string"==typeof t?t.trim():"string"==typeof t.name?t.name.trim():null:null)).filter((t=>t&&t.length>0&&"title"!==t.toLowerCase()))}getVariantOptionLabel(t,e="Select Option"){const i=this.getProductOptionNames(t);return i.length?1===i.length?`Select ${i[0]}`:`Select ${i.join(" / ")}`:e}getVariantOptionValue(t,e){if(!t||"number"!=typeof e)return"";const i=t[`option${e+1}`];let n="string"==typeof i?i:null;return n&&"Default Title"!==n||!Array.isArray(t.options)||(n=t.options[e]),n&&"Default Title"!==n?n:""}getOptionValuePriceRange(t,e,i){if(!t||!Number.isInteger(e)||!i)return null;const n=Array.isArray(t.allVariants)?t.allVariants:[];if(!n.length)return null;let a=null,r=null;return n.forEach((t=>{if(!t)return;if(this.getVariantOptionValue(t,e)!==i)return;const n=this.normalizePriceToCents(t.price);Number.isFinite(n)&&((null===a||n<a)&&(a=n),(null===r||n>r)&&(r=n))})),null===a?null:{min:a,max:r}}renderOptionValuePriceSnippet(t,e,i){const n=this.getOptionValuePriceRange(t,e,i);if(!n)return"";const{min:a,max:r}=n;return Number.isFinite(a)?null!==r&&Number.isFinite(r)&&r>a?`<span class="cartuplift-variant-pill-price">From ${this.formatMoney(a)}</span>`:`<span class="cartuplift-variant-pill-price">${this.formatMoney(a)}</span>`:""}formatVariantDisplayName(t,e){if(!e)return"Default";const i=this.getProductOptionNames(t),n=[e.option1,e.option2,e.option3].map((t=>"Default Title"===t?"":t||"")).filter(Boolean);if(!i.length)return n.length?n.join(" Â· "):e.title&&"Default Title"!==e.title?e.title:"Default";const a=[];return i.forEach(((t,e)=>{const r=n[e];r&&(1===i.length?a.push(r):a.push(`${t}: ${r}`))})),a.length?a.join(" Â· "):e.title&&"Default Title"!==e.title?e.title:n.length?n.join(" Â· "):"Default"}prepareVariantModalState(t){const e=Array.isArray(t?.variants)?t.variants:[],i=e.filter((t=>t?.available)),n=i.length?i:e,a=i[0]||e[0]||null,r=a?String(a.id):null,s=this.getProductOptionNames(t),o=new Map,c=new Map;Array.isArray(t?.options)&&t.options.forEach((t=>{const e="string"==typeof t?t:t?.name;if(!e||"string"!=typeof e)return;const i=e.trim();0!==i.length&&"title"!==i.toLowerCase()&&s.includes(i)&&!c.has(i)&&Array.isArray(t?.values)&&c.set(i,t.values.filter((t=>"string"==typeof t&&t&&"Default Title"!==t)))})),s.forEach((t=>{o.has(t)||o.set(t,new Set)}));const l=new Map;e.forEach((t=>{if(!t||void 0===t.id||null===t.id)return;const e=String(t.id);l.set(e,t),s.forEach(((e,i)=>{const n=this.getVariantOptionValue(t,i);n&&o.get(e)?.add(n)}))}));const d=s.map(((t,i)=>{const n=new Set;return e.forEach((t=>{const e=this.getVariantOptionValue(t,i);e&&n.add(e)})),n})),p=new Set(e.map((t=>t?.title)).filter(Boolean)),u=d.some((t=>t.size>1)),h=i.length>1||e.length>1&&(p.size>1||u),m={};return a&&s.forEach(((t,e)=>{const i=this.getVariantOptionValue(a,e);i&&(m[t]=i)})),{allVariants:e,availableVariants:i,variantsToRender:n,initialVariant:a,defaultVariantId:r,optionValuesByIndex:d,uniqueVariantTitles:p,hasMultiOption:u,requiresSelection:h,optionLabel:this.getVariantOptionLabel(t),optionNames:s,optionValueSets:o,optionValueOrder:c,initialSelection:m,variantLookup:l}}setupVariantInteractions(t,e,i,n={}){const{addButton:a=t.querySelector(".cartuplift-modal-add-btn"),priceDisplay:r=t.querySelector(".cartuplift-modal-price"),updatePrice:s=!0,disableAddForSoldOut:o=!0,soldOutLabel:c="Sold Out",onVariantSelected:l=null}=n,d=t.querySelector(".cartuplift-variant-select"),p=Array.from(t.querySelectorAll(".cartuplift-variant-pill")),u=t.querySelector("[data-variant-helper]"),h=t.querySelector("[data-variant-summary]"),m=i?.variantLookup||new Map,f=Array.isArray(i?.optionNames)?i.optionNames:[],g=Array.isArray(i?.allVariants)?i.allVariants:[],y=a?a.textContent.trim():"",v=Object.assign({},i?.initialSelection||{});let w=null;const b=t=>{const e=Object.entries(t||{}).filter((([,t])=>"string"==typeof t&&t));return e.length?g.filter((t=>!!t&&e.every((([e,i])=>{const n=f.indexOf(e);return-1===n||this.getVariantOptionValue(t,n)===i})))):g.filter(Boolean)},C=t=>{if(!h)return;if(t)return void(h.textContent=this.formatVariantDisplayName(e,t));const n=f.map((t=>v[t])).filter(Boolean).join(" Â· ");n?h.textContent=n:i?.initialVariant&&(h.textContent=this.formatVariantDisplayName(e,i.initialVariant))},_=t=>{if(!s||!r||r.classList.contains("cartuplift-gift-price"))return;if(t){const e=this.normalizePriceToCents(t.price);return void(Number.isFinite(e)&&(r.textContent=this.formatMoney(e),r.dataset.price=e))}const e=r.dataset.basePrice||r.dataset.price,i=parseInt(e,10);Number.isFinite(i)&&(r.textContent=this.formatMoney(i),r.dataset.price=i)},S=()=>{p.forEach((t=>{const e=t.dataset.optionName,i=t.dataset.optionValue;if(!e||!i)return;const n=Object.assign({},v);delete n[e];const a=Object.assign({},n,{[e]:i}),r=b(a),s=r.length>0,o=r.some((t=>t&&!1!==t.available)),c=v[e]===i;t.classList.toggle("is-selected",c),t.setAttribute("aria-pressed",c?"true":"false"),t.classList.toggle("is-disabled",!o),t.classList.toggle("is-unavailable",!s),t.classList.toggle("is-soldout",s&&!o),t.dataset.available=o?"true":"false",t.setAttribute("aria-disabled",o?"false":"true"),t.disabled=!o}));const t=(()=>{if(!f.length)return i?.initialVariant||g[0]||null;if(!f.every((t=>v[t])))return null;const t=b(v);return t.length?t.find((t=>t&&!1!==t.available))||t[0]:null})();d&&(d.value=t?String(t.id):""),(t=>{if(!a)return;const e=a.dataset.originalLabel||y;if(!a.dataset.originalLabel&&e&&(a.dataset.originalLabel=e),!t)return a.dataset.variantId="",a.disabled=!0,a.classList.add("is-disabled"),void(a.textContent=e);a.dataset.variantId=String(t.id),!1===t.available&&o?(a.disabled=!0,a.classList.add("is-disabled"),a.textContent=c):(a.disabled=!1,a.classList.remove("is-disabled"),a.textContent=e)})(t),_(t),C(t),(()=>{if(!u)return;const t=f.filter((t=>!v[t]));if(!t.length)return u.textContent="",void(u.dataset.state="complete");u.dataset.state="pending";const e=t[0];u.textContent=`Select ${e}`})();const e=t?String(t.id):null;t&&e!==w&&"function"==typeof l&&l(t),w=e},k=t=>{if(!t)return;const e=String(t),i=m.get(e)||g.find((t=>t&&String(t.id)===e));i&&(f.forEach(((t,e)=>{const n=this.getVariantOptionValue(i,e);n?v[t]=n:delete v[t]})),S())};if(d&&d.addEventListener("change",(t=>{k(t.target.value)})),p.forEach((t=>{t.addEventListener("click",(()=>{if(t.classList.contains("is-disabled")||t.classList.contains("is-unavailable"))return;const e=t.dataset.optionName,i=t.dataset.optionValue;e&&i&&(v[e]=i,f.forEach((t=>{if(t===e)return;if(!v[t])return;b(v).some((e=>{const i=f.indexOf(t);return this.getVariantOptionValue(e,i)===v[t]}))||delete v[t]})),S())}))})),!p.length||!f.length){const t=i?.initialVariant||g[0];return t?k(t.id):a&&(a.disabled=!0,a.classList.add("is-disabled")),{applyVariant:k}}const $=i?.defaultVariantId||(i?.initialVariant?i.initialVariant.id:null);return $?k($):S(),{applyVariant:k}}showProductModal(t,i,n){if(this._modalOpening||document.querySelector(".cartuplift-product-modal"))return void e.log("ðŸ›’ Modal already opening/open, ignoring duplicate call");this._modalOpening=!0,e.log("ðŸ›’ Creating product modal for:",t.title);const a=n||this.prepareVariantModalState(t),r=document.createElement("div");r.className="cartuplift-product-modal",r.style.zIndex="1000001";try{r.innerHTML=this.generateProductModalHTML(t,i,a)}catch(t){return e.error("ðŸ›’ Error generating modal HTML:",t),void(this._modalOpening=!1)}document.body.appendChild(r);const s=r.querySelector(".cartuplift-modal-content"),o=document.querySelector("#cartuplift-cart-popup .cartuplift-drawer"),c=()=>{if(!s||!o)return;const t=o.getBoundingClientRect();s.style.width=`${t.width}px`,s.style.maxWidth=`${t.width}px`,s.style.height=`${t.height}px`,s.style.maxHeight=`${t.height}px`};c(),window.addEventListener("resize",c),r._cleanupResize=()=>window.removeEventListener("resize",c),this.attachProductModalHandlers(r,t,i,a),requestAnimationFrame((()=>{r.classList.add("show"),this._modalOpening=!1,e.log("ðŸ›’ Modal shown smoothly")}))}generateProductModalHTML(t,e,i){const n=i||this.prepareVariantModalState(t),a=n.initialVariant,r=n.defaultVariantId,s=Array.isArray(n.optionNames)?n.optionNames:[],o=Array.isArray(n.allVariants)?n.allVariants:[],c=t.price&&t.price>0?t.price:a?a.price:0,l=this.normalizePriceToCents(c),d=(a?this.escapeHtml(this.formatVariantDisplayName(t,a)):this.escapeHtml(n.optionLabel||"Select an option"),`\n        <select id="cartuplift-variant-select" class="cartuplift-variant-select cartuplift-variant-select--hidden" aria-hidden="true" tabindex="-1">\n          ${o.length?o.map((e=>{if(!e||void 0===e.id||null===e.id)return"";const i=String(e.id),n=this.escapeHtml(this.formatVariantDisplayName(t,e));return`\n          <option value="${i}" data-available="${!1!==e.available?"true":"false"}"${r&&r===i?" selected":""}>\n            ${n}\n          </option>\n        `})).join(""):'\n          <option value="" disabled selected>Currently unavailable</option>\n        '}\n        </select>\n      `),p=s.map(((t,e)=>{const i=n.optionValueSets?.get(t);if(!i||0===i.size)return"";const a=Array.isArray(n.optionValueOrder?.get(t))?n.optionValueOrder.get(t):[],r=new Set,s=[];if(a.length&&a.forEach((t=>{"string"==typeof t&&i.has(t)&&(r.has(t)||(s.push(t),r.add(t)))})),i.forEach((t=>{"string"==typeof t&&(r.has(t)||(s.push(t),r.add(t)))})),!s.length)return"";const o=s.map((i=>{const a=this.escapeHtml(i),r=this.renderOptionValuePriceSnippet(n,e,i)||"";return`\n            <button type="button" class="cartuplift-variant-pill" data-option-name="${this.escapeHtml(t)}" data-option-index="${e}" data-option-value="${a}" data-available="true" aria-pressed="false">\n              <span class="cartuplift-variant-pill-label">${a}</span>\n              ${r}\n            </button>\n          `})).join("");return`\n          <div class="cartuplift-variant-group" data-option-name="${this.escapeHtml(t)}">\n            <div class="cartuplift-variant-group-header">\n              <span class="cartuplift-variant-group-label">${this.escapeHtml(t)}</span>\n            </div>\n            <div class="cartuplift-variant-group-values">\n              ${o}\n            </div>\n          </div>\n        `})).filter(Boolean).join(""),u=Boolean(p?.trim().length),h=(u||n.optionLabel,`\n        <div class="cartuplift-modal-variants${u?" cartuplift-modal-variants--multi":" cartuplift-modal-variants--simple"}">\n          ${d}\n          ${u?`<div class="cartuplift-variant-groups">${p}</div>`:""}\n          ${u?'<div class="cartuplift-variant-helper" data-variant-helper role="status" aria-live="polite"></div>':""}\n        </div>\n      `);return`\n        <div class="cartuplift-modal-backdrop">\n          <div class="cartuplift-modal-content">\n            <button class="cartuplift-modal-close" aria-label="Close">\n              <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">\n                <path d="M18 6L6 18M6 6l12 12"/>\n              </svg>\n            </button>\n            \n            <div class="cartuplift-modal-product">\n              <div class="cartuplift-modal-image">\n                <img src="${t.featured_image||""}" alt="${t.title}" />\n              </div>\n              \n              <div class="cartuplift-modal-details">\n                <h2 class="cartuplift-modal-title">${this.settings.enableRecommendationTitleCaps?t.title.toUpperCase():t.title}</h2>\n                <div class="cartuplift-modal-price" data-price="${l}" data-base-price="${l}">\n                  ${this.formatMoney(l)}\n                </div>\n                \n                ${t.description?`\n                  <div class="cartuplift-modal-description">\n                    ${t.description.substring(0,200)}${t.description.length>200?"...":""}\n                  </div>\n                `:""}\n                \n                ${h}\n                \n                <button class="cartuplift-modal-add-btn" data-grid-index="${e??""}">\n                  Add to Cart\n                </button>\n              </div>\n            </div>\n          </div>\n        </div>\n      `}attachProductModalHandlers(t,e,i,n){const a=t.querySelector(".cartuplift-modal-close"),r=t.querySelector(".cartuplift-modal-backdrop"),s=t.querySelector(".cartuplift-modal-add-btn"),o=t.querySelector(".cartuplift-modal-price"),c=t.querySelector(".cartuplift-variant-select"),l=n||this.prepareVariantModalState(e);a.addEventListener("click",(()=>this.closeProductModal(t))),r.addEventListener("click",(e=>{e.target===r&&this.closeProductModal(t)})),this.setupVariantInteractions(t,e,l,{addButton:s,priceDisplay:o,disableAddForSoldOut:!0,soldOutLabel:"Sold Out"}),s.addEventListener("click",(async()=>{const e=s.dataset.variantId||(c?c.value:null);e&&(await this.addToCart(e,1),this.closeProductModal(t),void 0!==i&&setTimeout((()=>{this.swapInNextRecommendation(parseInt(i,10))}),500))}));const d=e=>{"Escape"===e.key&&this.closeProductModal(t)};document.addEventListener("keydown",d),t._keyHandler=d}closeProductModal(t){t.classList.remove("show"),t.classList.add("hiding"),setTimeout((()=>{t._keyHandler&&document.removeEventListener("keydown",t._keyHandler),t._cleanupResize&&t._cleanupResize(),t.remove(),this._modalOpening=!1}),300)}async showGiftModal(t){if(!this.isOpen)return void(this._pendingGiftModal=t);const i=document.querySelector(".cartuplift-gift-modal");if(this._modalOpening||i)return;if(document.querySelector(".cartuplift-product-modal"))return this._giftModalRetryTimer&&clearTimeout(this._giftModalRetryTimer),void(this._giftModalRetryTimer=setTimeout((()=>{this._giftModalRetryTimer=null,this.showGiftModal(t)}),450));this._modalOpening=!0;try{if(!t.productHandle||"string"!=typeof t.productHandle)return e.error(" Invalid product handle:",t.productHandle),void(this._modalOpening=!1);const i=await fetch(`/products/${t.productHandle}.js`);if(!i.ok)return e.error(" Failed to fetch product:",t.productHandle),void(this._modalOpening=!1);const n=await i.json(),a=this.prepareVariantModalState(n);if(!a.variantsToRender.length)return e.error(" No variants available for gift modal"),void(this._modalOpening=!1);const r=document.createElement("div");r.className="cartuplift-gift-modal",r.style.zIndex="1000001",r.innerHTML=this.generateGiftModalHTML(n,t,a),document.body.appendChild(r);const s=r.querySelector(".cartuplift-modal-content"),o=document.querySelector("#cartuplift-cart-popup .cartuplift-drawer"),c=()=>{if(!s||!o)return;const t=o.getBoundingClientRect();s.style.width=`${t.width}px`,s.style.maxWidth=`${t.width}px`,s.style.height=`${t.height}px`,s.style.maxHeight=`${t.height}px`};c(),window.addEventListener("resize",c),r._cleanupResize=()=>window.removeEventListener("resize",c),this.attachGiftModalHandlers(r,n,t,a),requestAnimationFrame((()=>{r.classList.add("show","active"),this._modalOpening=!1,this._giftModalRetryTimer&&(clearTimeout(this._giftModalRetryTimer),this._giftModalRetryTimer=null)}))}catch(t){e.error(" Error showing gift modal:",t),this._modalOpening=!1,this._giftModalRetryTimer&&(clearTimeout(this._giftModalRetryTimer),this._giftModalRetryTimer=null)}}generateGiftModalHTML(t,e,i){const n=i||this.prepareVariantModalState(t),a=Array.isArray(n.allVariants)?n.allVariants:[],r=Array.isArray(n.optionNames)?n.optionNames:[],s=n.initialVariant,o=n.defaultVariantId,c=(e.title,s?this.escapeHtml(this.formatVariantDisplayName(t,s)):this.escapeHtml(n.optionLabel||"Select an option"),`\n        <select id="cartuplift-gift-variant-select" class="cartuplift-variant-select cartuplift-variant-select--hidden" aria-hidden="true" tabindex="-1">\n          ${a.length?a.map((e=>{if(!e||void 0===e.id||null===e.id)return"";const i=String(e.id),n=this.escapeHtml(this.formatVariantDisplayName(t,e));return`\n          <option value="${i}" data-available="${!1!==e.available?"true":"false"}"${o&&o===i?" selected":""}>\n            ${n}\n          </option>\n        `})).join(""):'\n          <option value="" disabled selected>Currently unavailable</option>\n        '}\n        </select>\n      `),l=r.map(((t,e)=>{const i=n.optionValueSets?.get(t);if(!i||0===i.size)return"";const a=Array.isArray(n.optionValueOrder?.get(t))?n.optionValueOrder.get(t):[],r=new Set,s=[];if(a.length&&a.forEach((t=>{"string"==typeof t&&i.has(t)&&(r.has(t)||(s.push(t),r.add(t)))})),i.forEach((t=>{"string"==typeof t&&(r.has(t)||(s.push(t),r.add(t)))})),!s.length)return"";const o=s.map((i=>{const n=this.escapeHtml(i);return`\n            <button type="button" class="cartuplift-variant-pill" data-option-name="${this.escapeHtml(t)}" data-option-index="${e}" data-option-value="${n}" data-available="true" aria-pressed="false">\n              <span class="cartuplift-variant-pill-label">${n}</span>\n            </button>\n          `})).join("");return`\n          <div class="cartuplift-variant-group" data-option-name="${this.escapeHtml(t)}">\n            <div class="cartuplift-variant-group-header">\n              <span class="cartuplift-variant-group-label">${this.escapeHtml(t)}</span>\n            </div>\n            <div class="cartuplift-variant-group-values">\n              ${o}\n            </div>\n          </div>\n        `})).filter(Boolean).join(""),d=Boolean(l?.trim().length),p=(d||n.optionLabel,`\n        <div class="cartuplift-modal-variants${d?" cartuplift-modal-variants--multi":" cartuplift-modal-variants--simple"}">\n          ${c}\n          ${d?`<div class="cartuplift-variant-groups">${l}</div>`:""}\n          ${d?'<div class="cartuplift-variant-helper" data-variant-helper role="status" aria-live="polite"></div>':""}\n        </div>\n      `);return`\n        <div class="cartuplift-modal-backdrop">\n          <div class="cartuplift-modal-content">\n            <button class="cartuplift-modal-close" aria-label="Close">\n              <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">\n                <path d="M18 6L6 18M6 6l12 12"/>\n              </svg>\n            </button>\n            \n            <div class="cartuplift-modal-product">\n              <div class="cartuplift-modal-image">\n                <img src="${t.featured_image||""}" alt="${t.title}" />\n              </div>\n              \n              <div class="cartuplift-modal-details">\n                <div class="cartuplift-gift-badge-professional">Congratulations! You've unlocked a free gift</div>\n                <h2 class="cartuplift-modal-title">${this.settings.enableRecommendationTitleCaps?t.title.toUpperCase():t.title}</h2>\n                <div class="cartuplift-modal-price cartuplift-gift-price" data-price="0" data-base-price="0">\n                  Complimentary (${this.formatMoney(0)})\n                </div>\n                \n                ${t.description?`\n                  <div class="cartuplift-modal-description">\n                    ${t.description.substring(0,200)}${t.description.length>200?"...":""}\n                  </div>\n                `:""}\n                \n                ${p}\n                \n                <div class="cartuplift-modal-actions">\n                  <button class="cartuplift-modal-add-btn cartuplift-gift-add-btn-professional">\n                    Add to Cart\n                  </button>\n                  <button class="cartuplift-modal-skip-btn">\n                    Continue Shopping\n                  </button>\n                </div>\n              </div>\n            </div>\n          </div>\n        </div>\n      `}attachGiftModalHandlers(t,e,i,n){const a=t.querySelector(".cartuplift-modal-close"),r=t.querySelector(".cartuplift-modal-backdrop"),s=t.querySelector(".cartuplift-modal-add-btn"),o=t.querySelector(".cartuplift-modal-skip-btn"),c=t.querySelector(".cartuplift-variant-select"),l=n||this.prepareVariantModalState(e);let d=i.productId;"string"==typeof d&&d.includes("gid://shopify/Product/")&&(d=d.replace("gid://shopify/Product/",""));const p=`gift_declined_${d}`,u=()=>{sessionStorage.setItem(p,"true"),this.closeGiftModal(t)};a.addEventListener("click",u),r.addEventListener("click",(t=>{t.target===r&&u()})),o&&o.addEventListener("click",u),this.setupVariantInteractions(t,e,l,{addButton:s,priceDisplay:t.querySelector(".cartuplift-modal-price"),updatePrice:!1,disableAddForSoldOut:!0,soldOutLabel:"Sold Out"}),s.addEventListener("click",(async()=>{const e=s.dataset.variantId||(c?c.value:null);e&&(sessionStorage.removeItem(p),await this.addGiftVariantToCart(e,i),this.closeGiftModal(t))}));const h=e=>{"Escape"===e.key&&(sessionStorage.setItem(p,"true"),this.closeGiftModal(t))};document.addEventListener("keydown",h),t._keyHandler=h,t._declinedKey=p}closeGiftModal(t){t.classList.remove("show"),t.classList.add("hiding"),setTimeout((()=>{t._keyHandler&&document.removeEventListener("keydown",t._keyHandler),t._cleanupResize&&t._cleanupResize(),t.remove(),this._giftModalRetryTimer&&(clearTimeout(this._giftModalRetryTimer),this._giftModalRetryTimer=null),this._modalOpening=!1}),300)}syncGiftModalDimensions(t){const e=document.querySelector(".cartuplift-drawer");if(!e)return;const i=e.getBoundingClientRect(),n=t.querySelector(".cartuplift-modal-content");n&&(n.style.width=`${i.width}px`,n.style.maxWidth=`${i.width}px`)}async addGiftVariantToCart(t,i){try{const n=await fetch("/cart/add.js",{method:"POST",headers:{"Content-Type":"application/json","X-Requested-With":"XMLHttpRequest"},body:JSON.stringify({id:t,quantity:1,properties:{_is_gift:"true",_gift_title:i?.title?String(i.title):"Gift",_gift_label:i?.title?String(i.title):"Gift"},selling_plan:null})}),a=await n.json();return n.ok?(await this.fetchCart(),this.updateDrawerContent(),!0):(e.error(" Failed to add gift variant:",a),!1)}catch(t){return e.error(" Error adding gift to cart:",t),!1}}removeInvalidRecommendation(t){if(this.recommendations&&Array.isArray(this.recommendations)&&(this.recommendations=this.recommendations.filter((e=>(e.variant_id||e.variantId||e.id).toString()!==t.toString())),this.isOpen)){const t=document.getElementById("cartuplift-recommendations-content");t&&(t.innerHTML=this.getRecommendationItems())}}async loadRecommendations(){try{this.recommendationEngine||(this.recommendationEngine=new r(this));const t=await this.recommendationEngine.getRecommendations();if(this._allRecommendations=t,this._recommendationsLocked=!0,this.rebuildRecommendationsFromMaster(),this._recommendationsLoaded=!0,this.isOpen){const t=document.getElementById("cartuplift-recommendations-content");t&&(t.innerHTML=this.getRecommendationItems())}}catch(t){e.error("ðŸ›’ Error loading smart recommendations:",t),await this.loadRecommendationsFallback()}}async loadRecommendationsFallback(){try{let t="",i=[];const n=this.normalizeMaxRecommendations(this.settings.maxRecommendations);if(this.cart?.items&&this.cart.items.length>0){t=`/recommendations/products.json?product_id=${this.cart.items[0].product_id}&limit=${n}`}else t=`/products.json?limit=${n}`;const a=await fetch(t);if(a.ok){i=(await a.json()).products||[]}const r=Math.max(3*n,n+8);if(i.length<r)try{const t=Math.max(2*r,20),e=await fetch(`/products.json?limit=${t}`);if(e.ok){const t=(await e.json()).products||[],n=i.map((t=>t.id)),a=t.filter((t=>!n.includes(t.id)&&t.variants&&t.variants.length>0&&t.variants[0].available)),s=r-i.length;i=i.concat(a.slice(0,s))}}catch(t){e.error("ðŸ›’ Error loading fallback products:",t)}if(this._allRecommendations=i.map((t=>({id:t.id,title:t.title,priceCents:this.normalizePriceToCents(t.variants?.[0]?.price),image:t.images?.[0]?t.images[0].src||t.images[0]:t.featured_image||"https://via.placeholder.com/150x150?text=No+Image",variant_id:t.variants?.[0]?t.variants[0].id:null,url:t.handle?`/products/${t.handle}`:t.url||"#",variants:(t.variants||[]).map((t=>({...t,price_cents:this.normalizePriceToCents(t.price)}))),options:t.options||[]}))).filter((t=>t.variant_id)),this.recommendationEngine&&this.recommendationEngine.trackRecommendationsServed(this.cart,this._allRecommendations).catch((t=>e.warn("ML tracking failed (non-critical):",t))),this._recommendationsLocked=!0,this.rebuildRecommendationsFromMaster(),this.isOpen){const t=document.getElementById("cartuplift-recommendations-content");t&&(t.innerHTML=this.getRecommendationItems())}this._recommendationsLoaded=!0}catch(t){e.error("ðŸ›’ Error loading fallback recommendations:",t),this.recommendations=[],this._recommendationsLoaded=!0}}updateDrawerContent(){const t=document.querySelector("#cartuplift-cart-popup");if(!t)return;const e=t.querySelector(".cartuplift-content-wrapper"),i=e?e.scrollTop:0,n=this.getDrawerHTML();t.innerHTML=n;const a=document.getElementById("cartuplift-app-container");a&&(a.dataset.eventsAttached="false"),this.attachDrawerEvents();const r=t.querySelector(".cartuplift-content-wrapper");r&&i>0&&requestAnimationFrame((()=>{r.scrollTop=i})),this.settings.enableRecommendations&&this._recommendationsLoaded&&this.refreshRecommendationLayout()}computeEstimatedDiscount(t){try{const e=this.cart?.attributes||{},i=e.discount_code||this._lastDiscountCode,n=this._lastDiscountKind||e.discount_kind,a=this._lastDiscountPercent||(e.discount_percent?Number(e.discount_percent):void 0),r=this._lastDiscountAmountCents||(e.discount_amount_cents?Number(e.discount_amount_cents):void 0);if(!i)return{estimatedDiscountCents:0,hasDiscount:!1,discountLabel:""};let s=0;if("percent"===n&&"number"==typeof a&&a>0){const e=a>0&&a<=1?100*a:a,i=Math.min(e,100);s=Math.round(i/100*t)}else"amount"===n&&"number"==typeof r&&r>0&&(s=Math.min(r,t));return{estimatedDiscountCents:s,hasDiscount:s>0,discountLabel:i}}catch(t){return{estimatedDiscountCents:0,hasDiscount:!1,discountLabel:""}}}async checkAndAddGiftThresholds(){if(!this.settings.enableGiftGating)return;if(!this.settings.giftThresholds)return;if(!this.cart)return;if(this.settings.suppressAutoAdd)return this.checkAndShowGiftPreview();try{const t=JSON.parse(this.settings.giftThresholds);if(!Array.isArray(t))return void e.warn("Gift thresholds is not an array:",typeof t);if(0===t.length)return;const i=this.getDisplayedTotalCents();for(const n of t){if("product"!==n.type||!n.productId||!n.productHandle)continue;const t=i>=100*(n.amount||0);let a=n.productId;"string"==typeof a&&a.includes("gid://shopify/Product/")&&(a=a.replace("gid://shopify/Product/",""));const r=`gift_declined_${a}`,s=this.cart.items.filter((t=>t.product_id.toString()===a.toString()));let o=0,c=0,l=0;for(const t of s)o+=t.quantity,t.properties&&"true"===t.properties._is_gift?c+=t.quantity:l+=t.quantity;if(e.log("   Quantities:",{total:o,gift:c,paid:l}),t)if(0===c){const t=sessionStorage.getItem(r);e.log(" DECISION:",{giftInCart:!1,hasDeclined:!!t,willShowModal:!t}),t?e.log(" âŠ˜ SKIP: Gift previously declined by customer"):(e.log(" âœ“ ACTION: Showing gift modal for customer to add gift"),await this.showGiftModal(n))}else e.log(" âœ“ Gift already claimed, no action needed");else if(sessionStorage.removeItem(r),e.log(" âŠ˜ Threshold not reached yet"),c>0){e.log(" âš ï¸ Removing gift from cart (threshold no longer met)");for(const t of s)t.properties&&"true"===t.properties._is_gift&&await this.removeGiftFromCart(n,t)}}e.log(" ========================================"),e.log(" GIFT THRESHOLD CHECK COMPLETE"),e.log(" ========================================")}catch(t){e.error(" âŒ ERROR in gift threshold check:",t),e.log(" Raw gift thresholds setting:",this.settings.giftThresholds),e.log(" ========================================")}}async checkAndShowGiftPreview(){if(this.settings.giftThresholds)try{const t=JSON.parse(this.settings.giftThresholds);if(!Array.isArray(t)||0===t.length)return;let i=this.getDisplayedTotalCents();if(0===i){const n=t.filter((t=>"product"===t.type&&"free_shipping"!==t.type&&t.amount&&t.amount>0)).map((t=>t.amount));if(n.length>0){const t=Math.min(...n);i=100*(t+10),e.log(" Design mode: Simulating cart total to trigger preview for threshold:",t)}}e.log(" Design mode preview - Current total (simulated):",i/100);const n=[];for(const e of t){if("product"!==e.type||!e.productId||!e.productHandle)continue;if("free_shipping"===e.type)continue;const t=100*(e.amount||0);i>=t&&n.push({title:e.title||"Gift Item",amount:e.amount||0})}n.length>0&&(e.log(" Design mode: Showing preview for",n.length,"eligible gifts"),this._previewGiftItems=n.map((t=>({product_title:t.title,price:0,quantity:1,properties:{_is_gift:"true",_gift_title:t.title,_original_price:100*t.amount}}))),this.updateDrawerContent())}catch(t){e.error(" Error in gift preview:",t)}}async addGiftToCart(t){try{let e=t.productId;return"string"==typeof e&&e.includes("gid://shopify/Product/")&&(e=e.replace("gid://shopify/Product/","")),await this.addGiftByHandle(t)}catch(t){return e.error(" Error adding gift to cart:",t),!1}}async addGiftByHandle(t){try{if(!t.productHandle||"string"!=typeof t.productHandle)return e.error(" Invalid product handle:",t.productHandle,"type:",typeof t.productHandle),!1;const i=await fetch(`/products/${t.productHandle}.js`);if(!i.ok)return e.error(` Failed to fetch product: ${t.productHandle}`),!1;const n=await i.json(),a=n.variants?.[0];if(!a)return e.error(` No variants found for product: ${t.productHandle}`),!1;const r=await fetch("/cart/add.js",{method:"POST",headers:{"Content-Type":"application/json","X-Requested-With":"XMLHttpRequest"},body:JSON.stringify({id:a.id,quantity:1,properties:{_is_gift:"true",_gift_title:t?.title?String(t.title):"Gift",_gift_label:t?.title?String(t.title):"Gift",_original_price:a.price.toString()},selling_plan:null})}),s=await r.json();return r.ok?(await this.fetchCart(),this.updateDrawerContent(),!0):(e.error(" Failed to add gift variant:",s),!1)}catch(t){return e.error(" Error in addGiftByHandle:",t),!1}}async splitItemAddGift(t,i){try{const n=this.cart.items.findIndex((e=>e.key===t.key))+1;if(0===n)return e.error(" Could not find line index for cart item:",t),!1;const a=Math.max(0,t.quantity-1);if(a>0){const i=new FormData;if(i.append("line",n),i.append("quantity",a),t.properties)for(const[e,n]of Object.entries(t.properties))i.append(`properties[${e}]`,n);const r=await fetch("/cart/change.js",{method:"POST",body:i});if(!r.ok)return e.error(" Failed to reduce paid item quantity",r.status),!1}else{const i=new FormData;i.append("id",t.key),i.append("quantity","0");const n=await fetch("/cart/change.js",{method:"POST",body:i});if(!n.ok)return e.error(" Failed to remove paid item",n.status),!1}return await this.addGiftToCart(i),!0}catch(t){return e.error(" Error splitting item to add gift:",t),!1}}async convertItemToGift(t,i){try{const n=t.original_line_price||t.line_price||t.price*t.quantity,a=this.cart.items.findIndex((e=>e.key===t.key))+1;if(0===a)return e.error("ðŸŽ Could not find line index for cart item:",t),!1;const r={...t.properties,_is_gift:"true",_gift_title:i?.title?String(i.title):"Gift",_gift_label:i?.title?String(i.title):"Gift",_gift_threshold_id:i.id.toString(),_original_price:n.toString()},s=new FormData;s.append("line",a),s.append("quantity",t.quantity);for(const[t,e]of Object.entries(r))s.append(`properties[${t}]`,e);const o=await fetch("/cart/change.js",{method:"POST",body:s});if(o.ok){const t=await o.json();return this.cart=t,this.updateDrawerContent(),!0}{const t=await o.json();return e.error("ðŸŽ Failed to convert item to gift:",t),!1}}catch(t){return e.error("ðŸŽ Error converting item to gift:",t),!1}}async removeGiftFromCart(t,i=null){try{let n=t.productId;"string"==typeof n&&n.includes("gid://shopify/Product/")&&(n=n.replace("gid://shopify/Product/",""));let a=[];if(a=i?[i]:this.cart.items.filter((t=>t.product_id.toString()===n.toString()&&t.properties&&"true"===t.properties._is_gift)),a.length>0){for(const t of a){const i=new FormData;i.append("id",t.key),i.append("quantity","0");const n=await fetch("/cart/change.js",{method:"POST",body:i});if(!n.ok)return e.error("ðŸŽ Failed to remove gift",n.status),!1}return await this.fetchCart(),this.updateDrawerContent(),!0}return!1}catch(t){return e.error("ðŸŽ Error removing gift from cart:",t),!1}}getDisplayedTotalCents(){if(!this.cart||!this.cart.items)return 0;let t=0;return this.cart.items.forEach((e=>{e.properties&&"true"===e.properties._is_gift||(t+=e.original_line_price||e.line_price||e.price*e.quantity)})),t}tryAutoOpenDrawer(t=!1,e=0,i=5){this.isOpen||(this._isAnimating&&e<i?setTimeout((()=>this.tryAutoOpenDrawer(t,e+1,i)),100):this.openDrawer(t))}async openDrawer(t=!1){if(this._isAnimating||this.isOpen)return;if(!this.settings.enableApp)return;this._cartModified=this._cartModified||!1;this._cartModified;this._cartModified=!1,n.trackEvent("cart_open"),this._isAnimating=!0;const i=document.getElementById("cartuplift-app-container");if(!i)return e.error("CartUplift: App container not found in DOM!"),void(this._isAnimating=!1);if(!t){const t=Date.now();(this._lastCartFetch?t-this._lastCartFetch:1/0)>1e3&&await this.fetchCart(!0)}this.settings.enableRecommendations&&this._recommendationsLoaded&&this.rebuildRecommendationsFromMasterSync(),this.updateDrawerContent(),i.style.display="block",i.offsetHeight,i.classList.add("active"),document.documentElement.classList.add("cartuplift-no-scroll"),document.body.classList.add("cartuplift-no-scroll"),this.settings.enableRecommendations&&!this._recommendationsLoaded?this.loadRecommendations().then((()=>{this.rebuildRecommendationsFromMasterSync(),this.updateDrawerContent(),this.recommendations&&this.recommendations.length>0&&this.recommendations.forEach(((t,e)=>{n.trackEvent("impression",{productId:t.variant_id||t.id,variantId:t.variant_id,parentProductId:t.id,productTitle:t.title,source:"cart_drawer",position:e})}))})).catch((t=>{e.warn("Failed to load recommendations:",t)})):this.recommendations&&this.recommendations.length>0&&this.recommendations.forEach(((t,e)=>{n.trackEvent("impression",{productId:t.variant_id||t.id,variantId:t.variant_id,parentProductId:t.id,productTitle:t.title,source:"cart_drawer",position:e})})),setTimeout((()=>{if(this._isAnimating=!1,this.isOpen=!0,this._pendingGiftModal){e.log("ðŸŽ Drawer opened, showing pending gift modal");const t=this._pendingGiftModal;this._pendingGiftModal=null,setTimeout((()=>{this.showGiftModal(t)}),50)}}),350)}closeDrawer(){if(this._isAnimating||!this.isOpen)return;n.trackEvent("cart_close");const t=this._cartModified;this._isAnimating=!0;const i=document.getElementById("cartuplift-app-container");if(!i)return void(this._isAnimating=!1);i.classList.remove("active");const a=i.querySelector("#cartuplift-backdrop");if(a&&(a.style.pointerEvents="none",a.style.opacity="0",a.style.display="none"),t)return e.log("ðŸ”„ Cart was modified, hiding drawer and reloading"),i.style.display="none",i.style.visibility="hidden",document.documentElement.classList.remove("cartuplift-no-scroll"),document.body.classList.remove("cartuplift-no-scroll"),this._isAnimating=!1,this.isOpen=!1,void setTimeout((()=>{window.location.reload()}),50);setTimeout((()=>{i.style.display="none",this._isAnimating=!1,this.isOpen=!1,document.documentElement.classList.remove("cartuplift-no-scroll"),document.body.classList.remove("cartuplift-no-scroll"),a&&(a.style.pointerEvents="",a.style.opacity="",a.style.display="")}),350)}setupCartUpliftInterception(){document.addEventListener("click",(t=>{if(t.target.closest(['a[href="/cart"]','a[href^="/cart?"]',".cart-icon",".cart-link",".cart-toggle",".header__icon--cart",".site-header__cart","[data-cart-drawer-toggle]","cart-icon",".header-actions__cart-icon"].join(","))){if(!this.settings.enableApp)return;t.preventDefault(),t.stopPropagation(),this.openDrawer()}}),!0)}installAddToCartMonitoring(){const t=this;window.CartUpliftAAInternal||(window.CartUpliftAAInternal={observers:[],handlers:[],originals:{},seenEvents:new Set}),window.CartUpliftAAInternal.originals.fetch||(window.CartUpliftAAInternal.originals.fetch=window.fetch,window.fetch=async function(...i){const n=await window.CartUpliftAAInternal.originals.fetch.apply(this,i);try{if(t.settings.enableApp){const a=i[0]?i[0].toString():"",r=a.includes("/cart/add"),s=a.includes("/cart/change"),o=a.includes("/cart/update");if(r&&n.ok){n.clone();setTimeout((async()=>{try{let e=0,i=null;const n=3;for(;e<n;){e++;const a=Date.now(),r=await window.CartUpliftAAInternal.originals.fetch.call(window,`/cart.js?t=${a}`);if(i=await r.json(),i.item_count>0){t.cart=i,t._lastCartFetch=Date.now();break}e<n&&await new Promise((t=>setTimeout(t,150)))}t.cart=i||t.cart,t._lastCartFetch=Date.now(),await t.consolidateDuplicateCartItems(),t.updateDrawerContent(),await new Promise((t=>setTimeout(t,100))),await t.checkAndAddGiftThresholds(),t.settings.enableApp&&t.flyToCart(),t.settings.autoOpenCart&&t.settings.enableApp&&(t.hideThemeNotifications(),t.tryAutoOpenDrawer(!0))}catch(t){e.error("CartUplift: Cart add handler failed:",t)}}),100)}else n.ok&&(s||o)&&setTimeout((async()=>{try{await t.fetchCart(!0),t.settings.enableRecommendations&&t._recommendationsLoaded&&t.rebuildRecommendationsFromMasterSync(),t.updateDrawerContent()}catch(t){e.error("CartUplift: Cart update handler failed:",t)}}),50)}}catch(t){e.warn("CartUplift: Monitoring error:",t)}return n}),window.CartUpliftAAInternal.originals.xhrOpen||(window.CartUpliftAAInternal.originals.xhrOpen=XMLHttpRequest.prototype.open,window.CartUpliftAAInternal.originals.xhrSend=XMLHttpRequest.prototype.send,XMLHttpRequest.prototype.open=function(t,e,...i){return this._cartUpliftUrl=e,this._cartUpliftMethod=t,window.CartUpliftAAInternal.originals.xhrOpen.call(this,t,e,...i)},XMLHttpRequest.prototype.send=function(...i){return this._cartUpliftUrl?.includes("/cart/add")&&t.settings.enableApp?this.addEventListener("load",(function(){200===this.status&&setTimeout((async()=>{try{await t.fetchCart(),await t.consolidateDuplicateCartItems(),t.updateDrawerContent(),t.settings.enableApp&&t.flyToCart(),t.settings.autoOpenCart&&t.settings.enableApp&&(t.hideThemeNotifications(),t.tryAutoOpenDrawer())}catch(t){e.error("CartUplift: XHR cart add handler failed:",t)}}),50)})):this._cartUpliftUrl&&(this._cartUpliftUrl.includes("/cart/change")||this._cartUpliftUrl.includes("/cart/update"))&&this.addEventListener("load",(function(){200===this.status&&setTimeout((async()=>{try{await t.fetchCart(!0),t.settings.enableRecommendations&&t._recommendationsLoaded&&t.rebuildRecommendationsFromMasterSync(),t.updateDrawerContent()}catch(t){e.error("CartUplift: XHR cart update handler failed:",t)}}),50)})),window.CartUpliftAAInternal.originals.xhrSend.apply(this,i)})}formatMoney(t){const i="number"!=typeof t||Number.isNaN(t)?0:Math.round(t);try{if(window.Shopify&&"function"==typeof window.Shopify.formatMoney){const t=window.CartUpliftMoneyFormat||window.Shopify.money_format;if(t){let e=window.Shopify.formatMoney(i,t);return i%100==0&&(e=e.replace(/\.00$/,"").replace(/,00$/,"")),e}let e=window.Shopify.formatMoney(i);return i%100==0&&(e=e.replace(/\.00$/,"").replace(/,00$/,"")),e}}catch(t){e.warn("[CartUplift] formatMoney fallback due to Shopify.formatMoney error",t)}const n=(i/100).toFixed(2),a=(t=>{const e=t.split(".");return e[0]=e[0].replace(/\B(?=(\d{3})+(?!\d))/g,","),e.join(".")})(i%100==0?(i/100).toString():n);if(window.CartUpliftMoneyFormat)try{return window.CartUpliftMoneyFormat.replace(/\{\{\s*amount\s*\}\}/g,a)}catch{}try{const t=window.Shopify?.currency?.active||this.cart?.currency||"USD";return new Intl.NumberFormat(navigator.language||"en",{style:"currency",currency:t,minimumFractionDigits:2,maximumFractionDigits:2}).format(i/100)}catch(t){return e.warn("[CartUplift] Intl.NumberFormat failed, using generic format",t),a}}getCurrencySymbol(){try{const t=window.CartUpliftMoneyFormat||window.Shopify?.money_format;if(t){const e=t.match(/[^{}0-9.,\s]+/);if(e)return e[0].trim()}}catch(t){e.warn("[CartUplift] getCurrencySymbol error:",t)}try{const t=window.Shopify?.currency?.active||this.cart?.currency||"USD",e=new Intl.NumberFormat(navigator.language||"en",{style:"currency",currency:t}),i=e.format(0).match(/[^\d\s.,]+/);return i?i[0].trim():t}catch(t){return window.Shopify?.currency?.active||"USD"}}normalizePriceToCents(t){if(null==t||""===t)return 0;const e="number"==typeof t?t.toString():String(t).trim();if(!e)return 0;let i=e.replace(/[^0-9.,-]/g,"");if(!i)return 0;const n=i.includes(","),a=i.includes(".");if(n&&a?i=i.replace(/,/g,""):n&&!a&&(i=i.replace(/,/g,".")),i.includes(".")){const t=parseFloat(i);return Number.isNaN(t)?0:Math.round(100*t)}const r=i.replace(/\D/g,"");if(!r)return 0;if(r.length<=2){const t=parseInt(r,10);return Number.isNaN(t)?0:100*t}const s=parseInt(r,10);return Number.isNaN(s)?0:s}getFreeShippingThresholdCents(){try{const t=this.settings?.freeShippingThreshold;if(null==t||""===t)return null;let e;if("number"==typeof t)e=t;else if("string"==typeof t){const i=t.trim();if(!i)return null;let n=i.replace(/[^0-9.,-]/g,"");if(!n)return null;const a=n.includes(","),r=n.includes(".");if(a&&r)n=n.replace(/,/g,"");else if(a&&!r){const t=n.split(",");n=2===t.length&&3===t[1].length?n.replace(/,/g,""):n.replace(/,/g,".")}e=Number(n)}else e=Number(t);return!Number.isFinite(e)||e<=0?null:Math.round(100*e)}catch(t){return e.warn("ðŸ›’ Failed to normalize free shipping threshold:",t),null}}checkIfAllThresholdsMet(){try{const t=this.cart?.total_price||0,i=this.settings.freeShippingThresholdCents,n=!i||t>=i;let a=!0;if(this.settings.enableGiftGating&&this.settings.giftThresholds)try{const e=JSON.parse(this.settings.giftThresholds);if(e&&e.length>0){a=t>=Math.max(...e.map((t=>100*t.amount)))}}catch(t){e.warn("ðŸ›’ Failed to parse gift thresholds:",t)}return n&&a}catch(t){return e.warn("ðŸ›’ Failed to check threshold status:",t),!1}}filterRecommendationsForThreshold(t){try{if(!t||0===t.length)return[];const i=this.cart?.total_price||0,n=this.settings.thresholdSuggestionMode||"smart";let a=null,r=null;const s=this.settings.freeShippingThresholdCents;if(s&&i<s&&(a=s,r="shipping"),this.settings.enableGiftGating&&this.settings.giftThresholds)try{const t=JSON.parse(this.settings.giftThresholds);if(t&&t.length>0){const e=t.sort(((t,e)=>t.amount-e.amount)).find((t=>i<100*t.amount));if(e){const t=100*e.amount;(!a||t<a)&&(a=t,r="gift")}}}catch(t){e.warn("ðŸ›’ Failed to parse gift thresholds for filtering:",t)}if(!a)return t;const o=a-i,c=500,l=t.map((t=>{const e=t.variants?.[0]?.price||0,i=Math.abs(e-o),n=e>=o-c&&e<=o+c;return{...t,_thresholdPrice:e,_thresholdGap:i,_thresholdGoodFit:n,_thresholdType:r}}));let d=l;switch(n){case"price":d=l.filter((t=>t._thresholdGoodFit)),d.sort(((t,e)=>t._thresholdGap-e._thresholdGap));break;case"popular_price":d.sort(((t,e)=>t._thresholdGoodFit&&!e._thresholdGoodFit?-1:!t._thresholdGoodFit&&e._thresholdGoodFit?1:t._thresholdGap-e._thresholdGap));break;default:d.sort(((t,e)=>t._thresholdGoodFit&&!e._thresholdGoodFit?-1:!t._thresholdGoodFit&&e._thresholdGoodFit?1:t._thresholdGoodFit&&e._thresholdGoodFit?t._thresholdGap-e._thresholdGap:0))}return d.map((({_thresholdPrice:t,_thresholdGap:e,_thresholdGoodFit:i,_thresholdType:n,...a})=>a))}catch(i){return e.warn("ðŸ›’ Failed to filter recommendations for threshold:",i),t}}formatProductReview(t){const e=t.metafields||{};if(e["judgeme.reviews"]){const t=e["judgeme.reviews"];if(t.rating&&t.rating>0)return`â­ ${t.rating}`}if(e.yotpo?.reviews_average){const t=parseFloat(e.yotpo.reviews_average);if(t>0)return`â­ ${t.toFixed(1)}`}if(e.reviews?.rating){const t=parseFloat(e.reviews.rating);if(t>0)return`â­ ${t.toFixed(1)}`}if(e.spr?.reviews){const t="string"==typeof e.spr.reviews?JSON.parse(e.spr.reviews):e.spr.reviews;if(t.rating&&t.rating>0)return`â­ ${t.rating.toFixed(1)}`}return t.rating&&t.rating>0?`â­ ${parseFloat(t.rating).toFixed(1)}`:t.reviews_score&&t.reviews_score>0?`â­ ${parseFloat(t.reviews_score).toFixed(1)}`:""}processGiftNoticeTemplate(t,e,i=[]){if(!t||""===t.trim())return"";let n=t;n=n.replace(/\{\{?\s*amount\s*\}?\}/g,this.formatMoney(e)),n=n.replace(/\{\{?\s*gift_amount\s*\}?\}/g,this.formatMoney(e)),n=n.replace(/\{\{?\s*shipping_amount\s*\}?\}/g,"");const a=i.map((t=>t.product_title)).join(", ");return n=n.replace(/\{\{?\s*product\s*\}?\}/g,a),n=n.replace(/\s{2,}/g," ").trim().replace(/\s+\)/g,")"),n}proceedToCheckout(){n.trackEvent("checkout_start",{revenue:this.cart?this.cart.total_price/100:0});const t=document.getElementById("cartuplift-notes-input"),i=this.cart?.items?.filter((t=>t.properties&&"true"===t.properties._is_gift))||[];let a="";if(t?.value.trim()&&(a=t.value.trim()),i.length>0){a+=`\n\nGIFT ITEMS (FREE): ${i.map((t=>`${t.title} (${this.formatMoney(t.line_price)} - should be FREE)`)).join(", ")}`}const r=()=>{const t=(this.cart?.attributes||{}).discount_code;!window.Shopify?.designMode?window.location.href=t?`/checkout?discount=${encodeURIComponent(t)}`:"/checkout":e.info("[CartUplift] Design mode: suppressing real checkout redirect.",{code:t})};a.trim()?fetch("/cart/update.js",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({note:a.trim()})}).then(r):r()}installEarlyInterceptors(){window.CartUpliftAAInternal||(window.CartUpliftAAInternal={observers:[],handlers:[],originals:{}}),window.CartUpliftAAInternal.originals.shopifyPublish=window.Shopify?.publish;window.CartUpliftAAInternal.originals.themeFunctions={},["showCartNotification","openCartNotification","displayCartNotification","cartNotification","showNotification","showAddToCartNotification"].forEach((t=>{window[t]&&(window.CartUpliftAAInternal.originals.themeFunctions[t]=window[t]),window.theme?.[t]&&(window.CartUpliftAAInternal.originals.themeFunctions[`theme.${t}`]=window.theme[t])}));["cart-notification","shopify:cart:notification"].forEach((t=>{const e=t=>{window.cartUpliftDrawer?.settings.enableApp&&t.preventDefault()};document.addEventListener(t,e,!0),window.CartUpliftAAInternal.handlers.push({type:t,handler:e})}));["cart:add","cart:update","cart:change","add-to-cart","shopify:cart:add"].forEach((t=>{const e=e=>{window.cartUpliftDrawer?.settings.enableApp&&(window.CartUpliftAAInternal.seenEvents||(window.CartUpliftAAInternal.seenEvents=new Set),window.CartUpliftAAInternal.seenEvents.add(t))};document.addEventListener(t,e),window.CartUpliftAAInternal.handlers.push({type:t,handler:e})})),this._injectNotificationSuppressor(),this.observePaymentButtons(),setTimeout((()=>this.warnIfNoPaymentButtons()),8e3)}_injectNotificationSuppressor(){if(document.getElementById("cartuplift-aa-notification-suppressor"))return;const t=document.createElement("style");t.id="cartuplift-aa-notification-suppressor",t.textContent='\n\t\t\t\t/* CartUplift: Hide theme cart notifications and drawers when active */\n\t\t\t\t/* IMPORTANT: Be very specific - don\'t hide cart icons, links, or counts! */\n\n\t\t\t\t/* Hide notifications only */\n\t\t\t\tbody.cartuplift-active [class*="cart-notification"]:not([class*="icon"]):not([class*="link"]),\n\t\t\t\tbody.cartuplift-active [class*="add-to-cart-notification"],\n\t\t\t\tbody.cartuplift-active [id*="cart-notification"],\n\t\t\t\tbody.cartuplift-active .shopify-section--cart-notification,\n\t\t\t\tbody.cartuplift-active [data-cart-notification],\n\n\t\t\t\t/* Hide theme cart DRAWERS only - very specific selectors */\n\t\t\t\t/* Only target actual drawer containers, not icons/links/buttons */\n\t\t\t\tbody.cartuplift-active .drawer--cart:not(#cartuplift-drawer),\n\t\t\t\tbody.cartuplift-active [id^="CartDrawer"]:not(#cartuplift-drawer):not(a):not(button),\n\t\t\t\tbody.cartuplift-active [id$="CartDrawer"]:not(#cartuplift-drawer):not(a):not(button),\n\t\t\t\tbody.cartuplift-active .cart-drawer:not(#cartuplift-drawer):not([id^="cartuplift"]):not(a):not(button),\n\t\t\t\tbody.cartuplift-active [data-drawer="cart"]:not(#cartuplift-drawer):not(a):not(button),\n\t\t\t\tbody.cartuplift-active cart-drawer:not(#cartuplift-drawer),\n\t\t\t\tbody.cartuplift-active aside[id*="cart"]:not(#cartuplift-drawer),\n\t\t\t\tbody.cartuplift-active div[role="dialog"][id*="cart"]:not(#cartuplift-drawer) {\n\t\t\t\t\tdisplay: none !important;\n\t\t\t\t\topacity: 0 !important;\n\t\t\t\t\tvisibility: hidden !important;\n\t\t\t\t\tpointer-events: none !important;\n\t\t\t\t}\n\t\t\t',document.head.appendChild(t);document.addEventListener("cartuplift:item_added",(()=>{document.body.classList.add("cartuplift-active"),setTimeout((()=>{document.body.classList.remove("cartuplift-active")}),500)})),document.addEventListener("cartuplift:opened",(()=>{document.body.classList.add("cartuplift-active")})),document.addEventListener("cartuplift:closed",(()=>{document.body.classList.remove("cartuplift-active")}))}_restoreOriginalFunctions(){if(!window.CartUpliftAAInternal?.originals)return;const t=window.CartUpliftAAInternal.originals;window.theme?.cart&&(t.themeCartOpen&&(window.theme.cart.open=t.themeCartOpen),t.themeCartShow&&(window.theme.cart.show=t.themeCartShow)),window.CartUpliftAAInternal.observers&&(window.CartUpliftAAInternal.observers.forEach((t=>{try{t.disconnect()}catch(t){}})),window.CartUpliftAAInternal.observers=[]),window.CartUpliftAAInternal.handlers&&(window.CartUpliftAAInternal.handlers.forEach((({type:t,handler:e})=>{try{document.removeEventListener(t,e,!0),document.removeEventListener(t,e)}catch(t){}})),window.CartUpliftAAInternal.handlers=[]),document.body.classList.remove("cartuplift-active");const e=document.getElementById("cartuplift-aa-notification-suppressor");e&&e.remove()}observePaymentButtons(){try{if(this._expressObserverStarted)return;this._expressObserverStarted=!0;let t=document.getElementById("cartuplift-payment-probe");t||(t=document.createElement("div"),t.id="cartuplift-payment-probe",t.style.position="absolute",t.style.left="-9999px",t.style.top="-9999px",t.style.opacity="0",t.style.pointerEvents="none",t.innerHTML='<div class="additional-checkout-buttons" data-shopify="payment-button"></div>',document.body.appendChild(t));const e=t.querySelector(".additional-checkout-buttons")||t,i=new MutationObserver((()=>{const e=t.querySelector(".additional-checkout-buttons");if(e?.children&&e.children.length>0){try{this.mountExpressButtons()}catch(t){}i.disconnect()}}));i.observe(e,{childList:!0,subtree:!0})}catch(t){}}mountExpressButtons(){try{const t=document.querySelector(".cartuplift-express-slot");if(!t)return void e.warn("ðŸ”§ CartUplift: Express slot not found");let i=document.getElementById("cartuplift-payment-probe");if(!i){e.warn("ðŸ”§ CartUplift: Payment probe not found");const t=document.createElement("div");t.id="cartuplift-payment-probe",t.style.position="absolute",t.style.left="-9999px",t.style.top="-9999px",t.style.opacity="0",t.style.pointerEvents="none",t.innerHTML='<div class="additional-checkout-buttons" data-shopify="payment-button"></div>',document.body.appendChild(t),i=t}const n=i.querySelector(".additional-checkout-buttons");if(!n)return void e.warn("ðŸ”§ CartUplift: Additional checkout buttons wrapper not found");if(n.children.length){t.innerHTML="";const e=n.cloneNode(!0);e.style.position="static",e.style.opacity="1",e.style.pointerEvents="auto",e.style.transform="none",e.style.height="auto",t.appendChild(e),this._expressReady=!0,t.addEventListener("click",(t=>{const e=i.querySelector(".additional-checkout-buttons button, .shopify-payment-button");e&&e.click()}),{once:!0})}}catch(t){e.warn("Failed to mount express buttons:",t)}}warnIfNoPaymentButtons(){try{if(this._expressReady)return;if(this._expressWarned)return;if(!this.settings||!1===this.settings.enableExpressCheckout)return;const t=document.getElementById("cartuplift-payment-probe"),e=t?.querySelector(".additional-checkout-buttons");if((e?e.children.length:0)>0)return;this._expressWarned=!0}catch(t){}}hideThemeNotifications(){const t=()=>{[".product-form__notification",".cart-notification","cart-notification",".cart__notification","#CartNotification",".cart-popup",".added-to-cart-notification",".product__notification",".cart-notification-product",".js-cart-notification",".cart-notification-wrapper",".ajax-cart-popup",".cart-drawer:not(#cartuplift-cart-popup)","#CartDrawer:not(#cartuplift-cart-popup)",".cart-popup-wrapper",".ajax-cart__inner","[data-cart-success-message]",".added-to-cart",".cart-success",".cart-added",".add-to-cart-notification",".modal.cart",".modal-cart",".cart-modal",'[role="dialog"][class*="cart"]',".shopify-section .cart-notification","div[data-cart-notification]",".notification--cart"].forEach((t=>{const e=document.querySelectorAll(t);e.length,e.forEach((t=>{const e=t.id&&t.id.includes("cartuplift"),i=t.closest("header")||t.closest(".header")||t.closest(".site-header")||t.closest('[role="banner"]')||t.matches('a[href="/cart"]')||t.matches(".cart-link")||t.matches(".cart-icon")||t.matches("cart-icon")||t.matches(".header__icon--cart")||t.matches(".header-actions__cart-icon")||t.classList?.contains("header-actions__cart-icon")||"cart-icon"===t.tagName?.toLowerCase();e||i||(t.setAttribute("data-cartuplift-hidden","true"),t.style.setProperty("display","none","important"),t.style.setProperty("visibility","hidden","important"),t.style.setProperty("opacity","0","important"),t.classList.remove("active","is-active","is-visible","show","open"),t.style.transform="translateY(-100%)")}))}));document.querySelectorAll("*").forEach((t=>{if(t.textContent&&(t.textContent.includes("Item added to your cart")||t.textContent.includes("Added to cart")||t.textContent.includes("added to your cart"))&&!t.id?.includes("cartuplift")){!(t.closest("header")||t.closest(".header")||t.closest(".site-header")||t.closest('[role="banner"]'))&&t.childElementCount<10&&(t.setAttribute("data-cartuplift-hidden","true"),t.style.setProperty("display","none","important"),t.style.setProperty("visibility","hidden","important"),t.style.setProperty("opacity","0","important"))}}))};t(),setTimeout(t,50),setTimeout(t,100),setTimeout(t,200),setTimeout(t,500),this.preventThemeCartUplift()}preventThemeCartUplift(){if(!this.settings.enableApp)return;if(this._themeCartGuardInstalled)return;if(this._themeCartGuardInstalled=!0,window.CartUpliftAAInternal||(window.CartUpliftAAInternal={observers:[],handlers:[],originals:{},seenEvents:new Set}),window.theme?.cart){if(window.theme.cart.open&&!window.CartUpliftAAInternal.originals.themeCartOpen){window.CartUpliftAAInternal.originals.themeCartOpen=window.theme.cart.open;const t=this;window.theme.cart.open=function(...e){if(!window.cartUpliftDrawer?.settings.enableApp)return window.CartUpliftAAInternal.originals.themeCartOpen.apply(this,e);t.openDrawer()}}if(window.theme.cart.show&&!window.CartUpliftAAInternal.originals.themeCartShow){window.CartUpliftAAInternal.originals.themeCartShow=window.theme.cart.show;const t=this;window.theme.cart.show=function(...e){if(!window.cartUpliftDrawer?.settings.enableApp)return window.CartUpliftAAInternal.originals.themeCartShow.apply(this,e);t.openDrawer()}}}const t=['a[href="/cart"]','a[href^="/cart?"]',".header__icon--cart",".header-actions__cart-icon",".cart-link",".cart-icon","cart-icon",".js-drawer-open-cart",".js-cart-drawer-trigger","[data-cart-toggle]","[data-cart-trigger]","[data-header-cart-trigger]",'[data-action="open-cart"]','[data-action="toggle-cart"]','[data-drawer-target="cart"]','[data-open-drawer="cart"]','[aria-controls="CartDrawer"]','button[name="drawer-toggle"][value="cart"]','button[data-drawer-toggle="cart"]','button[data-drawer-toggle="drawer-cart"]',"button[data-cart-drawer-trigger]"].join(","),i=()=>{try{this.openDrawer()}catch(t){e.warn("[CartUplift] Failed to open drawer after intercepting cart trigger",t)}},n=(t,n)=>{if(t){try{e.info(`[CartUplift] Intercepted cart trigger (${n})`)}catch(t){}t.preventDefault?.(),t.stopPropagation?.(),t.stopImmediatePropagation?.(),setTimeout(i,0)}};document.addEventListener("click",(e=>{if(!t)return;const i=e.target?.closest?.(t);i&&n(e,"click")}),!0),document.addEventListener("keydown",(e=>{if(!t)return;if("Enter"!==e.key&&" "!==e.key)return;const i=e.target?.closest?.(t);i&&n(e,"keyboard")}),!0);["cart:open","cart:toggle","cart-drawer:open","cart-drawer:toggle","cart-drawer-open","cart-drawer-toggle","toggle-cart","theme:cart-open","theme:cart-toggle","drawer:open","drawer:toggle"].forEach((t=>{const e=e=>{if("drawer:open"===t||"drawer:toggle"===t){const t=e?.detail?.id||e?.detail?.target||e?.detail?.drawerId;if(t&&!/cart/i.test(String(t)))return}n(e,t)};window.addEventListener(t,e,!0),document.addEventListener(t,e,!0)}));const a=t=>{t&&!t._cartUpliftInterceptInstalled&&(t.addEventListener("click",(t=>n(t,"<cart-icon>")),!0),t._cartUpliftInterceptInstalled=!0)};document.querySelectorAll("cart-icon").forEach(a),this._cartTriggerObserver||(this._cartTriggerObserver=new MutationObserver((t=>{t.forEach((t=>{t.addedNodes.forEach((t=>{1===t.nodeType&&(t.matches?.("cart-icon")&&a(t),t.querySelectorAll?.("cart-icon").forEach(a))}))}))})),this._cartTriggerObserver.observe(document.documentElement,{childList:!0,subtree:!0}))}setupNotificationBlocker(){new MutationObserver((t=>{t.forEach((t=>{t.addedNodes.forEach((t=>{if(1===t.nodeType){if(t.closest?.("header")||t.closest?.(".header")||t.closest?.(".site-header")||t.closest?.('[role="banner"]')||t.matches?.('a[href="/cart"]')&&t.closest?.("header, .header, .site-header")||t.matches?.("cart-icon")||t.matches?.(".header-actions__cart-icon")||"cart-icon"===t.tagName?.toLowerCase())return;(t.classList&&(t.classList.contains("cart-notification")||t.classList.contains("cart-popup")||t.classList.contains("ajax-cart-popup")||t.classList.contains("product__notification")||t.classList.contains("cart-drawer"))||t.id&&(t.id.includes("CartNotification")||t.id.includes("cart-notification"))||t.hasAttribute("data-cart-notification")||t.textContent&&(t.textContent.includes("added to your cart")||t.textContent.includes("Added to cart")||t.textContent.includes("Item added")))&&!t.id?.includes("cartuplift")&&(t.style.setProperty("display","none","important"),t.style.setProperty("visibility","hidden","important"),t.style.setProperty("opacity","0","important"),setTimeout((()=>{t.parentNode&&t.remove()}),100))}}))}))})).observe(document.body,{childList:!0,subtree:!0})}getVariantOptionsHTML(t){if(t.variant_title&&t.options_with_values&&Array.isArray(t.options_with_values)){return t.options_with_values.filter((t=>t&&"string"==typeof t.name&&"string"==typeof t.value)).filter((t=>"title"!==t.name.trim().toLowerCase())).filter((t=>"default title"!==t.value.trim().toLowerCase())).map((t=>`<div class="cartuplift-item-variant">${t.name}: ${t.value}</div>`)).join("")}const e=[];if(Array.isArray(t.variant_options)&&Array.isArray(t.options)&&t.variant_options.forEach(((i,n)=>{const a=t.options[n]||`Option ${n+1}`;if(!i)return;const r=String(a).trim().toLowerCase(),s=String(i).trim().toLowerCase();"title"!==r&&"default title"!==s&&e.push(`<div class="cartuplift-item-variant">${a}: ${i}</div>`)})),t.properties&&"object"==typeof t.properties&&Object.entries(t.properties).forEach((([t,i])=>{i&&"__proto__"!==t&&!t.startsWith("_")&&e.push(`<div class="cartuplift-item-variant">${t}: ${i}</div>`)})),e.length)return e.join("");if(t.variant_title){const e=String(t.variant_title).trim(),i=e.toLowerCase(),n=String(t.product_title||"").trim().toLowerCase();if(i&&"default title"!==i&&"title"!==i&&i!==n)return`<div class="cartuplift-item-variant">${e}</div>`}return""}}class r{constructor(t){this.cartUplift=t,this.purchasePatterns=null,this.productCache=new Map,this.complementRules=new Map,this.manualRules=new Map,this.initializeEngine()}async initializeEngine(){this.loadPurchasePatterns().catch((t=>e.error("ðŸ¤– Failed to load purchase patterns:",t))),this.initializeComplementDetection(),this.loadManualRules()}initializeComplementDetection(){const t={"running|athletic|sport|sneaker|trainer|strider":["performance socks","insoles","water bottle","gym towel","fitness tracker","socks","athletic socks"],"dress shoe|formal shoe|oxford|loafer":["dress socks","shoe horn","leather care","belt","tie"],"winter boot|snow boot|hiking boot":["wool socks","boot spray","insoles","foot warmers"],"sandal|flip.?flop|slides":["foot cream","toe separator","beach bag"],"men.?s.*shoe|women.?s.*shoe|shoe.*men|shoe.*women":["socks","insoles","shoe care","laces","foot spray"],"dress shirt|formal shirt|button.?up":["tie","cufflinks","collar stays","undershirt","blazer"],"suit|blazer|sport coat":["dress shirt","tie","pocket square","belt","dress shoes"],"jeans|denim":["belt","casual shirt","sneakers","jacket"],"dress|gown|formal wear":["jewelry","heels","handbag","wrap","necklace"],"sweater|cardigan|jumper":["scarf","boots","leggings","undershirt"],"t.?shirt|tee|casual shirt":["jeans","shorts","sneakers","jacket"],"jacket|coat|outerwear":["scarf","gloves","hat","boots"],"laptop|computer|macbook|notebook":["laptop bag","mouse","keyboard","monitor","laptop stand","sleeve","docking station"],"phone|iphone|android|smartphone":["case","screen protector","charger","wireless charger","headphones","car mount"],"tablet|ipad":["tablet case","stylus","keyboard","stand","screen protector"],"headphones|earbuds|airpods":["case","cleaning kit","adapter","stand","wireless charger"],"camera|dslr|mirrorless":["memory card","camera bag","lens","tripod","battery","lens filter"],"gaming|xbox|playstation|nintendo":["controller","headset","game","charging station","carry case"],"coffee maker|espresso|french press":["coffee beans","filters","mug","milk frother","cleaning tablets","grinder"],"blender|mixer|food processor":["smoothie cups","recipe book","protein powder","cleaning brush"],"kitchen knife|chef knife":["cutting board","knife sharpener","knife block","kitchen towel","sharpening stone"],"cookware|pan|pot|skillet":["spatula","cooking oil","seasoning","cookbook","trivet"],"skincare|moisturizer|serum|cream":["cleanser","toner","sunscreen","face mask","applicator"],"makeup|foundation|lipstick|mascara":["makeup brush","mirror","makeup remover","primer","setting spray"],"perfume|fragrance|cologne":["travel spray","body lotion","shower gel","deodorant"],"hair care|shampoo|conditioner":["hair mask","hair oil","brush","hair ties","towel"],"yoga mat|yoga":["yoga blocks","strap","water bottle","yoga pants","meditation cushion","towel"],"weights|dumbbell|barbell":["gym gloves","weight rack","resistance bands","protein shake","gym bag"],"bicycle|bike|cycling":["helmet","bike lock","water bottle","bike lights","repair kit","pump"],"tennis|racket|racquet":["tennis balls","grip tape","wristband","tennis bag","string"],"swimming|swimsuit|goggles":["swim cap","towel","sunscreen","flip flops","swim bag"],"plants|succulent|houseplant":["pot","plant food","watering can","plant stand","grow light","soil"],"candle|home fragrance":["candle holder","wick trimmer","matches","tray","snuffer"],"furniture|chair|table|sofa":["cushions","throw pillows","blanket","rug","lamp"],"bedding|sheets|pillows":["mattress protector","blanket","throw pillows","laundry detergent"],"baby clothes|infant wear":["diapers","baby lotion","bib","pacifier","baby blanket","wipes"],"toy|game|puzzle":["batteries","storage box","play mat","educational books","cleaning wipes"],"stroller|car seat":["car seat protector","stroller organizer","sun shade","rain cover"],"car|automotive|vehicle":["car charger","air freshener","cleaning supplies","floor mats","sunshade"],"book|textbook|novel":["bookmark","reading light","book stand","notebook","pen"],"notebook|journal|planner":["pen","pencil","ruler","stickers","bookmark"],"wine|alcohol|spirits":["wine glass","opener","decanter","wine cooler","cheese"],"tea|coffee":["mug","honey","biscuits","milk","sugar"],"spices|seasoning|herbs":["spice rack","measuring spoons","mortar pestle","cookbook"]};for(const[e,i]of Object.entries(t))this.complementRules.set(new RegExp(e,"i"),{complements:i,confidence:.87,source:"automatic"})}loadManualRules(){const t=this.cartUplift.settings.manualComplementRules||"{}";try{const e=JSON.parse(t);for(const[t,i]of Object.entries(e))this.manualRules.set(new RegExp(t,"i"),{complements:Array.isArray(i)?i:[i],confidence:.95,source:"manual"})}catch(t){e.error("ðŸ¤– Failed to parse manual complement rules:",t)}}async getRecommendations(){try{const t=this.cartUplift.cart,i=this.cartUplift.settings.complementDetectionMode||"automatic",n=(this.cartUplift.settings.manualRecommendationProducts||"").trim();if(n.length>0){const e=await this.getManualProductRecommendations(n);if(e.length>0)return this.trackRecommendationsServed(t,e).catch((t=>{})),e}if(!t||!t.items||0===t.items.length){const i=await this.getPopularProducts();return this.trackRecommendationsServed(t,i).catch((t=>e.warn("ML tracking failed (non-critical):",t))),i}let a=[];if("manual"===i)a=await this.getManualRuleRecommendations(t);else if("automatic"===i)a=await this.getSmartRecommendations(t);else if("hybrid"===i){const e=await this.getManualRuleRecommendations(t),i=await this.getSmartRecommendations(t);a=[...e,...i]}0===a.length&&(a=await this.getPopularProducts());const r=this.deduplicateAndScore(a),s=await this.ensureMinCount(r);return this.trackRecommendationsServed(t,s).catch((t=>e.warn("ML tracking failed (non-critical):",t))),s}catch(t){e.error("ðŸ¤– Smart recommendations failed:",t);const i=await this.getShopifyRecommendations(),n=this.deduplicateAndScore(i),a=await this.ensureMinCount(n);return this.trackRecommendationsServed(this.cartUplift.cart,a).catch((t=>e.warn("ML tracking failed (non-critical):",t))),a}}async trackRecommendationsServed(t,e){try{if(!e||0===e.length)return;const i=(t?.items||[]).map((t=>{const e=t.product_id||t.id;return e?String(e):null})).filter(Boolean),n=e.map((t=>{const e=t.id||t.productId;return e?String(e).replace("gid://shopify/Product/",""):null})).filter(Boolean);if(0===n.length)return;const a={shop:window.Shopify?.shop||"",sessionId:this.cartUplift.sessionId||"",customerId:window.Shopify?.customer?.id||null,anchorProducts:i,recommendedProducts:n};(await fetch("/apps/cart-uplift/api/track-recommendations",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(a)})).ok}catch(t){}}async getManualProductRecommendations(t){const i=[],n=("string"==typeof t?t:this.cartUplift.settings.manualRecommendationProducts||"").trim();if(0===n.length)return i;const a=n.split(",").map((t=>t.trim())).filter(Boolean);e.log("ðŸŽ¯ Loading manual products:",a);for(const t of a)try{const n=t.replace("gid://shopify/ProductVariant/","").replace("gid://shopify/Product/",""),a=await this.fetchProductById(n);a&&(i.push({...a,score:.95,reason:"manual_selection",complementType:"manually_selected"}),e.log("âœ… Loaded manual product:",a.title))}catch(i){e.error("ðŸ› ï¸ Failed to load manual product:",t,i)}return i}async getManualRuleRecommendations(t){const i=[];if(this.cartUplift.settings.manualRecommendationProducts){const t=this.cartUplift.settings.manualRecommendationProducts.split(",").map((t=>t.trim())).filter(Boolean);for(const n of t)try{const t=n.replace("gid://shopify/ProductVariant/","").replace("gid://shopify/Product/",""),e=await this.fetchProductById(t);e&&i.push({...e,score:.95,reason:"manual_selection",complementType:"manually_selected"})}catch(t){e.error("ðŸ› ï¸ Failed to load manual product:",n,t)}}for(const e of t.items){const t=`${e.product_title} ${e.product_type||""}`.toLowerCase();for(const[e,n]of this.manualRules)if(e.test(t))for(const t of n.complements){(await this.searchProductsByKeyword(t)).forEach((e=>{i.push({...e,score:n.confidence,reason:"manual_rule",complementType:t})}))}}return i}async getSmartRecommendations(t){const e=[],i=await this.getComplementRecommendations(t);if(e.push(...i),this.purchasePatterns?.frequentPairs){const i=await this.getFrequentlyBoughtTogether(t);e.push(...i)}const n=await this.getPriceBasedRecommendations(t);e.push(...n);const a=await this.getSeasonalRecommendations();return e.push(...a),e}async getComplementRecommendations(t){const i=[],n=new Set;for(const e of t.items){const t=`${e.product_title} ${e.product_type||""}`.toLowerCase();for(const[e,i]of this.complementRules)e.test(t)&&i.complements.forEach((t=>n.add(t)))}for(const t of Array.from(n).slice(0,8))try{(await this.searchProductsByKeyword(t)).forEach((e=>{i.push({...e,score:.85,reason:"ai_complement",complementType:t})}))}catch(i){e.error("ðŸ¤– Failed to search for complement:",t,i)}return i}async getFrequentlyBoughtTogether(t){const e=[];for(const i of t.items){const t=i.product_id.toString(),n=this.purchasePatterns.frequentPairs[t];if(n)for(const[t,i]of Object.entries(n))if(i>.15){const n=await this.fetchProductById(t);n&&e.push({...n,score:i,reason:"frequently_bought"})}}return e}async getPriceBasedRecommendations(t){const e=[],i=t.total_price;let n;n=i>15e3?{min:2e3,max:8e3}:i>8e3?{min:1e3,max:4e3}:{min:500,max:2e3};return(await this.getProductsInPriceRange(n)).forEach((t=>{e.push({...t,score:.4,reason:"price_intelligence"})})),e}async getSeasonalRecommendations(){const t=[],e={11:["gift","holiday","winter","warm"],0:["new year","fitness","organization"],1:["valentine","red","romantic"],2:["spring","fresh","clean"],3:["easter","spring","pastel"],4:["mother","spring","floral"],5:["summer","beach","sun"],6:["summer","vacation","outdoor"],7:["back to school","summer","outdoor"],8:["back to school","autumn","cozy"],9:["halloween","orange","costume"],10:["thanksgiving","autumn","warm"]}[(new Date).getMonth()]||[];for(const i of e.slice(0,2)){(await this.searchProductsByKeyword(i)).forEach((e=>{t.push({...e,score:.3,reason:"seasonal_trending"})}))}return t}deduplicateAndScore(t){const e=new Set,i=t.filter((t=>!e.has(t.id)&&(e.add(t.id),!0)));return i.sort(((t,e)=>(e.score||0)-(t.score||0))),i}async searchProductsByKeyword(t){try{const e=Number(this.cartUplift.settings.maxRecommendations),i=(Number.isFinite,Number.isFinite(e)&&e>0?Math.floor(e):3),n=Math.max(i,3),a=[],r=await fetch(`/search/suggest.json?q=${encodeURIComponent(t)}&resources[type]=product&limit=${n}`);if(r.ok){const t=await r.json(),e=t.resources?.results?.products||[],i=await this.enrichProductsWithVariants(e,n);a.push(...i)}if(a.length<n){const e=await fetch("/products.json?limit=250");if(e.ok){const i=await e.json(),r=(i.products||[]).filter((e=>e.title.toLowerCase().includes(t.toLowerCase())||e.product_type?.toLowerCase().includes(t.toLowerCase())||e.tags?.some((e=>e.toLowerCase().includes(t.toLowerCase()))))).map((t=>this.formatProduct(t))).filter(Boolean),s=new Set(a.map((t=>t.id)));for(const t of r)if(!s.has(t.id)&&(a.push(t),s.add(t.id),a.length>=n))break}}return a.slice(0,n)}catch(i){e.error(`ðŸ¤– Search failed for ${t}:`,i)}return[]}async enrichProductsWithVariants(t,e=8){const i=[];if(!Array.isArray(t)||0===t.length)return i;const n=Math.min(e,t.length),a=t=>{if(t.handle)return t.handle;if(t.url){const e=t.url.match(/\/products\/([^/?#]+)/);if(e)return e[1]}return null};for(let e=0;e<t.length&&i.length<n;e++){const n=t[e];if(n.variants?.[0]?.id){const t=this.formatProduct(n);t&&i.push(t);continue}const r=a(n);if(r)try{const t=await fetch(`/products/${r}.js`);if(t.ok){const e=await t.json(),n=this.formatProduct(e);n&&i.push(n)}}catch(t){}}return i}async ensureMinCount(t){try{const e=Number(this.cartUplift.settings.maxRecommendations),i=(Number.isFinite,Number.isFinite(e)&&e>0?Math.floor(e):3),n=Math.max(i,3);if(t.length>=n)return t;const a=await this.getPopularProducts(),r=this.deduplicateAndScore([...t,...a]);return r.slice(0,Math.max(n,r.length))}catch(e){return t}}async getProductsInPriceRange(t){try{const e=Number(this.cartUplift.settings.maxRecommendations),i=(Number.isFinite,Number.isFinite(e)&&e>0?Math.floor(e):3),n=Math.max(i,3),a=await fetch("/products.json?limit=50");if(a.ok){const e=await a.json();return(e.products||[]).filter((e=>{const i=e.variants?.[0]?.price||0;return i>=t.min&&i<=t.max})).slice(0,n).map((t=>this.formatProduct(t))).filter(Boolean)}}catch(t){e.error("ðŸ¤– Price range search failed:",t)}return[]}async fetchProductById(t){if(this.productCache.has(t))return this.productCache.get(t);try{const e=await fetch("/products.json?limit=250");if(e.ok){const i=await e.json(),n=i.products?.find((e=>e.id.toString()===t.toString()));if(n){const e=this.formatProduct(n);return this.productCache.set(t,e),e}}}catch(i){e.error(`ðŸ¤– Failed to fetch product ${t}:`,i)}return null}async getPopularProducts(){try{const t=Number(this.cartUplift.settings.maxRecommendations),e=(Number.isFinite,Number.isFinite(t)&&t>0?Math.floor(t):3),i=Math.max(e,3),n=["best-sellers","featured","popular","trending","new"];for(const t of n){const e=await fetch(`/collections/${t}/products.json?limit=${i}`);if(e.ok){const t=await e.json();if(t.products?.length>0)return t.products.map((t=>this.formatProduct(t))).filter(Boolean)}}const a=await fetch(`/products.json?limit=${i}`);if(a.ok){return((await a.json()).products||[]).map((t=>this.formatProduct(t))).filter(Boolean)}}catch(t){e.error("ðŸ¤– Failed to get popular products:",t)}return[]}async getShopifyRecommendations(){try{const t=Number(this.cartUplift.settings.maxRecommendations),e=(Number.isFinite,Number.isFinite(t)&&t>0?Math.floor(t):3),i=Math.max(e,3);if(this.cartUplift.cart?.items?.length>0){const t=this.cartUplift.cart.items[0].product_id,e=await fetch(`/recommendations/products.json?product_id=${t}&limit=${i}`);if(e.ok){return((await e.json()).products||[]).map((t=>this.formatProduct(t))).filter(Boolean)}}}catch(t){e.error("ðŸ¤– Shopify recommendations failed:",t)}return[]}formatProduct(t){let i=t?.variants?.[0]?.price||t?.price||0,n=null;if(t&&Array.isArray(t.variants)&&t.variants.length>0){const e=t.variants[0];e?.id&&(n=e.id)}if(n||t&&(t.variant_id||t.id&&(t.product_id||t.product||t.product_title))&&(n=t.variant_id||t.id,i||!t.price&&!t.final_price||(i=t.price||t.final_price)),!n){try{e.warn("ðŸš¨ Product has no valid variant ID, excluding:",{id:t?.id,title:t?.title||t?.product_title,handle:t?.handle,url:t?.url,hasVariantsArray:Array.isArray(t?.variants),variantsLen:Array.isArray(t?.variants)?t.variants.length:0})}catch(t){}return null}return{id:t.id,title:t.title||t.product_title||"Untitled",handle:t.handle||null,priceCents:this.cartUplift.normalizePriceToCents(i),image:t.featured_image?.src||t.featured_image||t.image||t.images?.[0]?.src||t.media?.[0]?.preview_image?.src||"https://via.placeholder.com/150",variant_id:n,url:t.url||(t.handle?`/products/${t.handle}`:"#"),variants:(t.variants||[]).map((t=>({...t,price_cents:this.cartUplift.normalizePriceToCents(t.price)}))),options:t.options||[]}}async loadPurchasePatterns(){try{const t=window.CartUpliftShop||window.location.hostname,e=await fetch(`/apps/cart-uplift/api/purchase-patterns?shop=${encodeURIComponent(t)}`);e.ok?this.purchasePatterns=await e.json():this.purchasePatterns={frequentPairs:{}}}catch(t){e.error("ðŸ¤– Failed to load purchase patterns:",t),this.purchasePatterns={frequentPairs:{}}}}}window.CartUpliftDrawer=a;const s="[data-bundle-widget]";function o(t,i=!1){try{if(!document.querySelector(s))return;if(i&&(window.CartUpliftBundlesLoaded=!1,window.CartUpliftBundlesLoading=!1),window.CartUpliftBundlesLoaded||window.CartUpliftBundlesLoading)return;const n=function(){try{const t=window.CartUpliftAssets?.bundleScriptUrl;if(t)return t;const e=document.querySelector('script[src*="cart-uplift.js"]');if(e?.src){const t=e.src.split("cart-uplift.js");if(t.length>=2)return`${t[0]}cart-bundles.js${t[1]}`}}catch(t){e.warn("[CartUplift][Bundles] Failed to derive bundle script URL",t)}return null}();if(!n)return void e.warn(`[CartUplift][Bundles] Missing bundle script URL (reason: ${t})`);window.CartUpliftBundlesLoading=!0;const a=document.createElement("script");a.src=n,a.defer=!0,a.onload=()=>{window.CartUpliftBundlesLoaded=!0,window.CartUpliftBundlesLoading=!1},a.onerror=i=>{window.CartUpliftBundlesLoading=!1,e.error(`[CartUplift][Bundles] Failed to load module via ${t}`,i)},document.head.appendChild(a)}catch(i){e.error(`[CartUplift][Bundles] Unexpected error during lazy load (${t})`,i)}}function c(){if(document.querySelector(s)&&o("initial-check"),"undefined"!=typeof MutationObserver){const t=new MutationObserver((t=>{for(const e of t)for(const t of e.addedNodes)if(1===t.nodeType&&(t.matches?.(s)||t.querySelector?.(s)))return void o("mutation-observer")}));t.observe(document.body,{childList:!0,subtree:!0}),window.CartUpliftBundleObserver=t}}function l(){if(!window.cartUpliftDrawer&&window.CartUpliftSettings)try{window.cartUpliftDrawer=new a(window.CartUpliftSettings)}catch(t){e.error("[CartUplift] âŒ Drawer initialization failed:",t)}else window.CartUpliftSettings?window.cartUpliftDrawer&&e.log("[CartUplift] â„¹ï¸ Drawer already initialized, skipping"):e.warn("[CartUplift] âš ï¸ Settings not available, drawer not initialized")}function d(){window.CartUpliftSettings&&!window.cartUpliftDrawer&&l()}!function(){try{document.body?c():document.addEventListener("DOMContentLoaded",c),"loading"===document.readyState&&document.addEventListener("DOMContentLoaded",(()=>{setTimeout((()=>o("fallback-check")),100)})),document.addEventListener("shopify:section:load",(()=>{o("section-load",!0)})),document.addEventListener("shopify:block:select",(()=>{o("block-select")})),document.addEventListener("visibilitychange",(()=>{if(!document.hidden){document.querySelector(s)&&!window.CartUpliftBundlesLoaded&&o("visibility-change")}}))}catch(t){e.warn("[CartUplift][Bundles] Failed to bootstrap lazy loader",t)}}(),window.CartUpliftSettings&&!window.cartUpliftDrawer&&l(),"loading"===document.readyState?document.addEventListener("DOMContentLoaded",d):window.cartUpliftDrawer||d(),document.addEventListener("cartuplift:settings:updated",d),setTimeout((()=>{!window.cartUpliftDrawer&&window.CartUpliftSettings&&(e.log("[CartUplift] Fallback initialization triggered"),d())}),500)})();