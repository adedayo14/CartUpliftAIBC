{% comment %}
  Cart Uplift - Frequently Bought Together (FBT)
  FBT display with AI-powered recommendations
  
  Author: Adedayo
{% endcomment %}

{%- comment -%} Anti-cache meta tags {%- endcomment -%}
<meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
<meta http-equiv="Pragma" content="no-cache">
<meta http-equiv="Expires" content="0">

{%- comment -%} Load CSS asset with aggressive cache busting {%- endcomment -%}
{%- assign timestamp = 'now' | date: '%s' -%}
{%- assign random = timestamp | times: 1337 | modulo: 99999 -%}
{%- assign cachebust = timestamp | append: random -%}
<link rel="stylesheet" href="{{ 'cart-bundles.css' | asset_url }}?v={{ timestamp }}&r={{ random }}&cb={{ cachebust }}">

{%- comment -%} Data will be fetched by JavaScript instead of preloading to avoid theme check warnings {%- endcomment -%}

{%- liquid
  assign bundle_enabled = block.settings.bundle_enabled
  assign display_style = block.settings.display_style
  assign bundle_subtitle = block.settings.bundle_subtitle
  assign heading_align = block.settings.heading_alignment | default: 'left'
  assign heading_spacing = block.settings.heading_bottom_spacing | default: 24
  assign btn_bg = block.settings.button_bg_color | default: '#000000'
  assign btn_text = block.settings.button_text_color | default: '#FFFFFF'
  assign btn_border_radius = block.settings.button_border_radius | default: 5
  assign bundle_bg_color = block.settings.bundle_background_color
  assign savings_color = block.settings.savings_badge_color
  assign show_savings = block.settings.show_savings_badge
  assign sale_price_color = block.settings.sale_price_color | default: '#000000'
  assign savings_badge_bg = block.settings.savings_badge_bg_color
  assign savings_badge_text = block.settings.savings_badge_text_color | default: '#FFFFFF'
-%}

{% if bundle_enabled %}
  {%- comment -%} Inject custom button and bundle styles {%- endcomment -%}
  <style>
    /* Apply button styling to all bundle buttons including mobile pill */
    .cartuplift-bundle-wrapper .cartuplift-bundle-add-button,
    .cartuplift-bundle-wrapper .add-bundle-btn,
    .cartuplift-bundle-wrapper .bundle-add-btn,
    .cartuplift-bundle-wrapper .bundle-mobile-pill {
      background-color: {{ btn_bg }} !important;
      color: {{ btn_text }} !important;
      border-radius: {{ btn_border_radius }}px !important;
    }
    .cartuplift-bundle-wrapper .cartuplift-bundle-add-button:hover,
    .cartuplift-bundle-wrapper .add-bundle-btn:hover,
    .cartuplift-bundle-wrapper .bundle-add-btn:hover,
    .cartuplift-bundle-wrapper .bundle-mobile-pill:hover {
      opacity: 0.9;
    }
    /* Ensure mobile pill text stays white regardless of sale price color */
    .cartuplift-bundle-wrapper .bundle-mobile-pill,
    .cartuplift-bundle-wrapper .bundle-mobile-pill *,
    .cartuplift-bundle-wrapper .bundle-mobile-pill .pill-label,
    .cartuplift-bundle-wrapper .bundle-mobile-pill .pill-price-sale,
    .cartuplift-bundle-wrapper .bundle-mobile-pill .pill-price-original,
    .cartuplift-bundle-wrapper .bundle-mobile-pill .pill-arrow {
      color: {{ btn_text }} !important;
    }
    /* Specific opacity for original price in mobile pill */
    .cartuplift-bundle-wrapper .bundle-mobile-pill .pill-price-original {
      opacity: 0.6;
    }
    .cartuplift-bundle-wrapper .clean-variant-selector {
      border-radius: {{ btn_border_radius }}px !important;
    }
    .cartuplift-bundle-wrapper .modal-variant-selector {
      border-radius: {{ btn_border_radius }}px !important;
    }
    .cartuplift-bundle-wrapper .bundle-header {
      text-align: {{ heading_align }};
    }
    {% if bundle_bg_color != blank %}
    .cartuplift-bundle-wrapper {
      background-color: {{ bundle_bg_color }} !important;
      padding: var(--cu-spacing-lg) 0 var(--cu-spacing-xxl) !important;
      border-radius: 0 !important;
      width: 100vw !important;
      max-width: 100vw !important;
      margin-left: calc(50% - 50vw) !important;
      margin-right: calc(50% - 50vw) !important;
      box-sizing: border-box !important;
      overflow: hidden !important;
    }
    {% endif %}
    .cartuplift-bundle-wrapper .cartuplift-bundle {
      margin-top: 0 !important;
    }
    .cartuplift-bundle-wrapper .cartuplift-bundles-heading {
      margin-top: {{ heading_spacing }}px !important;
      margin-bottom: var(--cu-spacing-lg) !important;
    }
    .cartuplift-bundle-wrapper .cartuplift-bundles-subtitle {
      margin-bottom: var(--cu-spacing-xl) !important;
    }
    {% if savings_color != blank %}
    .cartuplift-bundle-wrapper .savings-badge,
    .cartuplift-bundle-wrapper .cartuplift-bundle-savings {
      background-color: {{ savings_color }} !important;
    }
    {% endif %}
    {% if savings_badge_bg != blank %}
    .cartuplift-bundle-wrapper .savings-badge,
    .cartuplift-bundle-wrapper .cartuplift-bundle-savings {
      background-color: {{ savings_badge_bg }} !important;
    }
    {% endif %}
    {% if savings_badge_text != blank %}
    .cartuplift-bundle-wrapper .savings-badge,
    .cartuplift-bundle-wrapper .cartuplift-bundle-savings {
      color: {{ savings_badge_text }} !important;
    }
    {% endif %}
    {% if sale_price_color != blank %}
    /* Apply sale price color to desktop prices but NOT mobile pill button */
    .cartuplift-bundle-wrapper .discounted-price:not(.bundle-mobile-pill .discounted-price),
    .cartuplift-bundle-wrapper .bundle-total-price .discounted-price,
    .cartuplift-bundle-wrapper .modal-item-price .discounted-price,
    .cartuplift-bundle-wrapper .modal-total .discounted-price {
      color: {{ sale_price_color }} !important;
    }
    {% endif %}
    {% if show_savings == false %}
    .cartuplift-bundle-wrapper .savings-badge,
    .cartuplift-bundle-wrapper .cartuplift-bundle-savings {
      display: none !important;
    }
    {% endif %}
  </style>

  <div 
    class="cartuplift-bundle-wrapper"
    data-bundle-widget="true"
    data-product-id="{% if product %}{{ product.id }}{% endif %}"
    data-bundle-title="{{ block.settings.bundle_title | escape }}"
    data-bundle-subtitle="{{ bundle_subtitle | escape }}"
    data-display-style="{{ display_style }}"
    data-heading-align="{{ heading_align }}"
    data-bundle-bg-color="{{ bundle_bg_color }}"
    data-savings-color="{{ savings_color }}"
    data-show-savings="{{ show_savings }}"
  >
    {%- comment -%} Widget content loads instantly via JS - no loading spinner needed {%- endcomment -%}
  </div>
  
  {%- comment -%} Load JavaScript with aggressive cache busting {%- endcomment -%}
  <script src="{{ 'cart-bundles.js' | asset_url }}?v={{ timestamp }}&r={{ random }}&cb={{ cachebust }}" defer></script>
{% endif %}

{% schema %}
{
  "name": "Cart UpliftAI - FBT",
  "target": "section",
  "templates": ["product", "collection"],
  "settings": [
    {
      "type": "paragraph",
      "content": "Create and manage FBT recommendations in the CartUplift admin dashboard. Use these settings to control the display and styling on your storefront."
    },
    {
      "type": "checkbox",
      "id": "bundle_enabled",
      "label": "Enable FBT recommendations",
      "default": true,
      "info": "Show or hide FBT section on this page"
    },
    {
      "type": "inline_richtext",
      "id": "bundle_title",
      "label": "Section heading",
      "default": "Frequently bought together",
      "info": "Optional heading displayed above products"
    },
    {
      "type": "inline_richtext",
      "id": "bundle_subtitle",
      "label": "Section subtitle",
      "info": "Optional subtitle displayed below the heading"
    },
    {
      "type": "select",
      "id": "heading_alignment",
      "label": "Text alignment",
      "options": [
        {
          "value": "left",
          "label": "Left"
        },
        {
          "value": "center",
          "label": "Center"
        },
        {
          "value": "right",
          "label": "Right"
        }
      ],
      "default": "left",
      "info": "Alignment for section heading and subtitle"
    },
    {
      "type": "range",
      "id": "heading_bottom_spacing",
      "label": "Heading top spacing",
      "min": 0,
      "max": 100,
      "step": 4,
      "unit": "px",
      "default": 24,
      "info": "Space above the heading (between product details and bundle section)"
    },
    {
      "type": "header",
      "content": "Layout"
    },
    {
      "type": "select",
      "id": "display_style",
      "label": "Display style",
      "options": [
        {
          "value": "grid",
          "label": "Grid"
        },
        {
          "value": "clean",
          "label": "Inline"
        },
        {
          "value": "list",
          "label": "List"
        }
      ],
      "default": "clean"
    },
    {
      "type": "header",
      "content": "Bundle Styling"
    },
    {
      "type": "color",
      "id": "bundle_background_color",
      "label": "Bundle background color",
      "info": "Background color for the entire bundle section"
    },
    {
      "type": "color",
      "id": "savings_badge_color",
      "label": "Savings badge color",
      "info": "Background color for the savings badge (deprecated - use settings below)"
    },
    {
      "type": "color",
      "id": "savings_badge_bg_color",
      "label": "Savings badge background",
      "info": "Background color for the 'Save $X' badge"
    },
    {
      "type": "color",
      "id": "savings_badge_text_color",
      "label": "Savings badge text color",
      "default": "#FFFFFF",
      "info": "Text color for the 'Save $X' badge"
    },
    {
      "type": "checkbox",
      "id": "show_savings_badge",
      "label": "Show savings badge",
      "default": true,
      "info": "Display the savings amount when bundle has a discount"
    },
    {
      "type": "header",
      "content": "Price Styling"
    },
    {
      "type": "color",
      "id": "sale_price_color",
      "label": "Sale price color",
      "default": "#000000",
      "info": "Color for the discounted/sale price (e.g., $48 in $60 â†’ $48)"
    },
    {
      "type": "header",
      "content": "Button style"
    },
    {
      "type": "color",
      "id": "button_bg_color",
      "label": "Background color",
      "default": "#000000"
    },
    {
      "type": "color",
      "id": "button_text_color",
      "label": "Text color",
      "default": "#FFFFFF"
    },
    {
      "type": "range",
      "id": "button_border_radius",
      "label": "Corner radius",
      "min": 0,
      "max": 50,
      "step": 5,
      "unit": "px",
      "default": 5,
      "info": "Controls the roundness of corners for buttons and dropdowns"
    }
  ]
}
{% endschema %}
