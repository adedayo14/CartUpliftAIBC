{% comment %} Cart Uplift ‚Äì Smart Cart App Embed {% endcomment %}
{% comment %} Version: v20.11 - Production Ready {% endcomment %}
{% assign cartuplift_version = '20.11' %}

{%- comment -%}
  CRITICAL: Hide native Shopify cart IMMEDIATELY before any scripts run
  This prevents the native cart from flashing or overlaying CartUplift
  We'll unhide it later if billing check fails
{%- endcomment -%}
<style id="cartuplift-native-cart-hide">
  /* CRITICAL: Hide native Shopify cart drawer completely - MAXIMUM PRIORITY */
  cart-drawer,
  cart-drawer[open],
  cart-drawer:not([open]),
  #CartDrawer,
  #CartDrawer[open],
  details.cart-drawer,
  details.cart-drawer[open],
  .drawer--cart,
  .drawer--cart[open],
  cart-drawer-items,
  .cart-drawer__overlay,
  .drawer__overlay,
  .cart-notification,
  cart-notification,
  #CartNotification {
    display: none !important;
    visibility: hidden !important;
    opacity: 0 !important;
    pointer-events: none !important;
    transition: none !important;
    z-index: -9999 !important;
    position: absolute !important;
    left: -99999px !important;
    top: -99999px !important;
    transform: translateX(-99999px) !important;
    width: 0 !important;
    height: 0 !important;
    overflow: hidden !important;
  }
  
  /* Prevent any animations or transitions on native cart */
  cart-drawer *,
  #CartDrawer *,
  .cart-drawer *,
  .drawer--cart * {
    animation: none !important;
    transition: none !important;
  }

  /* CRITICAL: Force cart icon to ALWAYS be visible - HIGHEST PRIORITY */
  header a[href="/cart"],
  header a[href*="/cart"],
  .header a[href="/cart"],
  .header a[href*="/cart"],
  .site-header a[href="/cart"],
  .site-header a[href*="/cart"],
  header .cart-icon,
  header .cart-link,
  .header .cart-icon,
  .header .cart-link,
  .site-header .cart-icon,
  .site-header .cart-link,
  cart-icon,
  .cart-icon,
  .cart-bubble,
  .cart-bubble__background,
  .cart-bubble__text,
  .cart-bubble__text-count,
  .header__icon--cart,
  .header-actions__cart-icon,
  [data-cart-icon],
  [data-header-cart-trigger],
  button[data-cart-drawer-trigger],
  .js-drawer-open-cart,
  a.header__icon.header__icon--cart {
    opacity: 1 !important;
    visibility: visible !important;
    display: inline-flex !important;
    pointer-events: auto !important;
  }
  
  /* Prevent cart-drawer elements from affecting their child cart icons */
  cart-drawer .cart-icon,
  cart-drawer cart-icon,
  #CartDrawer .cart-icon,
  #CartDrawer cart-icon,
  .cart-drawer .cart-icon {
    opacity: 1 !important;
    visibility: visible !important;
    display: inline-flex !important;
    pointer-events: auto !important;
  }
</style>

<script>
  // Check billing status - will unhide native cart if limit reached
  (function(){
    var cacheBust = Date.now();
    window.__cartUpliftBillingOK = null;

    try {
      var xhr = new XMLHttpRequest();
      xhr.open('GET', '/apps/cart-uplift/api/billing-check?_=' + cacheBust, false);
      xhr.send();

      if (xhr.status === 402 || xhr.status === 403) {
        window.__cartUpliftBillingOK = false;
        window.CartUpliftSettings = { enableApp: false };

        // Remove the CSS that hides native cart
        var hideStyle = document.getElementById('cartuplift-native-cart-hide');
        if (hideStyle) {
          hideStyle.remove();
        }
      } else if (xhr.status === 200) {
        window.__cartUpliftBillingOK = true;
      } else {
        window.__cartUpliftBillingOK = true;
      }
    } catch (e) {
      window.__cartUpliftBillingOK = true;
    }
  })();
</script>

<script>
  // Keep cart icon visible - prevent anything from hiding it
  (function() {
    function forceCartIconVisible() {
      var selectors = [
        'header a[href="/cart"]',
        'header a[href*="/cart"]',
        '.header a[href="/cart"]',
        '.header__icon--cart',
        '.cart-icon',
        '.cart-bubble',
        '.cart-bubble__background',
        '.cart-bubble__text',
        '.cart-bubble__text-count',
        'cart-icon',
        '[data-cart-icon]',
        '[data-header-cart-trigger]',
        'button[data-cart-drawer-trigger]',
        '.js-drawer-open-cart',
        'a.header__icon.header__icon--cart'
      ];

      selectors.forEach(function(selector) {
        try {
          var elements = document.querySelectorAll(selector);
          elements.forEach(function(el) {
            if (el && !el.id?.includes('cartuplift')) {
              el.style.setProperty('opacity', '1', 'important');
              el.style.setProperty('visibility', 'visible', 'important');
              el.style.setProperty('display', 'inline-flex', 'important');
              el.style.setProperty('pointer-events', 'auto', 'important');
            }
          });
        } catch (e) {}
      });
    }

    // Run immediately
    forceCartIconVisible();

    // Run after DOM loads
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', forceCartIconVisible);
    }

    // Run periodically but less frequently
    setInterval(forceCartIconVisible, 500);
  })();
</script>

{%- comment -%}
  Load CartUplift CSS if billing is OK
{%- endcomment -%}
<script>
  if (window.__cartUpliftBillingOK !== false) {
    // Load CartUplift CSS
    var link = document.createElement('link');
    link.rel = 'stylesheet';
    link.href = "{{ 'cart-uplift.css' | asset_url }}?v={{ cartuplift_version }}";
    document.head.appendChild(link);
  }
</script>

{%- comment -%}
  Preview and minor editor-only utilities
{%- endcomment -%}
  <style>
    /* Preview items styling for theme editor */
    .cartuplift-preview-item {
      opacity: 0.7;
      position: relative;
    }
    .cartuplift-preview-item .cartuplift-item-price-actions {
      position: relative;
    }
    .cartuplift-preview-item .cartuplift-item-price-actions::after {
      content: "PREVIEW";
      position: absolute;
      top: 75%;
      right: 0;
      transform: translateY(-50%);
      background: #00C851;
      color: white;
      font-size: 11px;
      padding: 4px 10px;
      border-radius: 16px;
      font-weight: 600;
      z-index: 10;
      line-height: 1;
      white-space: nowrap;
      box-shadow: 0 2px 6px rgba(0, 200, 81, 0.4);
      border: 1px solid #00A843;
    }
    .cartuplift-progress-text {
      color: #121212 !important;
      font-weight: 500;
      font-size: 14px;
      line-height: 1.4;
    }
    .cartuplift-gift-price {
      border: none !important;
      outline: none !important;
      box-shadow: none !important;
    }
  </style>

  <script>
    // Only run settings initialization if billing OK
    if (window.__cartUpliftBillingOK !== false) {
      (function(){
        try {
          // Detect Shopify theme editor design mode as early as possible
          var __isDesignMode = !!(window.Shopify && window.Shopify.designMode);

          // Share asset origins so the runtime can lazy-load optional modules like bundles
          (function registerAssetManifest(){
            try {
              var bundleScriptUrl = "{{ 'cart-bundles.min.js' | asset_url }}?v=prodcheck3&t={{ 'now' | date: '%s' }}";
              window.CartUpliftAssets = Object.assign({}, window.CartUpliftAssets || {}, {
                bundleScriptUrl: bundleScriptUrl
              });
            } catch(__assetErr) {
              // Asset manifest preparation failed
            }
          })();

          window.CartUpliftSettings = Object.assign({}, window.CartUpliftSettings || {}, {
          // Cart Behavior (controlled by theme setting in design mode)
          keepCartOpen: __isDesignMode ? {{ block.settings.keep_cart_open | json }} : false,
          autoOpenCart: {{ block.settings.auto_open_cart | json }},
          
          // Incentives
          incentiveType: {{ block.settings.incentive_type | json }},
          // cart-uplift.js expects these exact keys
          enableFreeShipping: {{ block.settings.enable_free_shipping_progress | json }},
          freeShippingText: {{ block.settings.progress_message | json }},
          freeShippingAchievedText: {{ block.settings.success_message | json }},
          freeShippingMaintainText: {{ block.settings.free_shipping_maintain_message | json }},
          freeShippingThreshold: {{ block.settings.free_shipping_threshold | json }},
                  shippingBarBackgroundColor: {{ block.settings.progress_background_color | json }},
          shippingBarColor: {{ block.settings.progress_bar_color | json }},
          giftBarColor: {{ block.settings.gift_bar_color | json }},
          // gift gating (only used when incentive type is gifts/combined)
          // giftThresholds will be set below as a JSON string when applicable

          // Gift & Rewards Settings
          allRewardsAchievedText: {{ block.settings.all_rewards_success_message | json }},
          giftThreshold: {{ block.settings.gift_threshold | json }},
          giftProgressText: {{ block.settings.gift_progress_message | json }},
          giftAchievedText: {{ block.settings.gift_success_message | json }},
          giftValueProgressText: {{ block.settings.gift_value_progress_message | json }},
          giftNoticeText: {{ block.settings.gift_notice_text | json }},

          // Cart Features - will be loaded from database settings below
          
          // Express Checkout (always enabled)
          enableExpressCheckout: true,

          // Recommendations positioning
          recommendationsScrollWithCart: {{ block.settings.recommendations_scroll_with_cart | json }},
          
          // Text styling
          enableProductTitleCaps: {{ block.settings.enable_product_title_caps | json }},
          enableRecommendationTitleCaps: {{ block.settings.uppercase_recommendation_title | json }},

          // Cart styling
          cartBackgroundColor: {{ block.settings.cart_background_color | json }},

          // App behavior
          enableApp: true,
          designMode: __isDesignMode,
          
          // Currency settings
          shopCurrency: {{ shop.currency | json }},
          moneyFormat: {{ shop.money_format | json }},
          moneyWithCurrencyFormat: {{ shop.money_with_currency_format | json }},
          
          // Product Recommendations
          // Use both keys for compatibility ‚Äì cart-uplift.js expects recommendationLayout (singular)
          recommendationsLayout: {{ block.settings.recommendations_layout | json }},
          recommendationLayout: {{ block.settings.recommendations_layout | json }},
          // Mark source so API refresh won't override theme editor selection
          recommendationLayoutSource: 'theme',
          recommendationsTitle: {{ block.settings.recommendations_title | json }},
          recommendationsBackgroundColor: {{ block.settings.recommendations_background_color | json }},
          maxRecommendations: {{ block.settings.recommendations_max_count | json }},
          manualRecommendationProducts: {{ block.settings.manual_recommendation_products | map: 'id' | join: ',' | json }},
          manualRecommendationProductsData: [
            {%- for product in block.settings.manual_recommendation_products -%}
              {
                id: {{ product.id | json }},
                handle: {{ product.handle | json }},
                title: {{ product.title | json }},
                price: {{ product.price | json }},
                compareAtPrice: {{ product.compare_at_price | json }},
                available: {{ product.available | json }},
                featuredImage: {% if product.featured_image %}{{ product.featured_image | json }}{% else %}null{% endif %},
                url: {{ product.url | json }},
                vendor: {{ product.vendor | json }},
                type: {{ product.type | json }}
              }{%- unless forloop.last -%},{%- endunless -%}
            {%- endfor -%}
          ],
          enableManualRecommendations: {% if block.settings.manual_recommendation_products.size > 0 %}true{% else %}false{% endif %}
        });

        (function enforceMaxRecommendationsRange(){
          var maxRec = parseInt(window.CartUpliftSettings.maxRecommendations, 10);
          if (!isFinite(maxRec) || maxRec < 1) {
            maxRec = 3;
          } else if (maxRec > 6) {
            maxRec = 6;
          }
          window.CartUpliftSettings.maxRecommendations = maxRec;
        })();

        // Notify any listeners immediately that settings have (re)loaded
        try { document.dispatchEvent(new CustomEvent('cartuplift:settings:updated')); } catch (_) {}

        // Set global money format for formatMoney function
        window.CartUpliftMoneyFormat = {{ shop.money_format | json }};

        // Sticky cart settings are now properly configured above in the main settings object

        // In design mode we greatly reduce side-effects so the iframe never triggers X-Frame-Options failures
        if (__isDesignMode) {
          try {
            // Disable analytics / polling style behaviors and any automatic gift auto-add logic later can check this flag
            window.CartUpliftSettings.enableAnalytics = false;
            window.CartUpliftSettings.suppressAutoAdd = true;

            // Keep cart open setting is now controlled by theme setting, not forced

            // Prevent accidental redirects initiated extremely early
            window.addEventListener('click', function(e){
              var t = e.target;
              if (!t) return;
              if (t.closest && t.closest('.cartuplift-checkout-btn, [data-checkout], form[action*="/checkout"], a[href*="/checkout"]')) {
                e.preventDefault();
                e.stopPropagation();
              }
            }, true);
          } catch(__e) { /* Design mode safe-guards partial failure */ }
        }

        // Normalize free shipping message placeholder to the token cart-uplift.js replaces
        try {
          const token = `{% raw %}{{ amount }}{% endraw %}`;
          if (typeof window.CartUpliftSettings.freeShippingText === 'string') {
            window.CartUpliftSettings.freeShippingText = window.CartUpliftSettings.freeShippingText.replace('{amount}', token);
          }
        } catch (_) {}

        // Parse gift messages and replace placeholders
        try {
          const amountToken = `{% raw %}{{ amount }}{% endraw %}`;
          const productToken = `{% raw %}{{ title }}{% endraw %}`;
          
          // Gift messages are now separate settings (no longer combined with |)
          const progressMsg = {{ block.settings.gift_progress_message | json }} || "Spend {amount} more to unlock {product}!";
          const successMsg = {{ block.settings.gift_success_message | json }} || "üéâ {product} unlocked!";
          
          window.CartUpliftSettings.giftProgressText = progressMsg;
          window.CartUpliftSettings.giftAchievedText = successMsg;
          
          // Replace placeholders
          if (typeof window.CartUpliftSettings.giftProgressText === 'string') {
            window.CartUpliftSettings.giftProgressText = window.CartUpliftSettings.giftProgressText
              .replace('{amount}', amountToken)
              .replace('{product}', productToken)
              .replace('{title}', productToken); // backward compatibility
          }
          if (typeof window.CartUpliftSettings.giftAchievedText === 'string') {
            window.CartUpliftSettings.giftAchievedText = window.CartUpliftSettings.giftAchievedText
              .replace('{product}', productToken)
              .replace('{title}', productToken); // backward compatibility
          }
        } catch (_) {}

        // Map incentive type to the script's progressBarMode values
        try {
          const type = window.CartUpliftSettings.incentiveType;
          const mode = type === 'gifts' ? 'gift-gating' : (type === 'combined' ? 'combined' : 'free-shipping');
          window.CartUpliftSettings.progressBarMode = mode;
        } catch (_) {}

        // Configure gift gating thresholds only when needed
        try {
          const giftAmount = {{ block.settings.gift_threshold | json }};
          const type = window.CartUpliftSettings.incentiveType;
          // Inject product selection from the theme setting if provided
          // Liquid will output these JS vars safely whether set or not
          {% if block.settings.gift_product %}
          var __giftProductId = {{ block.settings.gift_product.id | json }};
          var __giftProductHandle = {{ block.settings.gift_product.handle | json }};
          var __giftProductTitle = {{ block.settings.gift_product.title | json }};
          var __giftVariantId = {{ block.settings.gift_product.selected_or_first_available_variant.id | json }};
          var __giftVariantTitle = {{ block.settings.gift_product.selected_or_first_available_variant.title | json }};
          var __giftVariantPrice = {{ block.settings.gift_product.selected_or_first_available_variant.price | json }}; // cents
          {% else %}
          var __giftProductId = null;
          var __giftProductHandle = null;
          var __giftProductTitle = null;
          var __giftVariantId = null;
          var __giftVariantTitle = null;
          var __giftVariantPrice = null;
          {% endif %}

          if ((type === 'gifts' || type === 'combined') && Number(giftAmount)) {
            const threshold = {
              id: `gift-${__giftProductId || ('amount-' + Number(giftAmount))}`,
              type: 'product',
              amount: Number(giftAmount),
              title: __giftProductTitle || 'Free Gift',
              productId: __giftProductId,
              productHandle: __giftProductHandle,
              variantId: __giftVariantId,
              variantTitle: __giftVariantTitle,
              price: __giftVariantPrice
            };
            window.CartUpliftSettings.enableGiftGating = true;
            window.CartUpliftSettings.giftThresholds = JSON.stringify([threshold]);
          }
        } catch (_) {}
      } catch (e) {
        // Pre-settings initialization failed
      }
    })();
    } // End if billing OK check
  </script>

  <script>
    // API Bridge: Fetch database settings from app and merge with theme settings
    if (window.__cartUpliftBillingOK !== false) {
    (async function loadAppSettings() {
      try {
        const response = await fetch('/apps/cart-uplift/api/settings?shop={{ shop.permanent_domain }}');
        if (response.ok) {
          const dbSettings = await response.json();
          
          const existingThemeSettings = window.CartUpliftSettings || {};

          // Merge database settings with theme settings (theme values win)
          const dbSettingsNormalized = {
            // ML & AI Settings
            enableMLRecommendations: dbSettings.enableMLRecommendations,
            mlPersonalizationMode: dbSettings.mlPersonalizationMode,
            mlPrivacyLevel: dbSettings.mlPrivacyLevel,
            enableBehaviorTracking: dbSettings.enableBehaviorTracking,
            enableAdvancedPersonalization: dbSettings.enableAdvancedPersonalization,
            mlDataRetentionDays: dbSettings.mlDataRetentionDays,
            
            // Threshold Settings
            hideRecommendationsAfterThreshold: dbSettings.hideRecommendationsAfterThreshold,
            enableThresholdBasedSuggestions: dbSettings.enableThresholdBasedSuggestions,
            thresholdSuggestionMode: dbSettings.thresholdSuggestionMode,
            
            // Button Text Overrides
            checkoutButtonText: dbSettings.checkoutButtonText,
            addButtonText: dbSettings.addButtonText,
            applyButtonText: dbSettings.applyButtonText,
            
            // Cart Interaction (moved from theme editor)
            enableRecommendationTitleCaps: dbSettings.enableRecommendationTitleCaps,
            discountLinkText: dbSettings.discountLinkText,
            notesLinkText: dbSettings.notesLinkText,
            enableDiscountCode: Boolean(dbSettings.discountLinkText && dbSettings.discountLinkText.trim().length > 0),
            enableNotes: Boolean(dbSettings.notesLinkText && dbSettings.notesLinkText.trim().length > 0),
            
            // Gift Settings
            giftPriceText: dbSettings.giftPriceText,
            
            _dbSettingsLoaded: true
          };

          const mergedSettings = Object.assign({}, dbSettingsNormalized, existingThemeSettings);

          if (mergedSettings.discountLinkText !== undefined) {
            mergedSettings.enableDiscountCode = Boolean(mergedSettings.discountLinkText && mergedSettings.discountLinkText.trim().length > 0);
          }

          if (mergedSettings.notesLinkText !== undefined) {
            mergedSettings.enableNotes = Boolean(mergedSettings.notesLinkText && mergedSettings.notesLinkText.trim().length > 0);
          }

          window.CartUpliftSettings = mergedSettings;
          
          // Notify any listeners that settings have been updated with database values
          document.dispatchEvent(new CustomEvent('cartuplift:settings:updated'));
        }
      } catch (error) {
        // App settings fetch failed, using theme defaults
      }
    })();
  </script>

  <script>
    // Disable native Shopify theme cart animations
    (function() {
      try {
        // Override any existing cart animation functions
        if (window.theme && window.theme.cart && typeof window.theme.cart.addToCartAnimation === 'function') {
          window.theme.cart.addToCartAnimation = function() { /* disabled */ };
        }
        
        // Disable common animation classes
        const style = document.createElement('style');
        style.textContent = `
          .cart-drawer__item-animate,
          .cart-item-animate,
          .cart-animation,
          .add-to-cart-animation,
          [data-cart-animation] {
            animation: none !important;
            transition: none !important;
            transform: none !important;
          }
        `;
        document.head.appendChild(style);

        // Intercept and disable performance measurements that trigger animations
        if (window.performance && window.performance.measure) {
          const originalMeasure = window.performance.measure;
          window.performance.measure = function(name, ...args) {
            if (name && (name.includes('cart') || name.includes('add'))) {
              return; // Skip cart-related performance measurements
            }
            return originalMeasure.apply(this, [name, ...args]);
          };
        }

        // Intercept early cart page navigation
        const originalPushState = history.pushState;
        const originalReplaceState = history.replaceState;

        history.pushState = function(state, title, url) {
          if (url && url.toString().includes('/cart') && !url.toString().includes('/cart/add')) {
            if (window.cartUpliftDrawer) {
              window.cartUpliftDrawer.openDrawer();
            }
            return;
          }
          return originalPushState.apply(this, arguments);
        };

        history.replaceState = function(state, title, url) {
          if (url && url.toString().includes('/cart') && !url.toString().includes('/cart/add')) {
            if (window.cartUpliftDrawer) {
              window.cartUpliftDrawer.openDrawer();
            }
            return;
          }
          return originalReplaceState.apply(this, arguments);
        };

      } catch (e) {
        // Failed to disable native animations
      }
    })();
  </script>

  {%- comment -%} CRITICAL: Global cart interception MUST run before ANY other scripts {%- endcomment -%}
  <script>
    // CRITICAL: Ultra-aggressive native cart blocking - runs IMMEDIATELY
    (function() {
      // Only block if billing is OK (CartUplift should handle cart)
      if (window.__cartUpliftBillingOK === false) {
        return; // Let native cart work if billing failed
      }
      
      // NUCLEAR OPTION: Override cart-drawer web component registration
      if (window.customElements && !window.__cartUpliftCartBlocked) {
        window.__cartUpliftCartBlocked = true;
        
        try {
          // Intercept cart-drawer custom element before it's defined
          const originalDefine = window.customElements.define;
          window.customElements.define = function(name, constructor, options) {
            if (name === 'cart-drawer') {
              console.log('[CartUplift] Blocked cart-drawer web component registration');
              return; // Don't register native cart-drawer
            }
            return originalDefine.call(this, name, constructor, options);
          };
        } catch (e) {
          console.warn('[CartUplift] Failed to override customElements.define:', e);
        }
      }
      
      // Aggressive native cart blocking - runs every 50ms
      function forceCloseNativeCart() {
        var nativeElements = document.querySelectorAll('cart-drawer, #CartDrawer, details.cart-drawer, .drawer--cart');
        nativeElements.forEach(function(el) {
          if (el) {
            el.removeAttribute('open');
            el.setAttribute('hidden', '');
            el.style.cssText = 'display: none !important; visibility: hidden !important; opacity: 0 !important; pointer-events: none !important; z-index: -9999 !important; position: absolute !important; left: -99999px !important; top: -99999px !important;';
          }
        });
        
        // Remove cart-open classes from body/html
        document.body?.classList?.remove('cart-open', 'drawer-open', 'js-drawer-open-cart');
        document.documentElement?.classList?.remove('cart-open', 'drawer-open', 'js-drawer-open-cart');
      }
      
      // Run immediately and very frequently
      forceCloseNativeCart();
      setInterval(forceCloseNativeCart, 50);
      
      // Block ALL cart drawer clicks at capture phase (before theme handlers)
      const blockCartDrawer = (e) => {
        const target = e.target;
        if (!target) return;
        
        // Check if this is a cart trigger
        const isCartTrigger = 
          target.matches?.('a[href="/cart"]') ||
          target.matches?.('a[href^="/cart?"]') ||
          target.matches?.('.cart-icon') ||
          target.matches?.('cart-icon') ||
          target.matches?.('.header__icon--cart') ||
          target.matches?.('[data-cart-drawer-toggle]') ||
          target.matches?.('[data-cart-drawer-trigger]') ||
          target.closest?.('a[href="/cart"]') ||
          target.closest?.('.cart-icon') ||
          target.closest?.('cart-icon') ||
          target.closest?.('.header__icon--cart') ||
          target.closest?.('[data-cart-drawer-toggle]') ||
          target.closest?.('[data-cart-drawer-trigger]');
        
        if (isCartTrigger) {
          e.preventDefault();
          e.stopPropagation();
          e.stopImmediatePropagation();
          
          // Force close any native cart that might have opened
          setTimeout(forceCloseNativeCart, 0);
          setTimeout(forceCloseNativeCart, 10);
          setTimeout(forceCloseNativeCart, 50);
          
          // Open our drawer if available
          if (window.cartUpliftDrawer && typeof window.cartUpliftDrawer.openDrawer === 'function') {
            window.cartUpliftDrawer.openDrawer();
          } else {
            // Queue the open for when drawer is ready
            const openWhenReady = () => {
              if (window.cartUpliftDrawer && typeof window.cartUpliftDrawer.openDrawer === 'function') {
                window.cartUpliftDrawer.openDrawer();
              }
            };
            
            document.addEventListener('cartuplift:ready', openWhenReady, { once: true });

            // Fallback: check periodically for up to 2 seconds
            let attempts = 0;
            const checkInterval = setInterval(() => {
              attempts++;
              if (window.cartUpliftDrawer && typeof window.cartUpliftDrawer.openDrawer === 'function') {
                clearInterval(checkInterval);
                window.cartUpliftDrawer.openDrawer();
              } else if (attempts >= 20) {
                clearInterval(checkInterval);
              }
            }, 100);
          }
          return false;
        }
      };
      
      // Install at capture phase to intercept BEFORE theme handlers
      document.addEventListener('click', blockCartDrawer, true);
      document.addEventListener('touchend', blockCartDrawer, true);
      
      // Block keyboard activation too
      document.addEventListener('keydown', (e) => {
        if (e.key === 'Enter' || e.key === ' ') {
          blockCartDrawer(e);
        }
      }, true);
    })();
  </script>

  <script>
    // Only load cart-uplift.js if billing check passed
    if (window.__cartUpliftBillingOK !== false) {
    (function checkAndLoadCartUplift() {
      // Wait a moment for billing check to complete
      setTimeout(function() {
        if (window.CartUpliftSettings && window.CartUpliftSettings.enableApp === false) {
          return;
        }
        
        // Billing OK - load the main script (non-minified for testing)
        var script = document.createElement('script');
        script.src = "{{ 'cart-uplift.js' | asset_url }}?v={{ cartuplift_version }}";
        script.async = true;
        document.head.appendChild(script);
      }, 100);
    })();
    } // End billing check
  </script>

  <script>
    // Post-load configuration and resilience
    if (window.__cartUpliftBillingOK !== false) {
    (function initCartUpliftEditor() {
      const __isDesignMode = !!(window.Shopify && window.Shopify.designMode);
      let editorAutoOpenInterval = null; // Track interval globally to prevent duplicates

      // Wait for drawer to be ready
      const waitForDrawer = () => {
        // If the drawer didn't auto-init (e.g., due to timing), initialize it now
        if (!window.cartUpliftDrawer && window.CartUpliftDrawer && window.CartUpliftSettings) {
          try {
            window.cartUpliftDrawer = new window.CartUpliftDrawer(window.CartUpliftSettings);
          } catch(initErr) {
            // Drawer init failed
          }
        }
        
        // Notify of settings (for late listeners)
        document.dispatchEvent(new CustomEvent('cartuplift:settings:updated'));

        // Theme editor convenience: Keep cart open when toggle is enabled
        if (__isDesignMode && window.cartUpliftDrawer) {
          const keepCartOpenSetting = window.CartUpliftSettings.keepCartOpen;

          // Only auto-open if the setting is enabled AND we haven't already started the interval
          if (keepCartOpenSetting && window.Shopify && window.Shopify.designMode && !editorAutoOpenInterval) {
            // Use tryAutoOpenDrawer for reliable opening (handles animation conflicts)
            window.cartUpliftDrawer.tryAutoOpenDrawer(true); // skipFetch = true in editor
            
            // Auto-open cart every few seconds in design mode for editing convenience
            editorAutoOpenInterval = setInterval(() => {
              if (window.cartUpliftDrawer && !window.cartUpliftDrawer.isOpen) {
                window.cartUpliftDrawer.tryAutoOpenDrawer(true); // Use retry logic
              }
            }, 3000); // Every 3 seconds
            
            // Clean up interval when not in design mode
            const checkDesignMode = () => {
              if (!window.Shopify || !window.Shopify.designMode) {
                clearInterval(editorAutoOpenInterval);
                editorAutoOpenInterval = null;
              }
            };
            setTimeout(checkDesignMode, 10000);
          } else if (!keepCartOpenSetting && editorAutoOpenInterval) {
            // Setting was turned off, clear the interval
            clearInterval(editorAutoOpenInterval);
            editorAutoOpenInterval = null;
          }
        }

        // Preserve native cart UI; intercept clicks to open our drawer instead
        if (typeof window.cartUpliftDrawer?.preventThemeCartUplift === 'function' && !__isDesignMode) {
          window.cartUpliftDrawer.preventThemeCartUplift();
        }
      };

      // Try multiple times to ensure drawer is ready
      if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', waitForDrawer);
      } else {
        // DOM already loaded, wait a bit for drawer to initialize
        setTimeout(waitForDrawer, 100);
        setTimeout(waitForDrawer, 500);
        setTimeout(waitForDrawer, 1000);
      }
    })();

        // Optional analytics hooks
        if (window.CartUpliftSettings && window.CartUpliftSettings.enableAnalytics) {
          document.addEventListener('cartuplift:opened', function() {
            if (typeof gtag !== 'undefined') {
              gtag('event', 'view_cart', { event_category: 'Cart Uplift', event_label: 'Cart Drawer Opened' });
            }
          });
          document.addEventListener('cartuplift:item_added', function(e) {
            if (typeof gtag !== 'undefined') {
              gtag('event', 'add_to_cart', { event_category: 'Cart Uplift', event_label: 'Item Added', value: e.detail?.price });
            }
          });
        }
      } catch (error) {
        console.error('Cart Uplift App Embed failed to initialize:', error);
      }
    });

    // Comprehensive cart link interception - final fallback
    document.addEventListener('click', function(e) {
      // Check if the clicked element or any parent is a cart link
      let element = e.target;
      while (element && element !== document) {
        const href = element.getAttribute('href');
        if (href && (href === '/cart' || href.includes('/cart?') || href.includes('/cart#'))) {
          e.preventDefault();
          e.stopPropagation();
          e.stopImmediatePropagation();
          
          if (window.cartUpliftDrawer) {
            window.cartUpliftDrawer.openDrawer();
          }
          return false;
        }
        element = element.parentElement;
      }
    }, true);
    } // End billing check for post-load configuration
  </script>

  {%- comment -%}
    Hidden probe to let Shopify render official dynamic checkout buttons (PayPal, Shop Pay).
    We'll relocate these into the cart drawer when it opens so clicks use Shopify's checkout flow.
  {%- endcomment -%}
  <div id="cartuplift-payment-probe" style="position:absolute;left:-9999px;top:-9999px;opacity:0;pointer-events:none;">
    <div class="additional-checkout-buttons" data-shopify="payment-button"></div>
  </div>

{% schema %}
{
  "name": "Cart Uplift - Smart Cart",
  "target": "body",
  "settings": [
    {
      "type": "header",
      "content": "Theme editor"
    },
    {
      "type": "checkbox",
      "id": "keep_cart_open",
      "label": "Keep cart open while editing",
      "info": "Keeps the drawer visible in the theme editor.",
      "default": false
    },
    {
      "type": "checkbox",
      "id": "auto_open_cart",
      "label": "Open cart after add to cart",
      "info": "Automatically show the cart when an item is added.",
      "default": false
    },
    {
      "type": "checkbox",
      "id": "enable_product_title_caps",
      "label": "Uppercase cart titles",
      "info": "Makes product titles and the CART header uppercase.",
      "default": false
    },
    {
      "type": "color",
      "id": "cart_background_color",
      "label": "Cart background color",
      "info": "Background color for the cart drawer.",
      "default": "#FFFFFF"
    },
    {
      "type": "header",
      "content": "Cart goal type"
    },
    {
      "type": "select",
      "id": "incentive_type",
      "label": "Choose goal",
      "options": [
        {
          "value": "combined",
          "label": "Free shipping + gifts"
        },
        {
          "value": "free_shipping",
          "label": "Free shipping goal"
        },
        {
          "value": "gifts",
          "label": "Gift with purchase"
        }
      ],
      "default": "free_shipping",
      "info": "üí° TIP: Start with 'Free shipping goal' only. Add gifts later after testing."
    },
    {
      "type": "header",
      "content": "Free shipping goal"
    },
    {
      "type": "checkbox",
      "id": "enable_free_shipping_progress",
      "label": "Show progress bar",
      "default": false,
      "info": "‚ö†Ô∏è First create a free shipping discount in Shopify Admin > Discounts, then enable this"
    },
    {
      "type": "number",
      "id": "free_shipping_threshold",
      "label": "Free shipping minimum",
      "default": 0,
      "info": "Must match your Shopify free shipping discount threshold"
    },
    {
      "type": "text",
      "id": "progress_message",
      "label": "Progress message",
      "default": "{amount} to free shipping"
    },
    {
      "type": "text",
      "id": "success_message",
      "label": "Success message",
      "default": "‚úì Free shipping unlocked"
    },
    {
      "type": "color",
      "id": "progress_bar_color",
      "label": "Progress bar color",
      "default": "#121212"
    },
    {
      "type": "color",
      "id": "progress_background_color",
      "label": "Progress bar background",
      "default": "#E5E5E5"
    },
    {
      "type": "header",
      "content": "Gift with purchase"
    },
    {
      "type": "color",
      "id": "gift_bar_color",
      "label": "Gift progress bar color",
      "default": "#f59e0b",
      "info": "Color for gift progress bars and milestones"
    },
    {
      "type": "number",
      "id": "gift_threshold",
      "label": "Gift unlock amount ($)",
      "default": 0,
      "info": "Cart subtotal required to unlock gift (e.g. 150 for $150)"
    },
    {
      "type": "product",
      "id": "gift_product",
      "label": "Gift product",
      "info": "‚ö†Ô∏è CRITICAL: Set this product's price to $0.00 in Shopify Products before enabling auto-add"
    },
    {
      "type": "text",
      "id": "gift_progress_message", 
      "label": "Progress message",
      "default": "{amount} to unlock {product}",
      "info": "Use {amount} and {product} placeholders"
    },
    {
      "type": "text",
      "id": "gift_success_message",
      "label": "Success message",
      "default": "üéâ {product} unlocked!",
      "info": "Use {product} placeholder"
    },
    {
      "type": "text",
      "id": "gift_value_message",
      "label": "Value message",
      "default": "You're saving {value}!"
    },
    {
      "type": "text",
      "id": "all_rewards_success_message",
      "label": "All rewards message",
      "default": "‚úì You've saved {value}!"
    },
    {
      "type": "header",
      "content": "Product recommendations"
    },
    {
      "type": "text",
      "id": "recommendations_title",
      "label": "Heading", 
      "default": "CUSTOMERS ALSO BOUGHT"
    },
    {
      "type": "select",
      "id": "recommendations_layout",
      "label": "Layout style",
      "options": [
        {
          "value": "carousel",
          "label": "Carousel"
        },
        {
          "value": "list",
          "label": "List"
        },
        {
          "value": "grid",
          "label": "Grid"
        }
      ],
      "default": "carousel"
    },
    {
      "type": "range",
      "id": "recommendations_max_count",
      "label": "Products to load",
      "min": 1,
      "max": 6,
      "step": 1,
      "default": 3,
      "info": "Tip: 3 works best. Carousel/List show up to this number; Grid shows 3 on desktop, 2 on mobile, rotating extras."
    },
    {
      "type": "product_list",
      "id": "manual_recommendation_products",
      "label": "Manual product recommendations",
      "info": "Selected products only (AI recs off). Ideal for excess stock",
      "limit": 12
    },
    {
      "type": "color",
      "id": "recommendations_background_color",
      "label": "Background color",
      "default": "#F3F3F3" 
    },
    {
      "type": "checkbox",
      "id": "recommendations_scroll_with_cart",
      "label": "Let recommendations scroll with cart",
      "info": "When off, recommendations stay pinned above the cart items.",
      "default": false
    },
    {
      "type": "checkbox",
      "id": "uppercase_recommendation_title",
      "label": "Uppercase recommendation title",
      "info": "Display recommendation section title in uppercase",
      "default": false
    }
  ]
}
{% endschema %}
